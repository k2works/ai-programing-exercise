# イテレーション計画4（本番運用基盤の確立）

最終更新: 2025-09-03  
**進捗状況**: 0% 開始準備 (0/18pt) - 本番運用に必要な基盤構築

参照:
- 要件: ../requirements/仕様.md
- リリース計画: ../requirements/リリース計画.md
- イテレーション3ふりかえり: ./ふりかえり_イテレーション3.md
- 開発ガイド: ../reference/開発ガイド.md

---

## 1. 目的（SMART）
- **目的**: PostgreSQL永続化、HTTPS通信、自動バックアップ、監視機能により、本格的な本番運用可能な会議室予約システムを確立する
- **計測**: PostgreSQL移行100%成功、HTTPS通信確立、日次バックアップ100%実行、監視メトリクス可視化達成
- **期間**: 2025-09-04 〜 2025-09-12（6営業日）

## 2. スコープ
### In（実装対象）
- **D003-02 データベース永続化**: PostgreSQL環境構築と移行
- **N003-01 HTTPS対応**: SSL証明書とセキュリティヘッダー実装
- **D003-02 自動バックアップ**: 日次バックアップとリストア機能
- **N004-02 監視・ヘルスチェック**: Actuator拡張とメトリクス可視化
- **負荷テスト統合修正**: Spring Boot統合テストの完全対応
- **ユーザー自己登録機能**: 運用負荷軽減のための基本実装

### Out（次イテレーション以降）
- マイクロサービス化
- API Gateway導入
- 15分単位予約対応
- 予約通知機能（メール）
- 高度な監視ツール（Prometheus/Grafana）

## 3. ユーザーストーリー（要求トレーサビリティ）
- **US-12**: システム管理者として、データが永続化され再起動後も保持されたい（D003-02）
- **US-13**: システム利用者として、安全なHTTPS通信でアクセスしたい（N003-01）
- **US-14**: システム管理者として、データが自動的にバックアップされ障害時に復旧できたい（D003-02）
- **US-15**: システム管理者として、システムの稼働状況をリアルタイムで監視したい（N004-02）
- **US-16**: 新規ユーザーとして、管理者に依頼せず自分でアカウント登録したい（運用改善）
- **US-17**: システム管理者として、負荷テストが自動実行され性能劣化を早期発見したい（品質向上）

## 4. 受け入れ条件（Iteration 4）

### データベース永続化（PostgreSQL）
- Docker環境でPostgreSQL 16稼働
- H2からのマイグレーションスクリプト完成
- 全既存データが正常に移行される
- 接続プール設定とパフォーマンス最適化
- データ型制約とインデックス最適化

### HTTPS対応・セキュリティ強化
- 自己署名証明書によるHTTPS通信確立
- HTTP→HTTPSリダイレクト実装
- セキュリティヘッダー（HSTS、CSP等）追加
- JWTトークンのHTTPSOnly属性設定
- セキュリティテスト実行

### 自動バックアップ・復旧
- 日次自動バックアップスクリプト実装
- 5世代バックアップファイル管理
- リストア手順の自動化と検証
- バックアップ失敗時のアラート機能
- 復旧テスト（月次実施）の自動化

### 監視・ヘルスチェック拡張
- Spring Boot Actuator詳細メトリクス公開
- JVMメトリクス、データベース接続監視
- カスタムヘルスインジケーター実装
- 基本的なアラート機能（閾値超過時）
- 監視ダッシュボード（シンプルHTML）

### ユーザー自己登録機能
- 新規ユーザー登録API実装
- 基本情報（ユーザーID、氏名、パスワード）入力
- メール形式バリデーション実装
- 管理者承認フロー（手動承認）
- 登録完了通知機能

### 品質・テスト改善
- 負荷テストのSpring統合問題修正
- PostgreSQL環境でのE2Eテスト実行
- 品質ゲート（静的解析）の継続
- API仕様書の自動更新
- セキュリティテスト追加

## 5. 完了の定義（DoD）
- PostgreSQL環境でビルド・テストが全てPASS
- HTTPS通信での全機能正常動作確認
- バックアップ・リストアの動作検証完了
- 負荷テスト（100同時ユーザー）がPostgreSQL環境で成功
- セキュリティテスト（HTTPS、CSRFなど）実行
- ドキュメント更新（運用手順、API仕様、インフラ構築手順）
- ペアレビュー完了、新機能のE2Eテスト実装

---

## 6. タスク一覧（見積もり）

### 🗃️ データベース・インフラ基盤（7pt）
- **I4-T01 PostgreSQL環境構築**（Docker Compose、設定最適化）［2pt］
- **I4-T02 マイグレーション実装**（H2→PostgreSQL、データ移行）［3pt］ 
- **I4-T03 バックアップ自動化**（日次バックアップ、世代管理、リストア）［2pt］

### 🔒 セキュリティ・HTTPS（4pt）
- **I4-T04 HTTPS対応**（SSL証明書、セキュリティヘッダー）［2pt］
- **I4-T05 セキュリティ強化**（JWT設定、CSRFトークン、権限テスト）［2pt］

### 👤 ユーザー管理機能（4pt）
- **I4-T06 自己登録API実装**（新規ユーザー登録、バリデーション）［2pt］
- **I4-T07 管理者承認フロー**（承認待ち管理、メール通知）［2pt］

### 📊 監視・運用機能（3pt）
- **I4-T08 監視機能拡張**（Actuatorメトリクス、ヘルスチェック）［2pt］
- **I4-T09 基本アラート機能**（閾値監視、通知機能）［1pt］

**合計: 18pt** | **完了: 0pt (0%)** | **残り: 18pt**

---

## 7. 実装計画詳細

### Phase 1: インフラ基盤構築（I4-T01〜T03）

#### I4-T01: PostgreSQL環境構築
```yaml
# docker-compose.yml
version: '3.8'
services:
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: mrs
      POSTGRES_USER: mrs_user
      POSTGRES_PASSWORD: mrs_password
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
```

**設定項目**:
- 接続プール（HikariCP）最適化
- インデックス設計とクエリ最適化
- トランザクション分離レベル設定

#### I4-T02: マイグレーション実装
**データ移行対象**:
- usr（ユーザー情報）
- meeting_room（会議室）
- reservable_room（予約可能会議室）
- reservation（予約情報）

**マイグレーション戦略**:
1. スキーマ定義（DDL）
2. 初期データ投入（DML）
3. 外部キー制約設定
4. インデックス作成

#### I4-T03: バックアップ自動化
```bash
#!/bin/bash
# daily_backup.sh
BACKUP_DIR="/backup/mrs"
DATE=$(date +%Y%m%d)
pg_dump -h localhost -U mrs_user -d mrs > "$BACKUP_DIR/mrs_$DATE.sql"
# 5世代管理（古いファイル削除）
find $BACKUP_DIR -name "mrs_*.sql" -mtime +5 -delete
```

### Phase 2: セキュリティ強化（I4-T04〜T05）

#### I4-T04: HTTPS対応
**実装内容**:
```properties
# application.yml
server:
  port: 8443
  ssl:
    key-store: classpath:keystore.p12
    key-store-password: mrs_ssl
    key-store-type: PKCS12
    key-alias: mrs
  # HTTPリダイレクト設定
```

**セキュリティヘッダー**:
- HSTS（HTTP Strict Transport Security）
- CSP（Content Security Policy）
- X-Frame-Options
- X-Content-Type-Options

#### I4-T05: セキュリティ強化
**JWT設定強化**:
```java
@Configuration
public class JwtSecurityConfig {
    @Bean
    public JwtDecoder jwtDecoder() {
        // HTTPS環境でのJWT設定
        // HttpOnly, Secure属性設定
    }
}
```

### Phase 3: ユーザー管理（I4-T06〜T07）

#### I4-T06: 自己登録API実装
```java
@PostMapping("/api/users/register")
public ResponseEntity<?> registerUser(@Valid @RequestBody UserRegistrationRequest request) {
    // 基本バリデーション、重複チェック
    // 承認待ち状態でユーザー作成
}
```

**バリデーション**:
- ユーザーID重複チェック
- メールアドレス形式チェック
- パスワード強度チェック
- 必須項目チェック

#### I4-T07: 管理者承認フロー
**承認管理API**:
```java
@GetMapping("/api/admin/pending-users")
@PostMapping("/api/admin/approve-user/{userId}")
@PostMapping("/api/admin/reject-user/{userId}")
```

### Phase 4: 監視・運用（I4-T08〜T09）

#### I4-T08: 監視機能拡張
```java
@Component
public class CustomHealthIndicator implements HealthIndicator {
    @Override
    public Health health() {
        // データベース接続チェック
        // JVMメモリ使用量チェック
        // 予約システム特有のヘルスチェック
    }
}
```

**メトリクス項目**:
- データベース接続プール状況
- API応答時間
- 予約数・キャンセル数
- エラー発生率

#### I4-T09: 基本アラート機能
**アラート条件**:
- データベース接続失敗
- JVMメモリ使用率90%超過
- API応答時間5秒超過
- バックアップ失敗

## 8. リスク対策

### 高リスク 🔴
#### 1. PostgreSQL移行での データ不整合
**対策**:
- 段階的移行（テストデータ→本番データ）
- 移行前後のデータ整合性チェックスクリプト
- ロールバック手順の事前準備

#### 2. HTTPS証明書設定での起動失敗
**対策**:
- 開発環境での十分な検証
- 自己署名証明書での動作確認
- HTTP/HTTPS並行稼働による段階移行

### 中リスク 🟡
#### 1. 負荷テスト統合でのSpring設定問題
**対策**:
- @TestConfiguration分離
- モック設定とBean定義の明確化
- 段階的な統合テスト実装

#### 2. バックアップ容量・世代管理
**対策**:
- ディスク容量監視
- ログローテーション設定
- 圧縮による容量最適化

### 低リスク 🟢
#### 1. 監視メトリクス性能影響
**対策**:
- 監視頻度の調整
- 軽量なメトリクス選択
- パフォーマンステスト実行

## 9. 依存関係・前提条件
- イテレーション3完了（キャンセル・排他制御機能）
- Docker環境の利用可能性
- SSL証明書作成環境
- PostgreSQL 16対応確認
- 十分なディスク容量確保

## 10. 成功メトリクス・KPI

### 技術要件達成
| 項目 | 目標 | 測定方法 |
|------|------|----------|
| PostgreSQL移行 | 100%成功 | データ整合性チェック |
| HTTPS通信 | 全機能対応 | セキュリティテスト |
| バックアップ成功率 | 100% | 日次バックアップログ |
| 監視メトリクス | 稼働状況可視化 | ダッシュボード確認 |

### 性能・品質
| 項目 | 目標 | 測定方法 |
|------|------|----------|
| PostgreSQL性能 | H2と同等以上 | 負荷テスト実行 |
| HTTPS応答時間 | HTTPと同等 | 応答時間測定 |
| バックアップ時間 | 5分以内 | バックアップログ |
| 監視オーバーヘッド | 5%以内 | パフォーマンス測定 |

### 運用・保守性
| 項目 | 目標 | 測定方法 |
|------|------|----------|
| 自己登録成功率 | 95%以上 | 登録ログ分析 |
| アラート精度 | 誤検知10%以下 | アラートログ分析 |
| 復旧テスト成功 | 100% | 月次復旧テスト |
| ドキュメント完成度 | 運用可能レベル | レビュー完了 |

## 11. 品質保証・テスト戦略

### データベースマイグレーションテスト
- **移行前後データ比較**: 件数・内容の完全一致
- **外部キー制約テスト**: 関連データの整合性確認
- **パフォーマンステスト**: PostgreSQLでの負荷テスト実行

### セキュリティテスト
- **HTTPS通信テスト**: 全APIエンドポイントでのHTTPS確認
- **証明書検証**: SSL証明書の有効性確認
- **セキュリティヘッダーテスト**: 必要なヘッダーの設定確認

### E2Eテスト拡張
- **PostgreSQL環境**: 全BDDテストの実行
- **HTTPS環境**: Cucumberテストの実行
- **バックアップ・復旧テスト**: データ復旧の動作確認

### 統合テスト強化
- **自己登録フローテスト**: 登録→承認→ログイン の完全フロー
- **監視・アラートテスト**: 異常状態の検知確認
- **負荷テスト統合**: Spring Boot統合環境での実行

## 12. ドキュメント更新計画

### 新規作成ドキュメント
1. **PostgreSQL構築・運用手順書**
   - Docker環境構築手順
   - マイグレーション手順
   - バックアップ・復旧手順

2. **HTTPS設定・セキュリティガイド**
   - SSL証明書設定手順
   - セキュリティヘッダー設定
   - セキュリティテスト手順

3. **監視・アラート運用マニュアル**
   - メトリクス監視項目
   - アラート対応手順
   - トラブルシューティング

4. **ユーザー管理運用ガイド**
   - 自己登録機能説明
   - 管理者承認手順
   - ユーザー管理操作

### 更新対象ドキュメント
- **API仕様書**: 新規エンドポイント追加
- **運用手順書**: PostgreSQL環境対応
- **既知の制約事項**: 新機能制約追加
- **ユーザーガイド**: 自己登録機能説明

## 13. 段階的リリース計画

### Week 1（9/4-9/6）: インフラ基盤
1. PostgreSQL環境構築（I4-T01）
2. マイグレーション実装・テスト（I4-T02）
3. バックアップ自動化（I4-T03）

### Week 2（9/9-9/11）: セキュリティ・機能
1. HTTPS対応（I4-T04）
2. セキュリティ強化（I4-T05）
3. 自己登録機能実装（I4-T06、I4-T07）

### Week 3（9/12）: 監視・総合テスト
1. 監視機能実装（I4-T08、I4-T09）
2. 総合テスト・品質確認
3. ドキュメント整備・レビュー

## 14. 次イテレーション（イテレーション5）への準備

### 候補機能（優先度順）
1. **15分単位予約対応** - ユーザー利便性向上
2. **予約通知機能（メール）** - UX向上
3. **高度な監視（Prometheus/Grafana）** - 運用品質向上
4. **API Gateway導入** - マイクロサービス準備
5. **マルチテナント対応** - スケーラビリティ向上

### 技術的課題への対応
- **マイクロサービス化検討**: ドメイン境界の明確化
- **パフォーマンス最適化**: クエリ最適化、キャッシュ戦略
- **運用自動化強化**: CI/CD パイプライン完全自動化

---

## 15. アクションアイテム

### 即座開始（優先度：高）
- [ ] PostgreSQL Docker環境準備
- [ ] H2→PostgreSQL マイグレーション設計
- [ ] SSL証明書作成・設定調査

### イテレーション開始時
- [ ] 開発環境PostgreSQL構築
- [ ] マイグレーションスクリプト実装開始
- [ ] HTTPS設定検証環境準備

### 並行実施
- [ ] 自己登録UI設計・検討
- [ ] 監視要件詳細化
- [ ] バックアップ要件・運用手順整理

## 16. 総合方針

### イテレーション4のテーマ: **「Production Ready」**

**目指すゴール**:
イテレーション4完了時点で、MRS（Meeting Room System）が本格的な本番環境で安定稼働できる基盤を確立する。データの永続化、セキュアな通信、自動バックアップ、監視機能により、エンタープライズレベルの信頼性を実現する。

**重点方針**:
1. **信頼性第一**: データ損失ゼロ、セキュリティ確保
2. **運用効率化**: 自動化による手動作業削減
3. **監視可視化**: 問題の早期発見・対応
4. **段階的移行**: リスク最小化した段階実装
5. **ドキュメント充実**: 運用担当者が実際に使える品質

**成功の定義**:
運用担当者が安心してシステムを本番稼働できる状態を実現し、エンドユーザーが快適に会議室予約システムを利用できる環境を提供する。

---

**作成者**: 開発チーム  
**承認予定**: プロジェクトマネージャー  
**開始予定日**: 2025-09-04