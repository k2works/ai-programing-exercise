# イテレーション3 - 予約キャンセル機能とアクセス制御強化

**期間**: 8営業日（2025-09-05 ～ 2025-09-16）  
**目標**: 予約キャンセル機能の実装と完全なアクセス制御  
**開始日**: 2025-09-05  
**参照**: [リリース計画](../requirements/リリース計画.md) | [イテレーション2](イテレーション計画2.md) | [仕様書](../requirements/仕様.md)

---

## 1. イテレーション目標

### 1.1 主要目標
- **予約キャンセル機能**の実装（本人・管理者権限制御）
- **悲観的ロック**実装（高負荷時の排他制御強化）
- **管理者権限管理**の完全実装
- **キャンセル履歴管理**とトレーサビリティ確保

### 1.2 成功基準
- 本人予約キャンセルが確実に実行される（権限チェック含む）
- 管理者は他者予約をキャンセル可能（権限検証）
- 並行キャンセル操作で競合状態が発生しない
- キャンセル操作レスポンス時間3秒以内（N001準拠）
- キャンセル履歴の完全性保証（監査証跡）

## 2. スコープ詳細

### 2.1 含まれる機能要件
- **F004-01**: 本人による予約キャンセル
- **F004-02**: 管理者による他者予約キャンセル
- **F004-03**: キャンセル理由入力機能
- **F005-01**: 悲観的ロック実装（キャンセル時競合防止）
- **F005-03**: キャンセル履歴管理とトレーサビリティ

### 2.2 含まれる非機能要件
- **N001-03**: キャンセル処理レスポンス3秒以内
- **N002-01**: キャンセル失敗時の自動ロールバック
- **N003-02**: 管理者権限の多層認証
- **N003-03**: キャンセル操作の監査ログ

### 2.3 除外項目（次イテレーション以降）
- **📋 通知機能** → イテレーション4で実装
- **📋 自動リマインダー** → イテレーション4で実装
- **📋 キャンセル統計レポート** → イテレーション4で実装
- **📋 API制限・レート制限** → イテレーション4で実装

## 3. アーキテクチャ拡張計画

### 3.1 ドメイン層拡張
- **CancellationRequest** バリューオブジェクト（理由、タイムスタンプ）
- **ReservationStatus** 列挙型拡張（Confirmed, Cancelled, CancelledByAdmin）
- **AdminPermission** ドメインサービス（管理者権限検証）
- **CancellationDomainService**（キャンセルビジネスルール）

### 3.2 アプリケーション層拡張
- **ICancellationService**（キャンセルユースケース）
- **CancellationService**（本人・管理者キャンセルロジック）
- **IPermissionService**（権限管理サービス）

### 3.3 インフラストラクチャ層拡張
- **悲観的ロック実装**（SELECT FOR UPDATE）
- **CancellationRepository**（キャンセル履歴管理）
- **キャンセル監査テーブル**（AuditLogs）
- **データベーススキーマ拡張**

### 3.4 API層拡張
- **CancellationController**（`/api/reservations/{id}/cancel` エンドポイント）
- **管理者権限検証ミドルウェア**（AdminRequired属性）
- **キャンセル理由バリデーション**

### 3.5 フロントエンド拡張
- **キャンセル確認ダイアログ**
- **キャンセル理由入力フォーム**
- **管理者専用キャンセル画面**
- **キャンセル履歴表示コンポーネント**

## 4. API設計

### 4.1 キャンセルAPI
```
DELETE /api/reservations/{id}                    # 本人キャンセル
DELETE /api/reservations/{id}/admin              # 管理者キャンセル
GET    /api/reservations/{id}/cancellation-logs  # キャンセル履歴取得
POST   /api/reservations/{id}/restore            # キャンセル取消（管理者のみ）
```

### 4.2 リクエスト・レスポンス形式
```json
# 本人キャンセルリクエスト
DELETE /api/reservations/res-001
{
  "reason": "会議延期のため",
  "notifyParticipants": true
}

# 管理者キャンセルリクエスト
DELETE /api/reservations/res-001/admin
{
  "reason": "緊急事態により会議室確保のため",
  "adminComment": "システムメンテナンス対応",
  "notifyParticipants": true,
  "notifyOriginalReserver": true
}

# キャンセル成功レスポンス
{
  "success": true,
  "data": {
    "reservationId": "res-001",
    "status": "cancelled",
    "cancelledAt": "2025-09-05T10:30:00Z",
    "cancelledBy": "user01",
    "reason": "会議延期のため",
    "refundAmount": 0
  }
}
```

### 4.3 エラーレスポンス
```json
# 権限エラー
{
  "success": false,
  "error": {
    "code": "INSUFFICIENT_PRIVILEGES",
    "message": "この予約をキャンセルする権限がありません",
    "details": {
      "requiredRole": "Admin",
      "userRole": "User",
      "reservationOwner": "user02"
    }
  }
}

# 悲観的ロックエラー
{
  "success": false,
  "error": {
    "code": "RESERVATION_LOCKED",
    "message": "この予約は他のユーザーが操作中です。しばらく後に再試行してください",
    "retryAfter": 30
  }
}
```

## 5. データベース設計

### 5.1 テーブル拡張
```sql
-- 予約テーブルの拡張
ALTER TABLE Reservations ADD COLUMN CancelledAt TEXT NULL;
ALTER TABLE Reservations ADD COLUMN CancelledBy TEXT NULL;
ALTER TABLE Reservations ADD COLUMN CancellationReason TEXT NULL;

-- キャンセル監査テーブル
CREATE TABLE CancellationAuditLogs (
    AuditId TEXT PRIMARY KEY,
    ReservationId TEXT NOT NULL,
    Action TEXT NOT NULL, -- 'cancelled', 'restored'
    PerformedBy TEXT NOT NULL,
    PerformedAt TEXT NOT NULL,
    Reason TEXT,
    AdminComment TEXT NULL,
    UserRole TEXT NOT NULL, -- 'User', 'Admin'
    IpAddress TEXT NULL,
    UserAgent TEXT NULL,
    FOREIGN KEY (ReservationId) REFERENCES Reservations(ReservationId),
    FOREIGN KEY (PerformedBy) REFERENCES Users(UserId)
);

-- 悲観的ロック用テーブル
CREATE TABLE ReservationLocks (
    ReservationId TEXT PRIMARY KEY,
    LockedBy TEXT NOT NULL,
    LockedAt TEXT NOT NULL,
    LockExpiry TEXT NOT NULL,
    Operation TEXT NOT NULL, -- 'cancel', 'update'
    FOREIGN KEY (ReservationId) REFERENCES Reservations(ReservationId),
    FOREIGN KEY (LockedBy) REFERENCES Users(UserId)
);

-- インデックス作成
CREATE INDEX idx_cancellation_audit_reservation ON CancellationAuditLogs(ReservationId);
CREATE INDEX idx_cancellation_audit_performed_by ON CancellationAuditLogs(PerformedBy);
CREATE INDEX idx_cancellation_audit_performed_at ON CancellationAuditLogs(PerformedAt);
CREATE INDEX idx_reservation_locks_expiry ON ReservationLocks(LockExpiry);
```

### 5.2 権限管理テーブル
```sql
-- ユーザー権限拡張
ALTER TABLE Users ADD COLUMN Role TEXT DEFAULT 'User';
ALTER TABLE Users ADD COLUMN IsAdmin INTEGER DEFAULT 0;
ALTER TABLE Users ADD COLUMN AdminApprovedBy TEXT NULL;
ALTER TABLE Users ADD COLUMN AdminApprovedAt TEXT NULL;

-- 権限マトリクステーブル
CREATE TABLE UserPermissions (
    UserId TEXT NOT NULL,
    Permission TEXT NOT NULL,
    GrantedBy TEXT NOT NULL,
    GrantedAt TEXT NOT NULL,
    ExpiresAt TEXT NULL,
    IsActive INTEGER DEFAULT 1,
    PRIMARY KEY (UserId, Permission),
    FOREIGN KEY (UserId) REFERENCES Users(UserId),
    FOREIGN KEY (GrantedBy) REFERENCES Users(UserId)
);

-- 基本権限データ挿入
INSERT INTO UserPermissions (UserId, Permission, GrantedBy, GrantedAt) VALUES 
('admin', 'CancelOthersReservations', 'system', datetime('now')),
('admin', 'ViewAllReservations', 'system', datetime('now')),
('admin', 'RestoreCancelledReservations', 'system', datetime('now'));
```

## 6. テスト戦略

### 6.1 単体テスト拡張
- **CancellationRequest** バリューオブジェクト（バリデーション）
- **CancellationService**（本人・管理者キャンセルロジック）
- **AdminPermission** ドメインサービス（権限検証）
- **悲観的ロック**（ロック取得・解放・タイムアウト）

### 6.2 統合テスト
- **キャンセル処理フロー**（Controller → Service → Repository）
- **権限制御テスト**（本人・管理者・権限なし）
- **悲観的ロック競合**（並行キャンセル操作）
- **監査ログ**（キャンセル操作の完全記録）

### 6.3 E2Eテスト
- **本人キャンセルフロー**: ログイン → 予約選択 → 理由入力 → キャンセル確認
- **管理者キャンセルフロー**: 管理者ログイン → 他者予約選択 → キャンセル実行
- **権限チェック**: 権限なしユーザーのキャンセル拒否確認
- **競合状態**: 並行キャンセル操作での整合性確認

## 7. タスク詳細とスケジュール（8営業日）

### Day 1: ドメイン層・権限管理基盤
- [ ] CancellationRequest バリューオブジェクト実装（TDD）
- [ ] AdminPermission ドメインサービス実装
- [ ] ReservationStatus 列挙型拡張
- [ ] 権限管理の単体テスト作成（100%カバレッジ）

### Day 2: データベース・悲観的ロック実装
- [ ] データベーススキーマ拡張（監査・ロック）
- [ ] 悲観的ロック実装（SELECT FOR UPDATE）
- [ ] CancellationRepository実装
- [ ] ロック機構の統合テスト

### Day 3: アプリケーション層・サービス実装
- [ ] ICancellationService定義
- [ ] CancellationService実装（本人・管理者ロジック）
- [ ] IPermissionService実装
- [ ] サービス層単体テスト

### Day 4: API層・コントローラー実装
- [ ] CancellationController実装
- [ ] 管理者権限検証ミドルウェア
- [ ] キャンセルエラーハンドリング
- [ ] API層統合テスト

### Day 5: フロントエンド（キャンセル機能）
- [ ] キャンセル確認ダイアログコンポーネント
- [ ] キャンセル理由入力フォーム
- [ ] 予約一覧へのキャンセルボタン統合
- [ ] フロントエンドテスト

### Day 6: フロントエンド（管理者機能）
- [ ] 管理者専用キャンセル画面実装
- [ ] キャンセル履歴表示コンポーネント
- [ ] 権限に応じたUI表示制御
- [ ] 管理者画面レスポンシブ対応

### Day 7: 統合テスト・セキュリティ検証
- [ ] E2Eテスト実装（キャンセルフロー）
- [ ] セキュリティテスト（権限回避攻撃）
- [ ] 性能テスト（悲観的ロック負荷）
- [ ] 監査ログ完全性テスト

### Day 8: 受け入れテスト・ドキュメント
- [ ] ユーザー受け入れテスト実行
- [ ] 管理者権限操作マニュアル作成
- [ ] キャンセル操作ガイド更新
- [ ] イテレーション3完了判定

## 8. 完了の定義（DoD）

### 8.1 機能要件
- [ ] 本人予約キャンセルが正常動作（理由入力含む）
- [ ] 管理者による他者予約キャンセルが正常動作
- [ ] 権限のないユーザーのキャンセルが確実に拒否される
- [ ] キャンセル履歴が完全に記録される

### 8.2 品質要件
- [ ] 単体テストカバレッジ95%以上
- [ ] 統合テスト主要シナリオ100%通過
- [ ] E2Eテストキャンセルフロー成功
- [ ] セキュリティテスト（権限チェック）成功

### 8.3 技術要件
- [ ] 悲観的ロック実装による完全排他制御
- [ ] 管理者権限の多層認証実装
- [ ] キャンセル監査ログの完全性保証
- [ ] レスポンス時間3秒以内（N001-03準拠）

### 8.4 運用要件
- [ ] 管理者権限付与プロセス確立
- [ ] キャンセル監査ログ閲覧機能
- [ ] 権限エスカレーション手順確立
- [ ] セキュリティインシデント対応手順

## 9. セキュリティ考慮事項

### 9.1 権限制御
- **多層認証**: JWT + ロールベース + リソース所有者チェック
- **権限昇格防止**: 管理者権限の厳密検証
- **セッション管理**: 管理者セッションのタイムアウト制御

### 9.2 監査・トレーサビリティ
- **完全監査ログ**: 全キャンセル操作の記録
- **改ざん防止**: 監査ログのハッシュ値保存
- **プライバシー保護**: 個人情報のマスキング

### 9.3 攻撃対策
- **権限回避攻撃**: パラメータ改ざんによる権限回避防止
- **CSRF攻撃**: キャンセル操作のCSRFトークン検証
- **DoS攻撃**: 悲観的ロックによるリソース枯渇防止

## 10. リスクと対策

### 10.1 技術リスク
- **悲観的ロック実装の複雑さ** → 段階的実装とデッドロック検出
- **権限管理の複雑化** → シンプルなロールベース認証から開始

### 10.2 セキュリティリスク
- **権限昇格脆弱性** → 多層防御と定期的なペネトレーションテスト
- **監査ログ改ざん** → 不変ログストレージと署名検証

### 10.3 運用リスク
- **管理者権限の悪用** → 承認プロセスと定期的権限監査
- **システム負荷増大** → ロックタイムアウトと負荷分散

## 11. 次イテレーションへの引き継ぎ

### 11.1 完成予定アーティファクト
- 完全なキャンセル管理システム
- 悲観的ロック実装
- 管理者権限管理
- キャンセル監査システム

### 11.2 イテレーション4への準備
- 通知機能設計
- レポート機能設計
- 運用監視強化
- パフォーマンスチューニング

---

**作成日**: 2025-09-04  
**開始予定日**: 2025-09-05  
**承認者**: Product Owner  
**実装責任者**: 開発チーム  
**前提条件**: イテレーション2完了（予約機能・MVP達成） → ✅ 満足  
**成功基準**: キャンセル機能完成・セキュリティ要件達成