# イテレーション計画3（キャンセルと排他制御の完成）

最終更新: 2025-09-02

参照:
- 要件: ../requirements/仕様.md
- リリース計画: ../requirements/リリース計画.md
- イテレーション2ふりかえり: ./イテレーション2ふりかえり.md
- 開発ガイド: ../reference/開発ガイド.md

---

## 1. 目的（SMART）
- 目的: 本人による予約キャンセル、管理者による他者予約キャンセル、悲観ロック実装により、安全で完全な予約管理機能を提供する。
- 計測: キャンセル機能E2E成功率100%、並行予約テスト（100同時ユーザー相当）での整合性100%、権限外キャンセル拒否率100%
- 期間（想定）: 2025-09-03 〜 2025-09-10（5営業日）

## 2. スコープ
- In（実装対象）
  - F004-01 本人による予約キャンセル
  - F004-02 管理者による他者予約キャンセル
  - F005-01 悲観ロック実装（並行予約制御）
  - F005-02 重複検出の完成
  - UI002-03 キャンセル機能付きUI更新
  - N001-02 負荷テスト対応
- Out（次イテレーション以降）
  - 高度な運用機能（N004の詳細運用）
  - バックアップ/復旧高度化

## 3. ユーザーストーリー（要求トレーサビリティ）
- US-8: 一般ユーザーとして、自分の予約をキャンセルしたい（UC06, F004-01）
- US-9: 管理者として、任意の予約をキャンセルしたい（UC07, F004-02）
- US-10: システム利用者として、同時予約時にデータ競合が発生しないよう安全に処理されたい（F005-01, N001-02）
- US-11: システム利用者として、重複予約が確実に防止されたい（F005-02）

## 4. 受け入れ条件（Iteration 3）
- **キャンセル機能**
  - 本人キャンセル: 自分の予約のみキャンセル可能（403で他者予約は拒否）
  - 管理者キャンセル: 任意の予約をキャンセル可能（@PreAuthorize権限チェック）
  - キャンセル後の状態: 予約データ削除、会議室予約可能状態復元
- **排他制御**
  - 悲観ロック: 予約作成時にreservable_roomに対するFOR UPDATE実装
  - 競合試験: 並行予約（100同時ユーザー相当）で一貫したデータ整合性
  - 重複検出: target.endTime > this.startTime && this.endTime > target.startTime の確実な実行
- **UI/UX**
  - キャンセルボタン付き予約一覧画面
  - 権限に応じたボタン表示制御（本人/管理者）
  - キャンセル確認ダイアログ
- **性能/負荷**
  - 負荷テスト（100同時ユーザー相当）を安定クリア（N001-02）
  - キャンセル処理1秒以内（N001-01準拠）

## 5. 完了の定義（DoD）
- ビルド/テスト/静的解析/フォーマットがCIでPASS
- 単体/統合/E2E/負荷テストが全て緑
- 権限外アクセステスト（403エラー）の確認
- ペアレビュー完了、ドキュメント更新
- 仕様トレーサビリティ（F004/F005/UI002/N001）の紐付け反映

---

## 6. タスク一覧（見積もり）
- **I3-T01 本人キャンセルAPI**（DELETE /api/reservations/{id}）［2pt］
- **I3-T02 管理者キャンセル機能**（@PreAuthorize権限チェック）［2pt］
- **I3-T03 悲観ロック実装**（予約作成時の排他制御）［3pt］
- **I3-T04 重複検出完成**（時間帯重複判定の強化）［2pt］
- **I3-T05 キャンセルUI実装**（ボタン/ダイアログ/権限制御）［2pt］
- **I3-T06 負荷テスト実装**（並行処理テスト）［2pt］
- **I3-T07 テスト/品質ゲート**（単体/統合/E2E/負荷/権限）［2pt］
- **I3-T08 ドキュメント更新**（API仕様/運用手順/既知の制約）［1pt］

**合計: 16pt**

---

## 7. 技術的詳細

### 悲観ロック実装
```sql
-- 予約作成時の排他制御
SELECT * FROM reservable_room 
WHERE room_id = ? AND reservable_date = ? 
FOR UPDATE;
```

### 権限チェック実装
```java
@PreAuthorize("hasRole('ADMIN') or @reservationService.isOwner(#reservationId, authentication.name)")
public void cancelReservation(Long reservationId);
```

### 重複検出ロジック
```java
// 既存予約との時間重複チェック
boolean isOverlap = target.endTime > this.startTime && 
                    this.endTime > target.startTime;
```

## 8. リスク・対策

### 高リスク
- **悲観ロック設定ミス**: データベーストランザクション境界の明確化、統合テストで検証
- **権限チェック漏れ**: @PreAuthorizeアノテーション二重チェック、否定テスト（権限外）をCIに常設
- **並行処理でのデッドロック**: ロック順序の統一、タイムアウト設定

### 中リスク  
- **UI権限表示の不整合**: フロントエンド・バックエンド権限チェックの同期
- **負荷テストの環境依存**: CI環境での負荷テスト実行可能性の事前確認

## 9. 依存関係・前提条件
- イテレーション2完了（予約作成・表示機能の正常動作）
- JWT認証基盤の稼働
- データベース外部キー制約の正常動作
- 品質ゲート環境の安定稼働

## 10. 成功メトリクス
- キャンセル機能正常動作率: 100%（正常系/権限エラー系）
- 並行処理整合性: 100%（同時予約テストでの一意性保証）
- 負荷テスト通過: 100同時ユーザーで5分間安定動作
- 品質ゲート: PMD/Checkstyle/SpotBugs/JaCoCo全PASS
- コードカバレッジ: コアビジネスロジック100%維持

---

## 11. 参考
- [イテレーション2ふりかえり](./イテレーション2ふりかえり.md)
- [リリース計画](../requirements/リリース計画.md)  
- [要件仕様書](../requirements/仕様.md)
- [Spring Securityリファレンス](https://docs.spring.io/spring-security/reference/)
- [MyBatis悲観ロック](https://mybatis.org/mybatis-3/ja/index.html)