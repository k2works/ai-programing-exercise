# アプリケーションアーキテクチャ

このぷよぷよアプリケーションは、いくつかの主要なクラスが連携して動作するコンポーネントベースのアーキテクチャを採用しています。各クラスは明確な責務を持ち、ゲームの進行を管理します。

## 主要コンポーネント

- **`Game`**: ゲーム全体の進行と状態を管理する中心的なクラス。
- **`Stage`**: ゲームの盤面（ぷよの配置）を管理するクラス。
- **`Player`**: プレイヤーの操作（移動、回転）と、操作対象のぷよを管理するクラス。
- **`Score`**: スコアの計算と表示を管理するクラス。
- **`PuyoImage`**: ぷよや特殊効果の画像リソースを管理するクラス。
- **`Config`**: ゲームの様々な設定値（スピード、サイズなど）を保持するクラス。

## コンポーネント間の連携

1.  **初期化**:
    -   `Game`クラスがインスタンス化されると、`initialize`メソッドが呼び出されます。
    -   `initialize`メソッド内で、`Config`, `PuyoImage`, `Stage`, `Player`, `Score`の各クラスがインスタンス化され、ゲームの初期状態が構築されます。

2.  **ゲームループ**:
    -   `Game`クラスの`loop`メソッドが`requestAnimationFrame`によって繰り返し呼び出され、ゲームループを形成します。
    -   `loop`メソッドは、現在の`mode`（ゲームの状態）に応じて、各コンポーネントのメソッドを呼び出します。

3.  **状態遷移**:
    -   ゲームは`GameMode`という状態を持ち、`"playing"`, `"falling"`, `"erasing"`などの状態間を遷移します。
    -   例えば、プレイヤーがぷよを接地させると、`"checkFall"`モードに移行し、`Stage`クラスがぷよの落下を処理します。落下が終わると`"checkErase"`モードに移行し、`Stage`クラスがぷよの消去判定を行います。
    -   このように、`Game`クラスが状態遷移のロジックを管理し、各コンポーネントに処理を委譲することで、ゲームが進行します。

## クラスの責務詳細

- **`Game.ts`**:
    -   ゲームのメインループを管理します。
    -   `GameMode`に基づいて、ゲームの状態を遷移させます。
    -   各コンポーネントを初期化し、協調動作させます。

- **`Stage.ts`**:
    -   ぷよの配置情報を保持する2次元配列 `board` を管理します。
    -   ぷよの落下判定 (`checkFall`)、消去判定 (`checkErase`)、接続判定 (`checkConnections`) など、盤面に関わるコアロジックを担当します。
    -   DOM要素としてステージを描画・更新します。

- **`Player.ts`**:
    -   キーボードやタッチイベントを監視し、プレイヤーの入力を受け付けます。
    -   入力に応じて、操作中のぷよの移動 (`moving`) や回転 (`rotating`) を処理します。
    -   操作中のぷよが接地した際の固定処理 (`fix`) を担当します。

- **`Score.ts`**:
    -   消去されたぷよの数や連鎖数に基づいてスコアを計算します (`calculateScore`)。
    -   計算されたスコアを画面に表示します (`showScore`)。

- **`PuyoImage.ts`**:
    -   ぷよの画像や「ばたんきゅー」などの画像を管理し、必要に応じてクローンを生成します。

- **`Config.ts`**:
    -   ぷよのサイズ、ステージの大きさ、落下速度など、ゲームの動作を規定する定数を一元管理します。

このアーキテクチャにより、各クラスの関心事が分離され、コードの可読性、保守性、拡張性が高まっています。