# 実装詳細

このドキュメントでは、ぷよぷよアプリケーションの主要なクラスとメソッドの具体的な実装について解説します。

## `Game.ts` - ゲーム進行管理

`Game`クラスは、ゲーム全体の流れを制御するステートマシンとして実装されています。

### `initialize()`

ゲームの開始時やリスタート時に呼び出され、すべてのコンポーネント（`Stage`, `Player`, `Score`など）を初期化します。これにより、ゲームがクリーンな状態で開始されることが保証されます。

### `loop()`

ゲームの中核をなすメソッドです。`requestAnimationFrame`によって毎フレーム呼び出されます。
内部の`switch (this.mode)`構文が、現在のゲーム状態に応じた処理を各コンポーネントに委譲します。

**コード例: `loop`メソッドの抜粋**
```typescript
// ...
switch (this.mode) {
  case "checkFall":
    if (this.stage.checkFall()) {
      this.mode = "fall";
    } else {
      this.mode = "checkErase";
    }
    break;
  case "erasing":
    if (!this.stage.erasing(this.frame)) {
      // 消すアニメーションが終わったら、再度落下チェックから始める（連鎖のため）
      this.mode = "checkFall";
    }
    break;
  // ...
}
```
この例のように、各`case`節の最後で次の`mode`を設定することで、状態遷移を実現しています。

## `Player.ts` - プレイヤー操作

`Player`クラスは、ユーザーからの入力を受け取り、ぷよを操作する責務を持ちます。

### `createNewPuyo()`

新しいぷよを生成し、初期位置に配置します。このとき、ぷよを配置するスペース（盤面の上部中央）が埋まっている場合は`false`を返し、これがゲームオーバーのトリガーとなります。

### `playing()`

プレイヤーの入力（キーボード・タッチ）を監視し、移動や回転のロジックを呼び出します。

### `checkRotation()`

ぷよの回転処理は複雑なロジックの一つです。特に、壁や他のぷよに隣接している場合の「壁キック」と呼ばれる挙動を実装しています。

**コード例: `checkRotation`メソッドの抜粋**
```typescript
// 上から左に回すときに,左にブロックがあれば右に移動する必要がある
if (this.stage.board[y + 1][x - 1]) {
    // ブロックがある。右に1個ずれる
    cx = 1;
}
// 右にずれる必要がある時,右にもブロックがあれば回転出来ないので確認する
if (cx === 1) {
    if (this.stage.board[y][x + 1] || this.stage.board[y + 1][x + 1]) {
        // ブロックがある。回転出来なかった
        canRotate = false;
    }
}
```
このように、回転後の位置に障害物がないか事前にチェックし、もしあればぷよを1マスずらすことで回転を可能にする、といった判定を行っています。回転方向（時計回り/反時計回り）と現在の回転角度に応じて、詳細な条件分岐が実装されています。

## `Stage.ts` - 盤面管理

`Stage`クラスは、ぷよの配置や状態など、ゲーム盤に関するすべての情報を管理します。

### `board`

`PuyoCell`オブジェクトの2次元配列で、盤面の状態を保持します。`PuyoCell`には、ぷよの色(`puyo`)と、対応するDOM要素(`element`)が格納されます。

### `checkFall()`

盤面を下から上にスキャンし、下に空間があるぷよ（浮いているぷよ）を検出します。検出されたぷよは`fallingPuyoList`に追加され、落下アニメーションの対象となります。

### `checkErase()`

`checkConnections`を利用して、4つ以上繋がったぷよのグループを探します。見つかったグループは`erasingPuyoInfoList`に追加され、消去アニメーションの対象となります。

## `Score.ts` - スコア管理

`Score`クラスは、スコア計算と表示を担当します。

### `calculateScore()`

ぷよぷよのスコア計算式に基づいて得点を算出します。計算には以下の要素が使用されます。

-   **連鎖ボーナス (`rensaBonus`)**: 連鎖数に応じた倍率。
-   **連結ボーナス (`pieceBonus`)**: 同時に消したぷよの数に応じたボーナス。
-   **色数ボーナス (`colorBonus`)**: 同時に消した色の数に応じたボーナス。

これらのボーナスを加算し、基本点（消したぷよの数 × 10）に乗算することで、最終的なスコアが計算されます。
