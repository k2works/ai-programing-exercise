# 負荷テストガイド

## 概要

会議室予約システム（MRS）の負荷テストは、以下の要件を検証します：

- **N001-02**: 100同時ユーザーのサポート
- **F005-01**: 悲観ロックによる並行予約制御
- **F005-02**: 重複予約の確実な防止

## テスト構成

### 1. Java並行処理テスト（ConcurrentReservationTest）

JUnitベースの負荷テストで、以下のシナリオを検証：

#### テストケース

1. **同一時間帯の並行予約テスト**
   - 100ユーザーが同時に同じ時間帯を予約
   - 期待結果：1件のみ成功、99件は競合エラー

2. **異なる時間帯の並行予約テスト**
   - 100ユーザーが異なる時間帯を予約
   - 期待結果：全100件が成功

3. **デッドロック検出テスト**
   - 複数会議室の交差予約によるデッドロック検証
   - 期待結果：デッドロックが適切に処理される

### 2. JMeter負荷テスト

実際のHTTPリクエストによる負荷テスト：

#### シナリオ構成

```
1. ログイン（JWT取得）
   ↓
2. 会議室一覧取得
   ↓
3. 予約作成（競合テスト）
   ↓
4. 予約キャンセル（成功時のみ）
```

#### テストパラメータ

- スレッド数：100
- ランプアップ期間：10秒
- ループ回数：1

## 実行方法

### 前提条件

1. アプリケーションが起動していること
```bash
mvn spring-boot:run
```

2. テストデータが初期化されていること

### Java並行処理テストの実行

```bash
# 単体で実行
mvn test -Dtest=ConcurrentReservationTest

# 特定のテストメソッドのみ実行
mvn test -Dtest=ConcurrentReservationTest#testConcurrentReservationForSameTimeSlot
```

### JMeterテストの実行

#### GUIモードで実行（デバッグ用）
```bash
jmeter -t src/test/jmeter/MRS_LoadTest.jmx
```

#### CLIモードで実行（本番テスト）
```bash
jmeter -n -t src/test/jmeter/MRS_LoadTest.jmx \
  -l target/jmeter-results/results.jtl \
  -e -o target/jmeter-results/html-report
```

### 統合実行スクリプト

#### Windows
```bash
scripts\run-load-test.bat
```

#### Mac/Linux
```bash
./scripts/run-load-test.sh
```

## 結果の確認

### Java並行処理テスト結果

```
target/surefire-reports/com.example.mrs.performance.ConcurrentReservationTest.txt
```

期待される出力例：
```
=== 並行予約テスト結果 ===
成功数: 1
競合数: 99
エラー数: 0
```

### JMeter結果

1. **生データ（JTL形式）**
   ```
   target/jmeter-results/{timestamp}/results.jtl
   ```

2. **HTMLレポート**
   ```
   target/jmeter-results/{timestamp}/html-report/index.html
   ```

### 主要メトリクス

| メトリクス | 目標値 | 測定方法 |
|----------|--------|---------|
| 同時接続数 | 100 | JMeterスレッド数 |
| 応答時間（予約作成） | 3秒以内 | JMeter Average |
| 応答時間（キャンセル） | 1秒以内 | JMeter Average |
| エラー率 | 0%（競合除く） | JMeter Error % |
| データ整合性 | 100% | 重複予約0件 |

## トラブルシューティング

### よくある問題と対処法

#### 1. ポート競合エラー
```
Address already in use: bind
```
**対処法**: 8080ポートを使用している他のプロセスを停止

#### 2. メモリ不足エラー
```
java.lang.OutOfMemoryError
```
**対処法**: JVMヒープサイズを増やす
```bash
export MAVEN_OPTS="-Xmx2048m -Xms1024m"
```

#### 3. デッドロック発生
```
Deadlock found when trying to get lock
```
**対処法**: 
- トランザクション分離レベルの確認
- ロック順序の統一
- タイムアウト設定の調整

#### 4. JMeterが見つからない
**対処法**:
1. JMeterをダウンロード: https://jmeter.apache.org/
2. 環境変数PATHに追加
3. または直接実行:
   ```bash
   /path/to/jmeter/bin/jmeter -n -t src/test/jmeter/MRS_LoadTest.jmx
   ```

## パフォーマンスチューニング

### データベース設定

```properties
# application.properties
spring.datasource.hikari.maximum-pool-size=100
spring.datasource.hikari.minimum-idle=10
spring.datasource.hikari.connection-timeout=5000
```

### トランザクション設定

```java
@Transactional(
    isolation = Isolation.READ_COMMITTED,
    timeout = 5
)
```

### ロック戦略

1. **悲観ロック（現在の実装）**
   - FOR UPDATE句使用
   - 確実だが性能劣化の可能性

2. **楽観ロック（代替案）**
   - バージョン番号使用
   - 高性能だが競合時にリトライ必要

## CI/CD統合

### GitHub Actions設定例

```yaml
name: Load Test

on:
  schedule:
    - cron: '0 2 * * *'  # 毎日AM2:00実行
  workflow_dispatch:

jobs:
  load-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      
      - name: Set up JDK 17
        uses: actions/setup-java@v2
        with:
          java-version: '17'
          
      - name: Start Application
        run: |
          mvn spring-boot:run &
          sleep 30
          
      - name: Run Load Tests
        run: mvn test -Dtest=ConcurrentReservationTest
        
      - name: Upload Results
        uses: actions/upload-artifact@v2
        with:
          name: load-test-results
          path: target/surefire-reports/
```

## 関連ドキュメント

- [イテレーション計画3](../development/イテレーション計画3.md)
- [仕様書 - 非機能要件](../requirements/仕様.md#非機能要件)
- [アプリケーション構成](../design/アプリケーション構成.md)