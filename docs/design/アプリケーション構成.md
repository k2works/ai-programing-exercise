# ä¼šè­°å®¤äºˆç´„ã‚·ã‚¹ãƒ†ãƒ ï¼ˆMRSï¼‰ - C# RESTful API ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æ§‹æˆè¨­è¨ˆæ›¸

## 1. æ¦‚è¦

æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ã€RESTful APIã€Dapperã€JWTèªè¨¼ã‚’æ ¸ã¨ã™ã‚‹C#/.NET 9ãƒ™ãƒ¼ã‚¹ã®ä¼šè­°å®¤äºˆç´„ã‚·ã‚¹ãƒ†ãƒ ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æ§‹æˆã«ã¤ã„ã¦è©³ç´°ã«å®šç¾©ã—ã¾ã™ã€‚WebUIã«ä¾å­˜ã—ãªã„API-Firstã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’æ¡ç”¨ã—ã€ãƒ˜ã‚­ã‚µã‚´ãƒŠãƒ«ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«åŸºã¥ã„ãŸé«˜æ€§èƒ½ã§æ‹¡å¼µæ€§ã®é«˜ã„ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆã‚’å®Ÿç¾ã—ã¾ã™ã€‚

## 2. ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³æ§‹æˆ

### 2.1 ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ ï¼ˆãƒ†ã‚¹ãƒˆæˆ¦ç•¥çµ±åˆï¼‰

```
MRS.Api.sln
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ MRS.Domain/                     # ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤ï¼ˆãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
â”‚   â”œâ”€â”€ MRS.Application/                # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤ï¼ˆãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ï¼‰
â”‚   â”œâ”€â”€ MRS.Infrastructure/             # ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£å±¤ï¼ˆãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ãƒ»å¤–éƒ¨ï¼‰
â”‚   â””â”€â”€ MRS.Api/                        # ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å±¤ï¼ˆRESTful APIï¼‰
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ Unit/                           # å˜ä½“ãƒ†ã‚¹ãƒˆï¼ˆé«˜é€Ÿãƒ»å¤§é‡ï¼‰
â”‚   â”‚   â”œâ”€â”€ MRS.Domain.UnitTests/       # ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯å˜ä½“ãƒ†ã‚¹ãƒˆ
â”‚   â”‚   â”œâ”€â”€ MRS.Application.UnitTests/  # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚µãƒ¼ãƒ“ã‚¹å˜ä½“ãƒ†ã‚¹ãƒˆ
â”‚   â”‚   â””â”€â”€ MRS.Api.UnitTests/         # APIã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼å˜ä½“ãƒ†ã‚¹ãƒˆ
â”‚   â”œâ”€â”€ Integration/                    # çµ±åˆãƒ†ã‚¹ãƒˆï¼ˆä¸­é€Ÿãƒ»ä¸­é‡ï¼‰
â”‚   â”‚   â”œâ”€â”€ MRS.Infrastructure.IntegrationTests/  # DBãƒ»å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ çµ±åˆ
â”‚   â”‚   â”œâ”€â”€ MRS.Application.IntegrationTests/     # ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹çµ±åˆãƒ†ã‚¹ãƒˆ
â”‚   â”‚   â””â”€â”€ MRS.Api.IntegrationTests/            # APIçµ±åˆãƒ†ã‚¹ãƒˆ
â”‚   â”œâ”€â”€ Architecture/                   # ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ†ã‚¹ãƒˆ
â”‚   â”‚   â””â”€â”€ MRS.ArchitectureTests/      # ä¾å­˜é–¢ä¿‚ãƒ»è¦ç´„æ¤œè¨¼
â”‚   â”œâ”€â”€ Contract/                       # å¥‘ç´„ãƒ†ã‚¹ãƒˆ
â”‚   â”‚   â””â”€â”€ MRS.ContractTests/          # APIå¥‘ç´„ãƒ»ã‚¹ã‚­ãƒ¼ãƒæ¤œè¨¼
â”‚   â”œâ”€â”€ E2E/                           # ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆï¼ˆä½é€Ÿãƒ»å°‘é‡ï¼‰
â”‚   â”‚   â””â”€â”€ MRS.E2ETests/              # ã‚·ãƒŠãƒªã‚ªãƒ™ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆ
â”‚   â””â”€â”€ Performance/                    # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
â”‚       â””â”€â”€ MRS.PerformanceTests/       # è² è·ãƒ»å¿œç­”æ™‚é–“ãƒ†ã‚¹ãƒˆ
â”œâ”€â”€ tools/
â”‚   â”œâ”€â”€ TestDataBuilder/               # ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ãƒ“ãƒ«ãƒ€ãƒ¼
â”‚   â”œâ”€â”€ TestContainers/               # Dockerçµ±åˆãƒ†ã‚¹ãƒˆç’°å¢ƒ
â”‚   â””â”€â”€ Fixtures/                     # å…±é€šãƒ†ã‚¹ãƒˆãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£
â””â”€â”€ docs/
    â”œâ”€â”€ api/                          # APIä»•æ§˜æ›¸
    â”œâ”€â”€ testing/                      # ãƒ†ã‚¹ãƒˆæˆ¦ç•¥ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
    â””â”€â”€ deployment/                   # ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆè¨­å®š
```

### 2.2 ãƒ˜ã‚­ã‚µã‚´ãƒŠãƒ«ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ§‹æˆå›³

```plantuml
@startuml
!theme plain

skinparam component {
  BackgroundColor #ffffff
  BorderColor #000000
}

' ãƒ˜ã‚­ã‚µã‚´ãƒ³ï¼ˆãƒ‰ãƒ¡ã‚¤ãƒ³ï¼‰
hexagon "Domain Core" as domain #lightyellow {
  component "Entities\n(Reservation, Room, User)" as entities
  component "Value Objects\n(TimeSlot, UserId)" as valueobjects
  component "Domain Services\n(ConflictChecker)" as domainservices
  component "Domain Events" as events
}

' ãƒ—ãƒ©ã‚¤ãƒãƒªãƒ¼ãƒãƒ¼ãƒˆï¼ˆå…¥åŠ›ï¼‰
interface "Reservation\nUse Cases" as reservationport
interface "Authentication\nUse Cases" as authport
interface "Room\nUse Cases" as roomport

' ã‚»ã‚«ãƒ³ãƒ€ãƒªãƒ¼ãƒãƒ¼ãƒˆï¼ˆå‡ºåŠ›ï¼‰
interface "Reservation\nRepository" as reservationrepo
interface "User\nRepository" as userrepo
interface "Room\nRepository" as roomrepo
interface "Token\nProvider" as tokenport
interface "Cache\nService" as cacheport

' ãƒ—ãƒ©ã‚¤ãƒãƒªãƒ¼ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼
component "REST API\nControllers" as restapi #lightblue
component "CLI\nInterface" as cli #lightblue

' ã‚»ã‚«ãƒ³ãƒ€ãƒªãƒ¼ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼
component "SQL Server\nDapper Adapter" as sqlserver #lightsalmon
component "PostgreSQL\nDapper Adapter" as postgresql #lightsalmon
component "JWT Token\nProvider" as jwtadapter #lightsalmon
component "Redis Cache\nAdapter" as redisadapter #lightsalmon
component "Memory Cache\nAdapter" as memoryadapter #lightsalmon

' ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤ï¼ˆãƒãƒ¼ãƒˆå®Ÿè£…ï¼‰
component "Application\nServices" as appservices #lightgreen

' æ¥ç¶š
restapi --> reservationport
restapi --> authport
restapi --> roomport
cli --> reservationport

reservationport --> appservices
authport --> appservices
roomport --> appservices

appservices --> domain
appservices --> reservationrepo
appservices --> userrepo
appservices --> roomrepo
appservices --> tokenport
appservices --> cacheport

reservationrepo <|-- sqlserver
reservationrepo <|-- postgresql
userrepo <|-- sqlserver
userrepo <|-- postgresql
roomrepo <|-- sqlserver
roomrepo <|-- postgresql
tokenport <|-- jwtadapter
cacheport <|-- redisadapter
cacheport <|-- memoryadapter

@enduml
```

**ãƒ˜ã‚­ã‚µã‚´ãƒŠãƒ«ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®æ ¸å¿ƒåŸå‰‡:**

1. **ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚³ã‚¢ï¼ˆå…­è§’å½¢ã®ä¸­å¿ƒï¼‰**: ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã®ã¿ã€å¤–éƒ¨ä¾å­˜ãªã—
2. **ãƒ—ãƒ©ã‚¤ãƒãƒªãƒ¼ãƒãƒ¼ãƒˆ**: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¸ã®å…¥åŠ›ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
3. **ã‚»ã‚«ãƒ³ãƒ€ãƒªãƒ¼ãƒãƒ¼ãƒˆ**: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‹ã‚‰ã®å‡ºåŠ›ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹  
4. **ãƒ—ãƒ©ã‚¤ãƒãƒªãƒ¼ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼**: å¤–éƒ¨ã‹ã‚‰ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’é§†å‹•ï¼ˆWeb APIã€CLIç­‰ï¼‰
5. **ã‚»ã‚«ãƒ³ãƒ€ãƒªãƒ¼ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼**: ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒä½¿ç”¨ã™ã‚‹å¤–éƒ¨ãƒªã‚½ãƒ¼ã‚¹ï¼ˆDBã€Cacheç­‰ï¼‰
6. **ä¾å­˜ã®æ–¹å‘**: å¸¸ã«å¤–å´ã‹ã‚‰å†…å´ï¼ˆãƒ‰ãƒ¡ã‚¤ãƒ³ï¼‰ã«å‘ã‹ã†

## 3. å„å±¤ã®è©³ç´°æ§‹æˆ

### 3.1 ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤ï¼ˆMRS.Domainï¼‰- ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®ä¸­å¿ƒæ ¸

#### 3.1.1 ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹æˆï¼ˆç´”ç²‹ãªãƒ‰ãƒ¡ã‚¤ãƒ³ï¼‰

```
MRS.Domain/
â”œâ”€â”€ Models/                           # ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒ»é›†ç´„ãƒ«ãƒ¼ãƒˆï¼ˆå¤–éƒ¨ä¾å­˜ãªã—ï¼‰
â”‚   â”œâ”€â”€ Reservation.cs                # äºˆç´„ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
â”‚   â”œâ”€â”€ ReservableRoom.cs             # äºˆç´„å¯èƒ½ä¼šè­°å®¤
â”‚   â”œâ”€â”€ MeetingRoom.cs                # ä¼šè­°å®¤ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
â”‚   â”œâ”€â”€ User.cs                       # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
â”‚   â””â”€â”€ RefreshToken.cs               # ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³
â”œâ”€â”€ ValueObjects/                     # å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆä¸å¤‰ï¼‰
â”‚   â”œâ”€â”€ UserId.cs                     # ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
â”‚   â”œâ”€â”€ RoomId.cs                     # ä¼šè­°å®¤ID
â”‚   â”œâ”€â”€ ReservationId.cs              # äºˆç´„ID
â”‚   â”œâ”€â”€ UserRole.cs                   # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ãƒ¼ãƒ«
â”‚   â””â”€â”€ TimeSlot.cs                   # æ™‚é–“æ 
â”œâ”€â”€ Services/                         # ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆç´”ç²‹ãªãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
â”‚   â”œâ”€â”€ ReservationDomainService.cs   # äºˆç´„ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹
â”‚   â””â”€â”€ ReservationConflictChecker.cs # é‡è¤‡ãƒã‚§ãƒƒã‚¯
â”œâ”€â”€ Ports/                            # ã‚»ã‚«ãƒ³ãƒ€ãƒªãƒ¼ãƒãƒ¼ãƒˆï¼ˆå‡ºåŠ›ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼‰
â”‚   â”œâ”€â”€ IReservationRepository.cs     # äºˆç´„æ°¸ç¶šåŒ–ãƒãƒ¼ãƒˆ
â”‚   â”œâ”€â”€ IRoomRepository.cs            # ä¼šè­°å®¤æ°¸ç¶šåŒ–ãƒãƒ¼ãƒˆ
â”‚   â”œâ”€â”€ IUserRepository.cs            # ãƒ¦ãƒ¼ã‚¶ãƒ¼æ°¸ç¶šåŒ–ãƒãƒ¼ãƒˆ
â”‚   â”œâ”€â”€ ITokenProvider.cs             # ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆãƒãƒ¼ãƒˆ
â”‚   â”œâ”€â”€ ICacheService.cs              # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚µãƒ¼ãƒ“ã‚¹ãƒãƒ¼ãƒˆ
â”‚   â””â”€â”€ IUnitOfWork.cs                # ä½œæ¥­å˜ä½ãƒãƒ¼ãƒˆ
â”œâ”€â”€ Events/                           # ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
â”‚   â”œâ”€â”€ ReservationCreatedEvent.cs
â”‚   â”œâ”€â”€ ReservationCancelledEvent.cs
â”‚   â””â”€â”€ IDomainEvent.cs
â”œâ”€â”€ Exceptions/                       # ãƒ‰ãƒ¡ã‚¤ãƒ³ä¾‹å¤–
â”‚   â”œâ”€â”€ DomainException.cs
â”‚   â”œâ”€â”€ ReservationConflictException.cs
â”‚   â”œâ”€â”€ UnauthorizedException.cs
â”‚   â””â”€â”€ ResourceNotFoundException.cs
â””â”€â”€ Common/                           # å…±é€šåŸºåº•ã‚¯ãƒ©ã‚¹
    â”œâ”€â”€ Entity.cs
    â”œâ”€â”€ ValueObject.cs
    â”œâ”€â”€ IAggregateRoot.cs
    â””â”€â”€ IDomainEventHandler.cs
```

**ğŸ“ é‡è¦**: ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤ã¯**ä¸€åˆ‡ã®å¤–éƒ¨ä¾å­˜ã‚’æŒãŸãªã„**ç´”ç²‹ãªC#ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚

#### 3.1.2 ä¸»è¦ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£è¨­è¨ˆ

**Reservation ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£**

```csharp
namespace MRS.Domain.Models
{
    public class Reservation : Entity<ReservationId>, IAggregateRoot
    {
        public UserId UserId { get; private set; }
        public RoomId RoomId { get; private set; }
        public DateOnly ReservedDate { get; private set; }
        public TimeSlot TimeSlot { get; private set; }
        public DateTime CreatedAt { get; private set; }
        public string? Purpose { get; private set; }

        private Reservation() { } // EF Coreç”¨

        public Reservation(
            UserId userId,
            RoomId roomId,
            DateOnly reservedDate,
            TimeSlot timeSlot,
            string? purpose = null)
        {
            ValidateBusinessRules(timeSlot);

            Id = ReservationId.NewId();
            UserId = userId ?? throw new ArgumentNullException(nameof(userId));
            RoomId = roomId ?? throw new ArgumentNullException(nameof(roomId));
            ReservedDate = reservedDate;
            TimeSlot = timeSlot ?? throw new ArgumentNullException(nameof(timeSlot));
            Purpose = purpose;
            CreatedAt = DateTime.UtcNow;
        }

        public bool OverlapsWith(Reservation other)
        {
            if (other == null) return false;
            if (RoomId != other.RoomId || ReservedDate != other.ReservedDate) return false;
            
            return TimeSlot.OverlapsWith(other.TimeSlot);
        }

        public bool CanBeCancelledBy(UserId userId, bool isAdmin = false)
        {
            return isAdmin || UserId.Equals(userId);
        }

        private static void ValidateBusinessRules(TimeSlot timeSlot)
        {
            if (timeSlot.Duration > TimeSpan.FromHours(8))
                throw new DomainException("1å›ã®äºˆç´„ã¯æœ€å¤§8æ™‚é–“ã¾ã§ã§ã™");

            if (timeSlot.StartTime.Minute % 30 != 0 || timeSlot.EndTime.Minute % 30 != 0)
                throw new DomainException("äºˆç´„ã¯30åˆ†å˜ä½ã§å…¥åŠ›ã—ã¦ãã ã•ã„");
        }
    }
}
```

**TimeSlot å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ**

```csharp
namespace MRS.Domain.ValueObjects
{
    public record TimeSlot
    {
        public TimeOnly StartTime { get; }
        public TimeOnly EndTime { get; }
        public TimeSpan Duration => EndTime - StartTime;

        public TimeSlot(TimeOnly startTime, TimeOnly endTime)
        {
            if (endTime <= startTime)
                throw new ArgumentException("çµ‚äº†æ™‚åˆ»ã¯é–‹å§‹æ™‚åˆ»ã‚ˆã‚Šå¾Œã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™");

            StartTime = startTime;
            EndTime = endTime;
        }

        public bool OverlapsWith(TimeSlot other)
        {
            if (other == null) return false;
            return EndTime > other.StartTime && other.EndTime > StartTime;
        }

        public bool Contains(TimeOnly time)
        {
            return StartTime <= time && time < EndTime;
        }

        public static TimeSlot Create(string startTime, string endTime)
        {
            return new TimeSlot(
                TimeOnly.ParseExact(startTime, "HH:mm"),
                TimeOnly.ParseExact(endTime, "HH:mm"));
        }
    }
}
```

### 3.2 ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤ï¼ˆMRS.Applicationï¼‰- ãƒ—ãƒ©ã‚¤ãƒãƒªãƒ¼ãƒãƒ¼ãƒˆå®Ÿè£…

#### 3.2.1 ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹æˆï¼ˆãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹å®Ÿè£…ï¼‰

```
MRS.Application/
â”œâ”€â”€ Ports/                            # ãƒ—ãƒ©ã‚¤ãƒãƒªãƒ¼ãƒãƒ¼ãƒˆï¼ˆå…¥åŠ›ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼‰
â”‚   â”œâ”€â”€ IReservationUseCases.cs       # äºˆç´„ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ãƒãƒ¼ãƒˆ
â”‚   â”œâ”€â”€ IAuthenticationUseCases.cs    # èªè¨¼ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ãƒãƒ¼ãƒˆ
â”‚   â”œâ”€â”€ IRoomUseCases.cs              # ä¼šè­°å®¤ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ãƒãƒ¼ãƒˆ
â”‚   â””â”€â”€ IUserUseCases.cs              # ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ãƒãƒ¼ãƒˆ
â”œâ”€â”€ Services/                         # ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹å®Ÿè£…ï¼ˆãƒ—ãƒ©ã‚¤ãƒãƒªãƒ¼ãƒãƒ¼ãƒˆå®Ÿè£…ï¼‰
â”‚   â”œâ”€â”€ Auth/
â”‚   â”‚   â”œâ”€â”€ AuthenticationService.cs  # IAuthenticationUseCaseså®Ÿè£…
â”‚   â”‚   â””â”€â”€ TokenRefreshService.cs
â”‚   â”œâ”€â”€ Reservations/
â”‚   â”‚   â””â”€â”€ ReservationService.cs     # IReservationUseCaseså®Ÿè£…
â”‚   â”œâ”€â”€ Rooms/
â”‚   â”‚   â””â”€â”€ RoomService.cs            # IRoomUseCaseså®Ÿè£…
â”‚   â””â”€â”€ Users/
â”‚       â””â”€â”€ UserService.cs            # IUserUseCaseså®Ÿè£…
â”œâ”€â”€ DTOs/                             # ãƒ‡ãƒ¼ã‚¿è»¢é€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
â”‚   â”œâ”€â”€ Auth/
â”‚   â”‚   â”œâ”€â”€ LoginRequestDto.cs
â”‚   â”‚   â”œâ”€â”€ AuthResultDto.cs
â”‚   â”‚   â”œâ”€â”€ RefreshTokenRequestDto.cs
â”‚   â”‚   â””â”€â”€ UserProfileDto.cs
â”‚   â”œâ”€â”€ Reservations/
â”‚   â”‚   â”œâ”€â”€ ReservationDto.cs
â”‚   â”‚   â”œâ”€â”€ CreateReservationDto.cs
â”‚   â”‚   â”œâ”€â”€ ReservationQueryDto.cs
â”‚   â”‚   â””â”€â”€ ReservationSummaryDto.cs
â”‚   â””â”€â”€ Rooms/
â”‚       â”œâ”€â”€ RoomDto.cs
â”‚       â”œâ”€â”€ RoomAvailabilityDto.cs
â”‚       â””â”€â”€ TimeSlotDto.cs
â”œâ”€â”€ Commands/                         # ã‚³ãƒãƒ³ãƒ‰ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆæ›¸ãè¾¼ã¿æ“ä½œï¼‰
â”‚   â”œâ”€â”€ Reservations/
â”‚   â”‚   â”œâ”€â”€ CreateReservationCommand.cs
â”‚   â”‚   â”œâ”€â”€ CancelReservationCommand.cs
â”‚   â”‚   â””â”€â”€ UpdateReservationCommand.cs
â”‚   â””â”€â”€ Users/
â”‚       â””â”€â”€ UpdateUserProfileCommand.cs
â”œâ”€â”€ Queries/                          # ã‚¯ã‚¨ãƒªãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆèª­ã¿è¾¼ã¿æ“ä½œï¼‰
â”‚   â”œâ”€â”€ Reservations/
â”‚   â”‚   â”œâ”€â”€ GetReservationsQuery.cs
â”‚   â”‚   â”œâ”€â”€ GetReservationByIdQuery.cs
â”‚   â”‚   â””â”€â”€ GetUserReservationsQuery.cs
â”‚   â””â”€â”€ Rooms/
â”‚       â”œâ”€â”€ GetRoomsQuery.cs
â”‚       â””â”€â”€ GetRoomAvailabilityQuery.cs
â”œâ”€â”€ Validators/                       # FluentValidationï¼ˆãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«æ¤œè¨¼ï¼‰
â”‚   â”œâ”€â”€ Auth/
â”‚   â”‚   â”œâ”€â”€ LoginRequestValidator.cs
â”‚   â”‚   â””â”€â”€ RefreshTokenRequestValidator.cs
â”‚   â””â”€â”€ Reservations/
â”‚       â”œâ”€â”€ CreateReservationValidator.cs
â”‚       â””â”€â”€ CancelReservationValidator.cs
â”œâ”€â”€ Mappings/                         # DTOâ†”ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒãƒƒãƒ”ãƒ³ã‚°
â”‚   â”œâ”€â”€ ReservationMappingProfile.cs
â”‚   â”œâ”€â”€ RoomMappingProfile.cs
â”‚   â””â”€â”€ UserMappingProfile.cs
â”œâ”€â”€ EventHandlers/                    # ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
â”‚   â”œâ”€â”€ ReservationCreatedHandler.cs
â”‚   â””â”€â”€ ReservationCancelledHandler.cs
â””â”€â”€ Common/                           # å…±é€šï¼ˆçµæœãƒ‘ã‚¿ãƒ¼ãƒ³ç­‰ï¼‰
    â”œâ”€â”€ Result.cs
    â”œâ”€â”€ PagedResult.cs
    â”œâ”€â”€ ApiResponse.cs
    â””â”€â”€ ApplicationException.cs
```

**ğŸ“ é‡è¦**: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤ã¯**ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ã¿ã«ä¾å­˜**ã—ã€ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ã«ã¯ä¾å­˜ã—ã¾ã›ã‚“ã€‚

#### 3.2.2 ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹å®Ÿè£…ä¾‹ï¼ˆçœŸã®ãƒ˜ã‚­ã‚µã‚´ãƒŠãƒ«ï¼‰

**IReservationUseCases ãƒãƒ¼ãƒˆå®šç¾©**

```csharp
namespace MRS.Application.Ports
{
    /// <summary>
    /// äºˆç´„ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã®ãƒ—ãƒ©ã‚¤ãƒãƒªãƒ¼ãƒãƒ¼ãƒˆï¼ˆå…¥åŠ›ï¼‰
    /// å¤–éƒ¨ã‹ã‚‰ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’é§†å‹•ã™ã‚‹ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
    /// </summary>
    public interface IReservationUseCases
    {
        Task<Result<ReservationDto>> CreateReservationAsync(CreateReservationCommand command);
        Task<PagedResult<ReservationDto>> GetReservationsAsync(GetReservationsQuery query);
        Task<Result<ReservationDto>> GetReservationByIdAsync(ReservationId id);
        Task<Result> CancelReservationAsync(CancelReservationCommand command);
        Task<IEnumerable<ReservationDto>> GetUserReservationsAsync(GetUserReservationsQuery query);
    }
}
```

**ReservationService å®Ÿè£…ï¼ˆãƒãƒ¼ãƒˆå®Ÿè£…ï¼‰**

```csharp
namespace MRS.Application.Services.Reservations
{
    /// <summary>
    /// äºˆç´„ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã®å®Ÿè£…
    /// ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ã‚’èª¿æ•´ã—ã€ã‚»ã‚«ãƒ³ãƒ€ãƒªãƒ¼ãƒãƒ¼ãƒˆã‚’ä½¿ç”¨
    /// </summary>
    public class ReservationService : IReservationUseCases
    {
        // ã‚»ã‚«ãƒ³ãƒ€ãƒªãƒ¼ãƒãƒ¼ãƒˆï¼ˆå‡ºåŠ›ï¼‰ã¸ã®ä¾å­˜
        private readonly IReservationRepository _reservationRepository;
        private readonly IRoomRepository _roomRepository;
        private readonly ICacheService _cache;
        private readonly IUnitOfWork _unitOfWork;
        
        // ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹ã¸ã®ä¾å­˜
        private readonly ReservationDomainService _domainService;
        
        // æŠ€è¡“çš„é–¢å¿ƒäº‹
        private readonly IMapper _mapper;
        private readonly ILogger<ReservationService> _logger;

        public ReservationService(
            IReservationRepository reservationRepository,
            IRoomRepository roomRepository,
            ICacheService cache,
            IUnitOfWork unitOfWork,
            ReservationDomainService domainService,
            IMapper mapper,
            ILogger<ReservationService> logger)
        {
            _reservationRepository = reservationRepository;
            _roomRepository = roomRepository;
            _cache = cache;
            _unitOfWork = unitOfWork;
            _domainService = domainService;
            _mapper = mapper;
            _logger = logger;
        }

        public async Task<Result<ReservationDto>> CreateReservationAsync(
            CreateReservationCommand command)
        {
            try
            {
                // 1. ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®æ§‹ç¯‰
                var timeSlot = TimeSlot.Create(command.StartTime, command.EndTime);
                var userId = UserId.Of(command.UserId);
                var roomId = RoomId.Of(command.RoomId);

                // 2. ã‚»ã‚«ãƒ³ãƒ€ãƒªãƒ¼ãƒãƒ¼ãƒˆçµŒç”±ã§ãƒ‡ãƒ¼ã‚¿å–å¾—
                var room = await _roomRepository.GetByIdAsync(roomId);
                if (room == null)
                {
                    return Result<ReservationDto>.Failure("æŒ‡å®šã•ã‚ŒãŸä¼šè­°å®¤ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
                }

                // 3. ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«æ¤œè¨¼ï¼ˆãƒ‰ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹ä½¿ç”¨ï¼‰
                var existingReservations = await _reservationRepository
                    .GetByRoomAndDateAsync(roomId, command.Date);

                var newReservation = new Reservation(
                    userId, roomId, command.Date, timeSlot, command.Purpose);

                if (_domainService.HasConflict(existingReservations, newReservation))
                {
                    _logger.LogWarning("äºˆç´„ã®é‡è¤‡ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ");
                    return Result<ReservationDto>.Failure("å…¥åŠ›ã®æ™‚é–“å¸¯ã¯ã™ã§ã«äºˆç´„æ¸ˆã¿ã§ã™");
                }

                // 4. ã‚»ã‚«ãƒ³ãƒ€ãƒªãƒ¼ãƒãƒ¼ãƒˆçµŒç”±ã§æ°¸ç¶šåŒ–
                using var transaction = await _unitOfWork.BeginTransactionAsync();
                await _reservationRepository.SaveAsync(newReservation);
                await transaction.CommitAsync();

                // 5. ã‚»ã‚«ãƒ³ãƒ€ãƒªãƒ¼ãƒãƒ¼ãƒˆçµŒç”±ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°
                await _cache.RemovePatternAsync($"reservations_room_{roomId.Value}_*");

                _logger.LogInformation("äºˆç´„ãŒä½œæˆã•ã‚Œã¾ã—ãŸ: {ReservationId}", newReservation.Id);

                var resultDto = _mapper.Map<ReservationDto>(newReservation);
                return Result<ReservationDto>.Success(resultDto);
            }
            catch (ReservationConflictException ex)
            {
                _logger.LogWarning(ex, "äºˆç´„ã®ç«¶åˆãŒç™ºç”Ÿã—ã¾ã—ãŸ");
                return Result<ReservationDto>.Failure(ex.Message);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "äºˆç´„ä½œæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
                return Result<ReservationDto>.Failure("äºˆç´„ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ");
            }
        }

        // ... ä»–ã®ãƒ¡ã‚½ãƒƒãƒ‰å®Ÿè£…
    }
}
```

### 3.3 ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£å±¤ï¼ˆMRS.Infrastructureï¼‰- ã‚»ã‚«ãƒ³ãƒ€ãƒªãƒ¼ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼

#### 3.3.1 ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹æˆï¼ˆæŠ€è¡“çš„å®Ÿè£…ï¼‰

```
MRS.Infrastructure/
â”œâ”€â”€ Adapters/                         # ã‚»ã‚«ãƒ³ãƒ€ãƒªãƒ¼ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼å®Ÿè£…
â”‚   â”œâ”€â”€ Persistence/                  # æ°¸ç¶šåŒ–ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ï¼ˆDapperï¼‰
â”‚   â”‚   â”œâ”€â”€ ReservationRepository.cs  # IReservationRepositoryå®Ÿè£…
â”‚   â”‚   â”œâ”€â”€ RoomRepository.cs         # IRoomRepositoryå®Ÿè£…
â”‚   â”‚   â”œâ”€â”€ UserRepository.cs         # IUserRepositoryå®Ÿè£…
â”‚   â”‚   â””â”€â”€ UnitOfWork.cs            # IUnitOfWorkå®Ÿè£…
â”‚   â”œâ”€â”€ Security/                     # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼
â”‚   â”‚   â”œâ”€â”€ JwtTokenProvider.cs       # ITokenProviderå®Ÿè£…
â”‚   â”‚   â”œâ”€â”€ PasswordHasher.cs
â”‚   â”‚   â””â”€â”€ SecurityService.cs
â”‚   â”œâ”€â”€ Caching/                      # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼
â”‚   â”‚   â”œâ”€â”€ RedisCacheService.cs      # ICacheServiceå®Ÿè£…
â”‚   â”‚   â””â”€â”€ MemoryCacheService.cs     # ICacheServiceå®Ÿè£…
â”‚   â””â”€â”€ Notifications/                # é€šçŸ¥ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼
â”‚       â”œâ”€â”€ EmailNotificationService.cs
â”‚       â””â”€â”€ SmsNotificationService.cs
â”œâ”€â”€ Data/                             # ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹è¨­å®š
â”‚   â”œâ”€â”€ ConnectionFactory.cs
â”‚   â”œâ”€â”€ DatabaseInitializer.cs
â”‚   â”œâ”€â”€ SqlQueries/                   # SQL ã‚¯ã‚¨ãƒªå®šç¾©
â”‚   â”‚   â”œâ”€â”€ ReservationQueries.cs
â”‚   â”‚   â”œâ”€â”€ RoomQueries.cs
â”‚   â”‚   â”œâ”€â”€ UserQueries.cs
â”‚   â”‚   â””â”€â”€ TokenQueries.cs
â”‚   â””â”€â”€ Migrations/                   # DB ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
â”‚       â”œâ”€â”€ 001_InitialSchema.sql
â”‚       â”œâ”€â”€ 002_AddIndexes.sql
â”‚       â”œâ”€â”€ 003_RefreshTokens.sql
â”‚       â””â”€â”€ 004_Performance.sql
â”œâ”€â”€ Configuration/                    # è¨­å®šãƒ»DIï¼ˆæŠ€è¡“çš„ãªé…ç·šï¼‰
â”‚   â”œâ”€â”€ DatabaseConfiguration.cs
â”‚   â”œâ”€â”€ JwtConfiguration.cs
â”‚   â”œâ”€â”€ DependencyInjection.cs       # ã‚»ã‚«ãƒ³ãƒ€ãƒªãƒ¼ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã®DIè¨­å®š
â”‚   â””â”€â”€ AutoMapperConfiguration.cs
â””â”€â”€ Logging/                          # ãƒ­ã‚®ãƒ³ã‚°
    â”œâ”€â”€ DatabaseLogger.cs
    â””â”€â”€ LoggingConfiguration.cs
```

#### 3.3.2 Dapper ãƒªãƒã‚¸ãƒˆãƒªå®Ÿè£…

**ReservationRepository**

```csharp
namespace MRS.Infrastructure.Repositories
{
    public class ReservationRepository : IReservationRepository
    {
        private readonly IConnectionFactory _connectionFactory;
        private readonly ICacheService _cache;
        private readonly ILogger<ReservationRepository> _logger;

        public ReservationRepository(
            IConnectionFactory connectionFactory,
            ICacheService cache,
            ILogger<ReservationRepository> logger)
        {
            _connectionFactory = connectionFactory;
            _cache = cache;
            _logger = logger;
        }

        public async Task<Reservation?> GetByIdAsync(ReservationId id)
        {
            const string cacheKey = $"reservation_{0}";
            var cached = await _cache.GetAsync<Reservation>(string.Format(cacheKey, id.Value));
            if (cached != null) return cached;

            using var connection = await _connectionFactory.CreateConnectionAsync();
            
            var result = await connection.QuerySingleOrDefaultAsync<dynamic>(
                ReservationQueries.GetById,
                new { ReservationId = id.Value });

            if (result == null) return null;

            var reservation = MapToReservation(result);
            await _cache.SetAsync(string.Format(cacheKey, id.Value), reservation, TimeSpan.FromMinutes(15));
            
            return reservation;
        }

        public async Task<IEnumerable<Reservation>> GetByRoomAndDateAsync(
            RoomId roomId, DateOnly date)
        {
            using var connection = await _connectionFactory.CreateConnectionAsync();
            
            var results = await connection.QueryAsync<dynamic>(
                ReservationQueries.GetByRoomAndDate,
                new { RoomId = roomId.Value, Date = date });

            return results.Select(MapToReservation);
        }

        public async Task<IEnumerable<Reservation>> GetByRoomAndDateWithLockAsync(
            RoomId roomId, DateOnly date)
        {
            using var connection = await _connectionFactory.CreateConnectionAsync();
            
            // æ‚²è¦³çš„ãƒ­ãƒƒã‚¯ï¼ˆSQL Serverç”¨ã®ãƒ­ãƒƒã‚¯ãƒ’ãƒ³ãƒˆï¼‰
            var results = await connection.QueryAsync<dynamic>(
                ReservationQueries.GetByRoomAndDateWithLock,
                new { RoomId = roomId.Value, Date = date });

            return results.Select(MapToReservation);
        }

        public async Task<PagedResult<Reservation>> GetByQueryAsync(
            RoomId? roomId = null,
            UserId? userId = null,
            DateOnly? fromDate = null,
            DateOnly? toDate = null,
            int page = 1,
            int pageSize = 20)
        {
            using var connection = await _connectionFactory.CreateConnectionAsync();

            var conditions = BuildWhereConditions(roomId, userId, fromDate, toDate);
            var parameters = BuildParameters(roomId, userId, fromDate, toDate, page, pageSize);

            var query = ReservationQueries.GetByQuery + conditions + " ORDER BY reserved_date, start_time OFFSET @Offset ROWS FETCH NEXT @PageSize ROWS ONLY";
            var countQuery = ReservationQueries.GetCountByQuery + conditions;

            var itemsTask = connection.QueryAsync<dynamic>(query, parameters);
            var countTask = connection.QuerySingleAsync<int>(countQuery, parameters);

            await Task.WhenAll(itemsTask, countTask);

            var items = itemsTask.Result.Select(MapToReservation);
            var totalCount = countTask.Result;

            return new PagedResult<Reservation>
            {
                Items = items,
                TotalCount = totalCount,
                Page = page,
                PageSize = pageSize
            };
        }

        public async Task<int> SaveAsync(Reservation reservation)
        {
            using var connection = await _connectionFactory.CreateConnectionAsync();
            
            var result = await connection.ExecuteAsync(
                ReservationQueries.Insert,
                new
                {
                    ReservationId = reservation.Id.Value,
                    UserId = reservation.UserId.Value,
                    RoomId = reservation.RoomId.Value,
                    ReservedDate = reservation.ReservedDate,
                    StartTime = reservation.TimeSlot.StartTime,
                    EndTime = reservation.TimeSlot.EndTime,
                    Purpose = reservation.Purpose,
                    CreatedAt = reservation.CreatedAt
                });

            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–
            await _cache.RemoveAsync($"reservation_{reservation.Id.Value}");
            await _cache.RemovePatternAsync($"reservations_room_{reservation.RoomId.Value}_*");

            return result;
        }

        public async Task DeleteAsync(ReservationId id)
        {
            using var connection = await _connectionFactory.CreateConnectionAsync();
            
            await connection.ExecuteAsync(
                ReservationQueries.Delete,
                new { ReservationId = id.Value });

            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–
            await _cache.RemoveAsync($"reservation_{id.Value}");
        }

        private static Reservation MapToReservation(dynamic row)
        {
            var userId = UserId.Of(row.user_id);
            var roomId = RoomId.Of(row.room_id);
            var timeSlot = new TimeSlot(row.start_time, row.end_time);

            return new Reservation(userId, roomId, row.reserved_date, timeSlot, row.purpose)
            {
                Id = ReservationId.Of(row.reservation_id),
                CreatedAt = row.created_at
            };
        }

        private static string BuildWhereConditions(
            RoomId? roomId, UserId? userId, DateOnly? fromDate, DateOnly? toDate)
        {
            var conditions = new List<string> { "1=1" };

            if (roomId != null) conditions.Add("room_id = @RoomId");
            if (userId != null) conditions.Add("user_id = @UserId");
            if (fromDate != null) conditions.Add("reserved_date >= @FromDate");
            if (toDate != null) conditions.Add("reserved_date <= @ToDate");

            return " WHERE " + string.Join(" AND ", conditions);
        }

        private static object BuildParameters(
            RoomId? roomId, UserId? userId, DateOnly? fromDate, DateOnly? toDate, int page, int pageSize)
        {
            return new
            {
                RoomId = roomId?.Value,
                UserId = userId?.Value,
                FromDate = fromDate,
                ToDate = toDate,
                Offset = (page - 1) * pageSize,
                PageSize = pageSize
            };
        }
    }
}
```

### 3.4 ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å±¤ï¼ˆMRS.Apiï¼‰- ãƒ—ãƒ©ã‚¤ãƒãƒªãƒ¼ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼

#### 3.4.1 ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹æˆï¼ˆå¤–éƒ¨ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼‰

```
MRS.Api/
â”œâ”€â”€ Adapters/                         # ãƒ—ãƒ©ã‚¤ãƒãƒªãƒ¼ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼
â”‚   â”œâ”€â”€ Controllers/                  # REST API ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼
â”‚   â”‚   â”œâ”€â”€ V1/                       # ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°
â”‚   â”‚   â”‚   â”œâ”€â”€ AuthController.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ RoomsController.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ ReservationsController.cs
â”‚   â”‚   â”‚   â””â”€â”€ UsersController.cs
â”‚   â”‚   â””â”€â”€ BaseApiController.cs      # åŸºåº•ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼
â”‚   â”œâ”€â”€ CLI/                          # ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ï¼ˆå°†æ¥æ‹¡å¼µï¼‰
â”‚   â”‚   â””â”€â”€ ReservationCliAdapter.cs
â”‚   â””â”€â”€ GraphQL/                      # GraphQL ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ï¼ˆå°†æ¥æ‹¡å¼µï¼‰
â”‚       â””â”€â”€ ReservationGraphQLAdapter.cs
â”œâ”€â”€ Middleware/                       # HTTP ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
â”‚   â”œâ”€â”€ ErrorHandlingMiddleware.cs
â”‚   â”œâ”€â”€ RequestLoggingMiddleware.cs
â”‚   â”œâ”€â”€ PerformanceMiddleware.cs
â”‚   â””â”€â”€ SecurityHeadersMiddleware.cs
â”œâ”€â”€ Filters/                          # ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
â”‚   â”œâ”€â”€ ValidateModelFilter.cs
â”‚   â”œâ”€â”€ AuthorizeFilter.cs
â”‚   â”œâ”€â”€ RateLimitFilter.cs
â”‚   â””â”€â”€ ApiVersionFilter.cs
â”œâ”€â”€ Extensions/                       # æ‹¡å¼µãƒ¡ã‚½ãƒƒãƒ‰
â”‚   â”œâ”€â”€ ServiceCollectionExtensions.cs
â”‚   â”œâ”€â”€ ApplicationBuilderExtensions.cs
â”‚   â”œâ”€â”€ ControllerExtensions.cs
â”‚   â””â”€â”€ ClaimsPrincipalExtensions.cs
â”œâ”€â”€ Configuration/                    # APIè¨­å®š
â”‚   â”œâ”€â”€ SwaggerConfiguration.cs
â”‚   â”œâ”€â”€ CorsConfiguration.cs
â”‚   â”œâ”€â”€ ApiVersioningConfiguration.cs
â”‚   â””â”€â”€ SecurityConfiguration.cs
â”œâ”€â”€ Models/                           # APIå°‚ç”¨ãƒ¢ãƒ‡ãƒ«ï¼ˆHTTPå¢ƒç•Œï¼‰
â”‚   â”œâ”€â”€ Requests/
â”‚   â”‚   â”œâ”€â”€ LoginRequest.cs
â”‚   â”‚   â”œâ”€â”€ CreateReservationRequest.cs
â”‚   â”‚   â””â”€â”€ RefreshTokenRequest.cs
â”‚   â”œâ”€â”€ Responses/
â”‚   â”‚   â”œâ”€â”€ ApiResponse.cs
â”‚   â”‚   â”œâ”€â”€ AuthResponse.cs
â”‚   â”‚   â”œâ”€â”€ ReservationResponse.cs
â”‚   â”‚   â””â”€â”€ ErrorResponse.cs
â”‚   â””â”€â”€ ViewModels/
â”‚       â”œâ”€â”€ ReservationViewModel.cs
â”‚       â””â”€â”€ RoomAvailabilityViewModel.cs
â”œâ”€â”€ Validators/                       # APIå…¥åŠ›æ¤œè¨¼ï¼ˆHTTPå±¤ï¼‰
â”‚   â”œâ”€â”€ LoginRequestValidator.cs
â”‚   â”œâ”€â”€ CreateReservationRequestValidator.cs
â”‚   â””â”€â”€ RefreshTokenRequestValidator.cs
â”œâ”€â”€ appsettings.json
â”œâ”€â”€ appsettings.Development.json
â”œâ”€â”€ appsettings.Production.json
â”œâ”€â”€ Program.cs
â””â”€â”€ Startup.cs
```

#### 3.4.2 ãƒ—ãƒ©ã‚¤ãƒãƒªãƒ¼ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼å®Ÿè£…ä¾‹ï¼ˆçœŸã®ãƒ˜ã‚­ã‚µã‚´ãƒŠãƒ«ï¼‰

**ReservationsController - REST APIã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼**

```csharp
namespace MRS.Api.Adapters.Controllers.V1
{
    /// <summary>
    /// äºˆç´„ç”¨REST APIã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ï¼ˆãƒ—ãƒ©ã‚¤ãƒãƒªãƒ¼ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ï¼‰
    /// HTTP ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’ãƒ—ãƒ©ã‚¤ãƒãƒªãƒ¼ãƒãƒ¼ãƒˆã«å¤‰æ›
    /// </summary>
    [ApiController]
    [ApiVersion("1.0")]
    [Route("api/v{version:apiVersion}/[controller]")]
    [Authorize]
    public class ReservationsController : BaseApiController
    {
        // ãƒ—ãƒ©ã‚¤ãƒãƒªãƒ¼ãƒãƒ¼ãƒˆã¸ã®ä¾å­˜ï¼ˆãƒ‰ãƒ¡ã‚¤ãƒ³ã¸ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆï¼‰
        private readonly IReservationUseCases _reservationUseCases;

        public ReservationsController(IReservationUseCases reservationUseCases)
        {
            _reservationUseCases = reservationUseCases;
        }

        /// <summary>
        /// HTTP GET â†’ ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹å‘¼ã³å‡ºã—
        /// </summary>
        [HttpGet]
        [ProducesResponseType(typeof(ApiResponse<PagedResult<ReservationResponse>>), StatusCodes.Status200OK)]
        public async Task<IActionResult> GetReservations([FromQuery] GetReservationsRequest request)
        {
            try
            {
                // HTTPå…¥åŠ›ã‚’ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¯ã‚¨ãƒªã«å¤‰æ›
                var query = new GetReservationsQuery
                {
                    RoomId = request.RoomId.HasValue ? RoomId.Of(request.RoomId.Value) : null,
                    UserId = request.UserId.HasValue ? UserId.Of(request.UserId.Value) : null,
                    FromDate = request.FromDate?.ToDateOnly(),
                    ToDate = request.ToDate?.ToDateOnly(),
                    Page = request.Page ?? 1,
                    PageSize = request.PageSize ?? 20
                };

                // ãƒ—ãƒ©ã‚¤ãƒãƒªãƒ¼ãƒãƒ¼ãƒˆçµŒç”±ã§ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹å®Ÿè¡Œ
                var result = await _reservationUseCases.GetReservationsAsync(query);
                
                // ãƒ‰ãƒ¡ã‚¤ãƒ³çµæœã‚’HTTPãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«å¤‰æ›
                var response = new ApiResponse<PagedResult<ReservationResponse>>(
                    result.ToHttpResponse());

                return Ok(response);
            }
            catch (Exception ex)
            {
                return HandleException(ex);
            }
        }

        /// <summary>
        /// HTTP POST â†’ ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹å‘¼ã³å‡ºã—
        /// </summary>
        [HttpPost]
        [ProducesResponseType(typeof(ApiResponse<ReservationResponse>), StatusCodes.Status201Created)]
        [ProducesResponseType(typeof(ErrorResponse), StatusCodes.Status409Conflict)]
        public async Task<IActionResult> CreateReservation([FromBody] CreateReservationRequest request)
        {
            try
            {
                // HTTPèªè¨¼æƒ…å ±ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼IDå–å¾—
                var userId = GetCurrentUserId();

                // HTTPå…¥åŠ›ã‚’ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚³ãƒãƒ³ãƒ‰ã«å¤‰æ›
                var command = new CreateReservationCommand(
                    userId,
                    RoomId.Of(request.RoomId),
                    DateOnly.FromDateTime(request.Date),
                    request.StartTime,
                    request.EndTime,
                    request.Purpose);

                // ãƒ—ãƒ©ã‚¤ãƒãƒªãƒ¼ãƒãƒ¼ãƒˆçµŒç”±ã§ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹å®Ÿè¡Œ
                var result = await _reservationUseCases.CreateReservationAsync(command);

                if (result.IsFailure)
                {
                    // ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼ã‚’HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã«å¤‰æ›
                    return result.ErrorMessage.Contains("äºˆç´„æ¸ˆã¿") 
                        ? Conflict(new ErrorResponse(result.ErrorMessage))
                        : BadRequest(new ErrorResponse(result.ErrorMessage));
                }

                var response = new ApiResponse<ReservationResponse>(
                    result.Value.ToHttpResponse(), "äºˆç´„ãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸ");

                return CreatedAtAction(
                    nameof(GetReservation),
                    new { id = result.Value.Id },
                    response);
            }
            catch (Exception ex)
            {
                return HandleException(ex);
            }
        }

        // ãã®ä»–ã®HTTPãƒ¡ã‚½ãƒƒãƒ‰...
    }
}
```

**CLI ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ï¼ˆå°†æ¥æ‹¡å¼µä¾‹ï¼‰**

```csharp
namespace MRS.Api.Adapters.CLI
{
    /// <summary>
    /// ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ï¼ˆãƒ—ãƒ©ã‚¤ãƒãƒªãƒ¼ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ï¼‰
    /// CLIã‚³ãƒãƒ³ãƒ‰ã‚’ãƒ—ãƒ©ã‚¤ãƒãƒªãƒ¼ãƒãƒ¼ãƒˆã«å¤‰æ›
    /// </summary>
    public class ReservationCliAdapter
    {
        private readonly IReservationUseCases _reservationUseCases;

        public ReservationCliAdapter(IReservationUseCases reservationUseCases)
        {
            _reservationUseCases = reservationUseCases;
        }

        public async Task<int> CreateReservationAsync(string[] args)
        {
            try
            {
                // CLIå¼•æ•°ã‚’ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚³ãƒãƒ³ãƒ‰ã«å¤‰æ›
                var command = ParseCreateReservationCommand(args);
                
                // åŒã˜ãƒ—ãƒ©ã‚¤ãƒãƒªãƒ¼ãƒãƒ¼ãƒˆçµŒç”±ã§ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹å®Ÿè¡Œ
                var result = await _reservationUseCases.CreateReservationAsync(command);
                
                if (result.IsFailure)
                {
                    Console.WriteLine($"ã‚¨ãƒ©ãƒ¼: {result.ErrorMessage}");
                    return 1;
                }

                Console.WriteLine($"äºˆç´„ãŒä½œæˆã•ã‚Œã¾ã—ãŸ: {result.Value.Id}");
                return 0;
            }
            catch (Exception ex)
            {
                Console.WriteLine($"äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼: {ex.Message}");
                return 1;
            }
        }

        private CreateReservationCommand ParseCreateReservationCommand(string[] args)
        {
            // CLIå¼•æ•°ã®ãƒ‘ãƒ¼ã‚¹å‡¦ç†...
        }
    }
}
```

## 4. è¨­å®šãƒ»èµ·å‹•ã‚¯ãƒ©ã‚¹

### 4.1 Program.cs

```csharp
namespace MRS.Api
{
    public class Program
    {
        public static void Main(string[] args)
        {
            var builder = WebApplication.CreateBuilder(args);

            // è¨­å®š
            builder.Services.Configure<DatabaseOptions>(
                builder.Configuration.GetSection("Database"));
            builder.Services.Configure<JwtOptions>(
                builder.Configuration.GetSection("Jwt"));
            builder.Services.Configure<CacheOptions>(
                builder.Configuration.GetSection("Cache"));

            // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
            builder.Services.AddDatabaseServices(builder.Configuration);

            // JWTèªè¨¼
            builder.Services.AddJwtAuthentication(builder.Configuration);

            // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚µãƒ¼ãƒ“ã‚¹
            builder.Services.AddApplicationServices();

            // ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ã‚µãƒ¼ãƒ“ã‚¹
            builder.Services.AddInfrastructureServices();

            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥
            builder.Services.AddCachingServices(builder.Configuration);

            // FluentValidation
            builder.Services.AddFluentValidationAutoValidation();
            builder.Services.AddValidatorsFromAssemblyContaining<CreateReservationRequestValidator>();

            // AutoMapper
            builder.Services.AddAutoMapper(typeof(ReservationMappingProfile));

            // CORS
            builder.Services.AddCorsConfiguration(builder.Configuration);

            // API ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°
            builder.Services.AddApiVersioningConfiguration();

            // Swagger
            builder.Services.AddSwaggerConfiguration();

            // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            builder.Services.AddControllers(options =>
            {
                options.Filters.Add<ValidateModelFilter>();
                options.Filters.Add<PerformanceFilter>();
            });

            // ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
            builder.Services.AddHealthChecks()
                .AddSqlServer(builder.Configuration.GetConnectionString("DefaultConnection"))
                .AddRedis(builder.Configuration.GetConnectionString("Redis"));

            // ãƒ­ã‚°è¨­å®š
            builder.Services.AddLogging(logging =>
            {
                logging.ClearProviders();
                logging.AddConsole();
                logging.AddDebug();
                
                if (builder.Environment.IsProduction())
                {
                    logging.AddApplicationInsights();
                    logging.AddSerilog();
                }
            });

            var app = builder.Build();

            // ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
            if (app.Environment.IsDevelopment())
            {
                app.UseDeveloperExceptionPage();
                app.UseSwagger();
                app.UseSwaggerUI(c =>
                {
                    c.SwaggerEndpoint("/swagger/v1/swagger.json", "MRS API V1");
                    c.RoutePrefix = "api-docs";
                });
            }
            else
            {
                app.UseErrorHandlingMiddleware();
                app.UseHsts();
            }

            app.UseHttpsRedirection();
            app.UseSecurityHeaders();
            app.UseCors("AllowSpecificOrigins");
            app.UseRequestLogging();
            app.UsePerformanceLogging();
            
            app.UseAuthentication();
            app.UseAuthorization();
            
            app.UseRateLimiting();
            
            app.MapControllers();
            app.MapHealthChecks("/health");

            // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–
            if (app.Environment.IsDevelopment())
            {
                using var scope = app.Services.CreateScope();
                var initializer = scope.ServiceProvider.GetRequiredService<DatabaseInitializer>();
                await initializer.InitializeAsync();
            }

            app.Run();
        }
    }
}
```

## 5. ã‚µã‚¤ã‚¯ãƒ­ãƒãƒ†ã‚£ãƒƒã‚¯è¤‡é›‘åº¦åˆ¶å¾¡

### 5.1 è¤‡é›‘åº¦è¨ˆæ¸¬ãƒ»åˆ¶å¾¡æŒ‡é‡

**ã‚µã‚¤ã‚¯ãƒ­ãƒãƒ†ã‚£ãƒƒã‚¯è¤‡é›‘åº¦ã‚’7ä»¥ä¸‹ã«ä¿ã¤ãŸã‚ã®ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³:**

1. **ãƒ¡ã‚½ãƒƒãƒ‰ã®åˆ†å‰²**: è¤‡é›‘ãªå‡¦ç†ã¯è¤‡æ•°ã®ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ¡ã‚½ãƒƒãƒ‰ã«åˆ†å‰²
2. **æˆ¦ç•¥ãƒ‘ã‚¿ãƒ¼ãƒ³**: æ¡ä»¶åˆ†å²ãŒå¤šã„å ´åˆã¯æˆ¦ç•¥ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’é©ç”¨
3. **ã‚¬ãƒ¼ãƒ‰ç¯€**: æ—©æœŸãƒªã‚¿ãƒ¼ãƒ³ã«ã‚ˆã‚‹ãƒã‚¹ãƒˆã®å‰Šæ¸›
4. **ãƒãƒªãƒ¢ãƒ¼ãƒ•ã‚£ã‚ºãƒ **: switchæ–‡ã‚’ãƒãƒªãƒ¢ãƒ¼ãƒ•ã‚£ã‚ºãƒ ã§ç½®æ›
5. **è¨­å®šé§†å‹•**: ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸæ¡ä»¶ã‚’è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã«å¤–å‡ºã—

**ä¾‹: è¤‡é›‘åº¦ã‚’ä¸‹ã’ã‚‹ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°**

```csharp
// âŒ è¤‡é›‘åº¦ãŒé«˜ã„ä¾‹ï¼ˆ10ï¼‰
public async Task<Result> ProcessReservationAsync(CreateReservationCommand command)
{
    if (command == null) return Result.Failure("Invalid command");
    if (string.IsNullOrEmpty(command.UserId)) return Result.Failure("User required");
    if (command.RoomId <= 0) return Result.Failure("Room required");
    if (command.Date < DateOnly.Today) return Result.Failure("Past date not allowed");
    
    var room = await _roomRepository.GetByIdAsync(command.RoomId);
    if (room == null) return Result.Failure("Room not found");
    if (!room.IsActive) return Result.Failure("Room inactive");
    
    var timeSlot = TimeSlot.Create(command.StartTime, command.EndTime);
    if (timeSlot.Duration > TimeSpan.FromHours(8)) return Result.Failure("Too long");
    if (timeSlot.StartTime.Hour < 9 || timeSlot.EndTime.Hour > 18) return Result.Failure("Outside hours");
    
    // ... å‡¦ç†ç¶šè¡Œ
}

// âœ… è¤‡é›‘åº¦ã‚’ä¸‹ã’ãŸä¾‹ï¼ˆ3ï¼‰
public async Task<Result> ProcessReservationAsync(CreateReservationCommand command)
{
    var validationResult = ValidateCommand(command);
    if (validationResult.IsFailure) return validationResult;
    
    var roomValidationResult = await ValidateRoomAsync(command.RoomId);
    if (roomValidationResult.IsFailure) return roomValidationResult;
    
    var timeValidationResult = ValidateTimeSlot(command.StartTime, command.EndTime);
    if (timeValidationResult.IsFailure) return timeValidationResult;
    
    return await CreateReservationInternalAsync(command);
}

private Result ValidateCommand(CreateReservationCommand command) { /* è¤‡é›‘åº¦2 */ }
private async Task<Result> ValidateRoomAsync(RoomId roomId) { /* è¤‡é›‘åº¦3 */ }
private Result ValidateTimeSlot(string startTime, string endTime) { /* è¤‡é›‘åº¦4 */ }
```

### 5.2 é™çš„è§£æãƒ„ãƒ¼ãƒ«è¨­å®š

**`.editorconfig`ã«ã‚µã‚¤ã‚¯ãƒ­ãƒãƒ†ã‚£ãƒƒã‚¯è¤‡é›‘åº¦åˆ¶é™ã‚’è¨­å®š:**

```ini
# .editorconfig
[*.cs]
dotnet_analyzer_rule.CA1502.severity = warning
dotnet_code_quality.CA1502.max_complexity = 7

dotnet_analyzer_rule.S1541.severity = warning
dotnet_code_quality.S1541.threshold = 7
```

ã“ã®æ§‹æˆã«ã‚ˆã‚Šã€RESTful APIã€Dapperã€JWTèªè¨¼ã‚’æ ¸ã¨ã—ãŸé«˜æ€§èƒ½ã§ä¿å®ˆæ€§ã®é«˜ã„C#ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿç¾ã§ãã¾ã™ã€‚å„å±¤ã®è²¬ä»»ãŒæ˜ç¢ºã«åˆ†é›¢ã•ã‚Œã€ã‚µã‚¤ã‚¯ãƒ­ãƒãƒ†ã‚£ãƒƒã‚¯è¤‡é›‘åº¦ã‚‚é©åˆ‡ã«åˆ¶å¾¡ã•ã‚ŒãŸè¨­è¨ˆã¨ãªã£ã¦ã„ã¾ã™ã€‚

## 6. ãƒ˜ã‚­ã‚µã‚´ãƒŠãƒ«ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®ãƒ†ã‚¹ãƒˆæˆ¦ç•¥

### 6.1 ãƒ†ã‚¹ãƒˆãƒ”ãƒ©ãƒŸãƒƒãƒ‰è¨­è¨ˆ

```plantuml
@startuml
!theme plain

rectangle "ãƒ†ã‚¹ãƒˆãƒ”ãƒ©ãƒŸãƒƒãƒ‰" {
  rectangle "E2E Tests\n(å°‘é‡ãƒ»é«˜ä¾¡å€¤)" as e2e #lightcoral
  rectangle "Integration Tests\n(ä¸­é‡ãƒ»ä¸­ä¾¡å€¤)" as integration #lightyellow  
  rectangle "Unit Tests\n(å¤§é‡ãƒ»é«˜é€Ÿ)" as unit #lightgreen
}

e2e -[hidden]-> integration
integration -[hidden]-> unit

note right of e2e
  ãƒ»ã‚·ãƒŠãƒªã‚ªãƒ™ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆ
  ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¸ãƒ£ãƒ¼ãƒ‹ãƒ¼æ¤œè¨¼
  ãƒ»å®Ÿç’°å¢ƒã«è¿‘ã„ãƒ†ã‚¹ãƒˆ
end note

note right of integration
  ãƒ»ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼çµ±åˆãƒ†ã‚¹ãƒˆ
  ãƒ»ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çµ±åˆ
  ãƒ»å¤–éƒ¨APIçµ±åˆ
end note

note right of unit
  ãƒ»ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ãƒ†ã‚¹ãƒˆ
  ãƒ»ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆ
  ãƒ»ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ãƒ†ã‚¹ãƒˆ
end note

@enduml
```

### 6.2 ãƒ˜ã‚­ã‚µã‚´ãƒŠãƒ«å¯¾å¿œãƒ†ã‚¹ãƒˆåˆ†é¡

#### 6.2.1 ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚³ã‚¢ãƒ†ã‚¹ãƒˆï¼ˆUnit Testsï¼‰

**ç›®çš„**: ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã®æ­£ç¢ºæ€§ã‚’ä¿è¨¼

```csharp
namespace MRS.Domain.UnitTests.Models
{
    public class ReservationTests
    {
        [Theory]
        [InlineData("09:00", "10:00", "09:30", "10:30", true)]  // é‡è¤‡ã‚ã‚Š
        [InlineData("09:00", "10:00", "10:00", "11:00", false)] // é‡è¤‡ãªã—
        [InlineData("09:00", "10:00", "08:00", "09:30", true)]  // é‡è¤‡ã‚ã‚Š
        public void OverlapsWith_Given_TimeSlots_Returns_Expected(
            string start1, string end1, string start2, string end2, bool expected)
        {
            // Arrange
            var userId = UserId.Of(Guid.NewGuid());
            var roomId = RoomId.Of(Guid.NewGuid());
            var date = DateOnly.Today;
            
            var reservation1 = new Reservation(userId, roomId, date, 
                TimeSlot.Create(start1, end1));
            var reservation2 = new Reservation(userId, roomId, date, 
                TimeSlot.Create(start2, end2));

            // Act
            var result = reservation1.OverlapsWith(reservation2);

            // Assert
            result.Should().Be(expected);
        }

        [Fact]
        public void Constructor_Given_InvalidTimeSlot_Throws_DomainException()
        {
            // Arrange
            var userId = UserId.Of(Guid.NewGuid());
            var roomId = RoomId.Of(Guid.NewGuid());
            var date = DateOnly.Today;

            // Act & Assert
            Assert.Throws<DomainException>(() => 
                new Reservation(userId, roomId, date, 
                    TimeSlot.Create("09:00", "18:00"))); // 8æ™‚é–“è¶…é
        }
    }
}
```

#### 6.2.2 ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆï¼ˆUnit Tests with Mocksï¼‰

**ç›®çš„**: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ã¨ãƒãƒ¼ãƒˆé€£æºã®æ¤œè¨¼

```csharp
namespace MRS.Application.UnitTests.Services
{
    public class ReservationServiceTests
    {
        private readonly Mock<IReservationRepository> _mockReservationRepo;
        private readonly Mock<IRoomRepository> _mockRoomRepo;
        private readonly Mock<ICacheService> _mockCache;
        private readonly Mock<IUnitOfWork> _mockUnitOfWork;
        private readonly ReservationService _service;

        public ReservationServiceTests()
        {
            _mockReservationRepo = new Mock<IReservationRepository>();
            _mockRoomRepo = new Mock<IRoomRepository>();
            _mockCache = new Mock<ICacheService>();
            _mockUnitOfWork = new Mock<IUnitOfWork>();
            
            _service = new ReservationService(
                _mockReservationRepo.Object,
                _mockRoomRepo.Object,
                _mockCache.Object,
                _mockUnitOfWork.Object,
                new ReservationDomainService(),
                Mock.Of<IMapper>(),
                Mock.Of<ILogger<ReservationService>>());
        }

        [Fact]
        public async Task CreateReservationAsync_Given_ConflictingReservation_Returns_Failure()
        {
            // Arrange
            var command = new CreateReservationCommand(
                UserId.Of(Guid.NewGuid()),
                RoomId.Of(Guid.NewGuid()),
                DateOnly.Today,
                "09:00", "10:00", "ä¼šè­°");

            var existingReservation = new Reservation(
                command.UserId, command.RoomId, command.Date,
                TimeSlot.Create("09:30", "10:30"));

            _mockRoomRepo.Setup(x => x.GetByIdAsync(command.RoomId))
                .ReturnsAsync(new MeetingRoom(command.RoomId, "ä¼šè­°å®¤A"));
            
            _mockReservationRepo.Setup(x => x.GetByRoomAndDateAsync(command.RoomId, command.Date))
                .ReturnsAsync(new[] { existingReservation });

            // Act
            var result = await _service.CreateReservationAsync(command);

            // Assert
            result.IsFailure.Should().BeTrue();
            result.ErrorMessage.Should().Contain("äºˆç´„æ¸ˆã¿");
            
            // ã‚»ã‚«ãƒ³ãƒ€ãƒªãƒ¼ãƒãƒ¼ãƒˆãŒå‘¼ã°ã‚Œã¦ã„ãªã„ã“ã¨ã‚’ç¢ºèª
            _mockReservationRepo.Verify(x => x.SaveAsync(It.IsAny<Reservation>()), Times.Never);
        }
    }
}
```

#### 6.2.3 ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã‚¿ã‚¹ãƒˆï¼ˆIntegration Testsï¼‰

**ç›®çš„**: ã‚»ã‚«ãƒ³ãƒ€ãƒªãƒ¼ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã®å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ é€£æºæ¤œè¨¼

```csharp
namespace MRS.Infrastructure.IntegrationTests.Repositories
{
    public class ReservationRepositoryTests : IClassFixture<DatabaseFixture>
    {
        private readonly DatabaseFixture _fixture;
        private readonly ReservationRepository _repository;

        public ReservationRepositoryTests(DatabaseFixture fixture)
        {
            _fixture = fixture;
            _repository = new ReservationRepository(
                _fixture.ConnectionFactory,
                Mock.Of<ICacheService>(),
                Mock.Of<ILogger<ReservationRepository>>());
        }

        [Fact]
        public async Task SaveAsync_Given_ValidReservation_Persists_Successfully()
        {
            // Arrange
            using var transaction = await _fixture.BeginTransactionAsync();
            
            var reservation = new Reservation(
                UserId.Of(Guid.NewGuid()),
                RoomId.Of(Guid.NewGuid()),
                DateOnly.Today,
                TimeSlot.Create("09:00", "10:00"),
                "ãƒ†ã‚¹ãƒˆä¼šè­°");

            // Act
            await _repository.SaveAsync(reservation);
            var saved = await _repository.GetByIdAsync(reservation.Id);

            // Assert
            saved.Should().NotBeNull();
            saved.Id.Should().Be(reservation.Id);
            saved.TimeSlot.StartTime.Should().Be(TimeOnly.Parse("09:00"));
        }

        [Fact]
        public async Task GetByRoomAndDateWithLockAsync_Given_ConcurrentAccess_Prevents_Conflicts()
        {
            // Arrange & Act & Assert
            // åŒæ™‚ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆã«ã‚ˆã‚‹æ¥½è¦³çš„ãƒ»æ‚²è¦³çš„ãƒ­ãƒƒã‚¯æ¤œè¨¼
        }
    }
}
```

#### 6.2.4 APIçµ±åˆãƒ†ã‚¹ãƒˆï¼ˆIntegration Testsï¼‰

**ç›®çš„**: ãƒ—ãƒ©ã‚¤ãƒãƒªãƒ¼ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã®HTTPå¢ƒç•Œæ¤œè¨¼

```csharp
namespace MRS.Api.IntegrationTests.Controllers
{
    public class ReservationsControllerTests : IClassFixture<WebApplicationFactory<Program>>
    {
        private readonly WebApplicationFactory<Program> _factory;
        private readonly HttpClient _client;

        public ReservationsControllerTests(WebApplicationFactory<Program> factory)
        {
            _factory = factory;
            _client = _factory.CreateClient();
        }

        [Fact]
        public async Task POST_Reservations_Given_ValidRequest_Returns_201_Created()
        {
            // Arrange
            var request = new CreateReservationRequest
            {
                RoomId = Guid.NewGuid(),
                Date = DateTime.Today.AddDays(1),
                StartTime = "09:00",
                EndTime = "10:00",
                Purpose = "ãƒãƒ¼ãƒ ä¼šè­°"
            };

            var jwt = await GetValidJwtTokenAsync();
            _client.DefaultRequestHeaders.Authorization = 
                new AuthenticationHeaderValue("Bearer", jwt);

            // Act
            var response = await _client.PostAsJsonAsync("/api/v1/reservations", request);

            // Assert
            response.StatusCode.Should().Be(HttpStatusCode.Created);
            
            var content = await response.Content.ReadAsStringAsync();
            var result = JsonSerializer.Deserialize<ApiResponse<ReservationResponse>>(content);
            result.Data.Should().NotBeNull();
            result.Data.Purpose.Should().Be("ãƒãƒ¼ãƒ ä¼šè­°");
        }

        [Fact]
        public async Task POST_Reservations_Given_ConflictingTime_Returns_409_Conflict()
        {
            // æ—¢å­˜äºˆç´„ã¨ã®é‡è¤‡ãƒ†ã‚¹ãƒˆ
        }
    }
}
```

#### 6.2.5 ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ†ã‚¹ãƒˆï¼ˆArchitecture Testsï¼‰

**ç›®çš„**: ãƒ˜ã‚­ã‚µã‚´ãƒŠãƒ«ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®ä¾å­˜é–¢ä¿‚åˆ¶ç´„æ¤œè¨¼

```csharp
namespace MRS.ArchitectureTests
{
    public class HexagonalArchitectureTests
    {
        [Fact]
        public void Domain_Should_Not_Depend_On_Infrastructure()
        {
            // Arrange
            var domainAssembly = typeof(Reservation).Assembly;
            var infrastructureAssembly = typeof(ReservationRepository).Assembly;

            // Act & Assert
            var result = Types.InAssembly(domainAssembly)
                .Should()
                .NotHaveDependencyOn(infrastructureAssembly.GetName().Name);

            result.GetResult().IsSuccessful.Should().BeTrue();
        }

        [Fact]
        public void Application_Should_Only_Depend_On_Domain()
        {
            // Arrange & Act & Assert
            var result = Types.InAssembly(typeof(ReservationService).Assembly)
                .Should()
                .OnlyHaveDependenciesOn(
                    "MRS.Domain",
                    "System",
                    "Microsoft",
                    "AutoMapper",
                    "FluentValidation");

            result.GetResult().IsSuccessful.Should().BeTrue();
        }

        [Fact]
        public void Controllers_Should_Only_Depend_On_Application_Ports()
        {
            // ãƒ—ãƒ©ã‚¤ãƒãƒªãƒ¼ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ãŒãƒ—ãƒ©ã‚¤ãƒãƒªãƒ¼ãƒãƒ¼ãƒˆã®ã¿ã«ä¾å­˜ã™ã‚‹ã“ã¨ã‚’æ¤œè¨¼
            var result = Types.InAssembly(typeof(ReservationsController).Assembly)
                .That().ResideInNamespace("MRS.Api.Controllers")
                .Should()
                .OnlyHaveDependenciesOn(
                    "MRS.Application.Ports",
                    "MRS.Application.DTOs",
                    "System",
                    "Microsoft");

            result.GetResult().IsSuccessful.Should().BeTrue();
        }
    }
}
```

#### 6.2.6 å¥‘ç´„ãƒ†ã‚¹ãƒˆï¼ˆContract Testsï¼‰

**ç›®çš„**: APIä»•æ§˜ã¨OpenAPIå¥‘ç´„ã®æ•´åˆæ€§æ¤œè¨¼

```csharp
namespace MRS.ContractTests
{
    public class OpenApiContractTests
    {
        [Fact]
        public async Task API_Should_Match_OpenAPI_Specification()
        {
            // OpenAPIä»•æ§˜ã¨å®Ÿè£…ã®æ•´åˆæ€§ã‚’æ¤œè¨¼
            var factory = new WebApplicationFactory<Program>();
            var client = factory.CreateClient();

            var swaggerDoc = await client.GetStringAsync("/swagger/v1/swagger.json");
            var apiSpec = OpenApiDocument.Parse(swaggerDoc);

            // ã‚¹ã‚­ãƒ¼ãƒæ¤œè¨¼ã€ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆæ¤œè¨¼ç­‰
            apiSpec.Paths.Should().ContainKey("/api/v1/reservations");
        }
    }
}
```

### 6.3 ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæˆ¦ç•¥

#### 6.3.1 ç¶™ç¶šçš„ã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

```yaml
# .github/workflows/test.yml
name: Test Strategy

on: [push, pull_request]

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Unit Tests
        run: dotnet test tests/Unit/ --configuration Release
        
  integration-tests:
    runs-on: ubuntu-latest
    services:
      sqlserver:
        image: mcr.microsoft.com/mssql/server:2022-latest
    steps:
      - name: Integration Tests
        run: dotnet test tests/Integration/ --configuration Release
        
  architecture-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Architecture Tests
        run: dotnet test tests/Architecture/ --configuration Release
```

#### 6.3.2 ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™

- **ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤**: 100% ï¼ˆãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã®å®Œå…¨æ€§ï¼‰
- **ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤**: 95% ï¼ˆãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã®ç¶²ç¾…æ€§ï¼‰
- **ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£å±¤**: 80% ï¼ˆæŠ€è¡“çš„å®Ÿè£…ã®æ¤œè¨¼ï¼‰
- **APIå±¤**: 90% ï¼ˆã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ä¿¡é ¼æ€§ï¼‰

ã“ã®ãƒ†ã‚¹ãƒˆæˆ¦ç•¥ã«ã‚ˆã‚Šã€ãƒ˜ã‚­ã‚µã‚´ãƒŠãƒ«ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®åˆ©ç‚¹ã‚’æœ€å¤§é™ã«æ´»ç”¨ã—ãŸã€å“è³ªã®é«˜ã„ã‚·ã‚¹ãƒ†ãƒ ã‚’æ§‹ç¯‰ã§ãã¾ã™ã€‚
