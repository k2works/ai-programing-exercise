# アプリケーション技術方針の更新（MyBatis/JWT/Cucumber）

日付: 2025-08-29

## ステータス

2025-08-29 採択済み

## コンテキスト

- 既存計画/設計（docs/design/アプリケーション構成.md）に基づき、以下の要請がある。
  - データアクセスを JPA/Hibernate から MyBatis へ変更したい（SQL の可視性・制御性、`SELECT ... FOR UPDATE` など悲観的ロックの明示化、性能/チューニング容易性）
  - 認証はセッション/フォームから JWT に変更し、API を Stateless にしたい（SPA/モバイル対応、スケーラビリティ、境界の明確化）
  - API のエンドツーエンドテストは Cucumber（Gherkin）でビジネス言語ベースに統一したい
- 非機能要件では、性能/可用性/セキュリティ/運用の基準が定められており、データ移行と品質ゲートを維持する必要がある。
- 既存の Flyway ベースのDB移行運用や、ヘキサゴナルアーキテクチャ（Ports & Adapters）は継続前提。

## 決定

1) 永続化（Persistence）
- 採用: MyBatis（`org.mybatis.spring.boot:mybatis-spring-boot-starter`）
- 方針:
  - `infrastructure/out/persistence/mybatis` にアダプタを配置、MapperインターフェースとXMLでクエリ管理
  - ロック制御は SQL で明示（例: `SELECT ... FOR UPDATE`）
  - `mybatis.mapper-locations=classpath:/mybatis/mappers/*.xml`
  - `mybatis.type-aliases-package=mrs.application.domain.model`
  - 開発DB: H2(PostgreSQLモード) / 本番: PostgreSQL、Flywayで版管理を継続

2) 認証/認可（Security）
- 採用: Spring Security + JWT（Stateless）
- 方針:
  - アクセス/リフレッシュトークン方式、roles をクレームに含める
  - dev: HS256（環境変数 `JWT_SECRET`）、prd: RS256（JWK Set URI）
  - `OncePerRequestFilter` で Bearer 検証し `SecurityContext` 構築
  - API は `SessionCreationPolicy.STATELESS`、API系CSRFは無効
  - エンドポイント: `POST /api/auth/login`, `POST /api/auth/refresh`、保護API（例: `/api/rooms`, `/api/reservations`）

3) テスト（Testing）
- 採用: Cucumber による API E2E テスト
- 方針:
  - Gherkin の Background でログイン→JWT取得→以降 Authorization: Bearer 付与
  - HTTP クライアントは RestAssured（または MockMvc）
  - データ準備は Flyway もしくは Testcontainers + マイグレーション
  - CI ではユニット/統合を先行、E2E を後段ゲートに配置

## 影響

メリット:
- SQL の可視性・制御性が向上し、クエリ最適化とロック戦略の明示が可能
- JWT により API 境界の独立性が高まり、水平スケール/クライアント多様化に対応
- Cucumber によるビジネス言語ベースのE2Eで仕様意図の可視化/回 regressions の早期検出

デメリット/リスク:
- MyBatis のXML/クエリ保守コスト、Mapper/DTO の整合性管理が必要
- JWT 鍵/失効管理（キー回転、リフレッシュ/リボーク）と時刻同期の運用負担
- 認証導線変更に伴うクライアント（UI/テスト）の対応が必要

代替案:
- JPA/Hibernate 継続 + 悲観ロック（EntityManager）: ドメイン駆動との親和性は高いが、クエリの細粒制御/方言最適化は相対的に難
- セッションベース認証: 状態管理/スケール要件に不利
- Postman/HTTP系E2E: 非技術者の可読性が Cucumber 比で低下しやすい

## コンプライアンス

この決定が遵守されていることの確認方法:
- Gradle 依存に MyBatis/JJWT または Resource Server が追加されている
- `application*.properties` に MyBatis と JWT の設定キーが存在
- セキュリティ設定が Stateless で、JWT フィルタ（`OncePerRequestFilter`）が組み込まれている
- `infrastructure/out/persistence/mybatis` と `resources/mybatis/mappers` に実装/マッパーが配置
- Cucumber の features/ と stepdefs/ が存在し、Background でトークン取得を実施
- CI パイプラインでユニット/統合/E2E がゲート化され、全てパスしている

## 備考

- 参照:
  - docs/design/アプリケーション構成.md
  - docs/design/アーキテクチャ.md
  - docs/requirements/仕様.md, docs/requirements/リリース計画.md
- 実装メモ:
  - 主要エンティティのMapper整備（User, MeetingRoom, ReservableRoom, Reservation）
  - 予約重複判定はドメインロジック（`Reservation#overlap`）を維持
  - キー管理（dev: 環境変数/ファイル、prd: JWK / KMS 連携）とログ/監査の強化
