# ADR-001: ヘキサゴナルアーキテクチャの採用

会議室予約システム（MRS）にヘキサゴナルアーキテクチャ（Ports and Adapters）を採用する

日付: 2025-08-29

## ステータス

2025-08-29 採用されました

## コンテキスト

会議室予約システム（MRS）の開発において、以下の要件を満たすアーキテクチャが必要：

- 保守性と拡張性の確保
- テスタビリティの向上
- ビジネスロジックの外部技術からの独立
- API-Firstアプローチ（RESTful API提供）
- C#/.NET 9使用
- 複数のデータベース対応（開発環境と本番環境での差異対応）

## 決定

**ヘキサゴナルアーキテクチャ（Ports and Adapters パターン）を採用する**

### 採用理由

1. **テスタビリティの向上**
   - ドメインロジックの完全な単体テスト可能
   - モックによる外部依存の排除
   - 各層の独立したテスト戦略

2. **技術非依存性**
   - フレームワークやライブラリに縛られない設計
   - データベース技術の交換可能性
   - UI技術の将来的な追加・変更対応

3. **明確な責務分離**
   - ドメイン：ビジネスロジックに専念
   - アプリケーション：ユースケース調整
   - インフラストラクチャ：技術的実装
   - プレゼンテーション：外部インターフェース

4. **拡張性の確保**
   - 新しいアダプターの追加が容易
   - 外部システム連携の段階的実装
   - マイクロサービス化への移行可能性

## 実装アプローチ

### プロジェクト構成
```
src/
├── MRS.Domain/          # ドメイン層（外部依存なし）
├── MRS.Application/     # アプリケーション層（ドメインのみ依存）
├── MRS.Infrastructure/  # インフラストラクチャ層（セカンダリーアダプター）
└── MRS.Api/            # プレゼンテーション層（プライマリーアダプター）
```

### ポート定義
- **プライマリーポート**: `IReservationUseCases`, `IAuthenticationUseCases`
- **セカンダリーポート**: `IReservationRepository`, `ICacheService`, `ITokenProvider`

### アダプター実装
- **プライマリーアダプター**: REST API Controller, CLI（将来）
- **セカンダリーアダプター**: Dapper Repository, JWT Provider, Redis Cache

## 影響

### 正の影響
1. **品質向上**
   - 高いテストカバレッジの実現
   - バグの早期発見と修正
   - コードレビューの効率化

2. **保守性向上**
   - 技術的負債の軽減
   - 機能追加・変更の影響範囲限定
   - 開発者オンボーディングの容易さ

3. **拡張性確保**
   - 新技術導入の柔軟性
   - 段階的なシステム拡張
   - 将来的なアーキテクチャ進化

### 負の影響・リスク
1. **初期開発コスト**
   - アーキテクチャ設計時間の増加
   - インターフェース定義の工数
   - 開発者学習コストの発生

2. **複雑性の増加**
   - プロジェクト構造の複雑化
   - 抽象化レイヤーの増加
   - 新規開発者の理解コスト

### リスク軽減策
- 包括的なドキュメント作成
- アーキテクチャテストによる制約強化
- ペアプログラミングによる知識共有
- 段階的実装による学習曲線の緩和

## コンプライアンス

この決定が遵守されていることを確認する方法：

### 自動検証
```csharp
[Fact]
public void Domain_Should_Not_Depend_On_Infrastructure()
{
    var result = Types.InAssembly(typeof(Reservation).Assembly)
        .Should()
        .NotHaveDependencyOn("MRS.Infrastructure");
    
    result.GetResult().IsSuccessful.Should().BeTrue();
}
```

### 手動検証
- コードレビューでの依存関係チェック
- アーキテクチャ図との整合性確認
- 新機能追加時の設計原則遵守確認

### 計測指標
- テストカバレッジ：ドメイン層100%、アプリケーション層95%
- サイクロマティック複雑度：メソッド単位で7以下
- 依存関係違反：0件

## 備考

- **著者**: GitHub Copilot (AI Assistant)
- **レビュー者**: 開発チーム
- **関連ADR**: 
  - ADR-002: Dapper採用理由
  - ADR-003: JWT認証戦略
  - ADR-004: テスト戦略
- **参考資料**: 
  - "Ports and Adapters" by Alistair Cockburn
  - "Clean Architecture" by Robert C. Martin
  - docs/design/アーキテクチャ.md
  - docs/design/アプリケーション構成.md
