# アプリケーション設計

このぷよぷよアプリケーションの設計は、状態遷移モデル（ステートマシン）を中心に構築されています。`Game`クラスが持つ`GameMode`が状態を表し、ゲームの状況に応じて状態が遷移することで、複雑なゲームフローを制御しています。

## 状態遷移設計 (GameMode)

`Game`クラスの`loop`メソッドは、`GameMode`を`switch`文で評価し、現在の状態に応じた処理を実行します。この状態遷移がゲームの心臓部です。

```
+-----------------+      +-----------------+      +-----------------+
|    checkFall    |----->|      fall       |----->|   checkErase    |
+-----------------+      +-----------------+      +-----------------+
        ^                         |                        |
        |                         |                        |
        |                         v                        v
+-----------------+      +-----------------+      +-----------------+
|     erasing     |<-----|   (eraseInfo)   |      |     newPuyo     |
+-----------------+      +-----------------+      +-----------------+
        ^                                                  |
        |                                                  |
        |                                                  v
+-----------------+      +-----------------+      +-----------------+
|       fix       |<-----|     playing     |----->| moving/rotating |
+-----------------+      +-----------------+      +-----------------+
```

### 主要な状態と役割

-   **`checkFall`**: 盤面上に浮いているぷよがないか`Stage.checkFall()`で確認します。あれば`fall`へ、なければ`checkErase`へ遷移します。連鎖の起点となる重要な状態です。
-   **`fall`**: `Stage.fall()`を呼び出し、ぷよを1フレーム分落下させます。すべてのぷよの落下が完了したら`checkErase`へ遷移します。
-   **`checkErase`**: `Stage.checkErase()`で4つ以上繋がったぷよがないか確認します。あれば`erasing`へ、なければ`newPuyo`へ遷移します。全消し判定もこの状態で行われます。
-   **`erasing`**: `Stage.erasing()`を呼び出し、ぷよの消去アニメーションを実行します。アニメーション完了後、新たな連鎖の可能性をチェックするため`checkFall`へ戻ります。
-   **`newPuyo`**: `Player.createNewPuyo()`で新しい操作ぷよを生成します。生成に成功すれば`playing`へ、失敗すれば（ぷよを置くスペースがない場合）`gameOver`へ遷移します。
-   **`playing`**: プレイヤーの入力を待ち受ける基本状態です。`Player.playing()`が入力に応じて`moving`や`rotating`への遷移を決定します。また、ぷよの自然落下もこの状態で処理されます。
-   **`moving` / `rotating`**: プレイヤーの操作によるぷよの移動・回転アニメーションを実行します。完了すると`playing`へ戻ります。
-   **`gameOver` / `batankyu`**: ゲームオーバー演出を実行し、リスタート入力を待ち受けます。

## ぷよの判定ロジック設計

### 接続判定 (`Stage.checkConnections`)

-   **目的**: 指定された座標のぷよと同じ色のぷよが、上下左右にいくつ繋がっているかを判定します。
-   **アルゴリズム**: 幅優先探索（BFS）を用いて実装されています。
    1.  判定開始座標をキューに追加します。
    2.  キューから座標を取り出し、接続リストに追加します。
    3.  取り出した座標の上下左右を調べ、同じ色で未訪問のぷよがあればキューに追加します。
    4.  キューが空になるまでこれを繰り返し、最終的に接続リストを返します。

### 消去判定 (`Stage.checkErase`)

-   **目的**: 盤面全体をスキャンし、消去対象となるぷよのグループを特定します。
-   **アルゴリズム**:
    1.  盤面を左上から右下へ走査します。
    2.  まだチェックしていないぷよを見つけたら、`checkConnections`を呼び出して接続しているぷよのリストを取得します。
    3.  接続数が消去条件（デフォルトは4つ）を満たしていれば、そのグループを消去リスト (`erasingPuyoInfoList`) に追加し、盤面データ (`board`) からは`null`を設定して削除します。
    4.  一度チェックしたぷよは、`checkedPuyos`フラグで管理し、再チェックを防ぎます。

この設計により、状態管理とロジックが明確に分離され、各クラスの責務が単一に保たれています。特に、ゲームループにおける状態遷移は、ぷよぷよの複雑なルール（落下→消去→連鎖→落下...）をうまく表現しています。
