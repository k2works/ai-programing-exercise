# 要件定義書

## はじめに

花束管理システムは、フラワーショップ「フレール・メモワール」のWEB事業を管理するための包括的なWebアプリケーションです。本システムは、得意先の注文、花の単品在庫管理、仕入先との関係、出荷業務を扱います。ビジネスモデルの核心は、賞味期限のある個別の花（単品）から花束を作成することであり、廃棄を最小限に抑えながら指定日に新鮮な花を届けるための慎重な在庫管理が必要です。

## 用語集

- **システム**: 花束管理システム
- **ユーザー**: システムを利用するすべての人（得意先またはスタッフ）
- **得意先**: WEBショップを通じて商品を購入する個人
- **スタッフ**: 受注、在庫、仕入先を含む業務を管理する従業員
- **商品**: 販売可能な事前定義された花束の構成
- **単品**: 商品を作成するために使用される個別の花の構成要素
- **注文**: 得意先による商品購入と配送詳細のリクエスト
- **受注**: スタッフが処理のために受け付けた注文
- **在庫**: 倉庫で利用可能な単品の現在の在庫
- **仕入先**: ショップに単品を提供する業者
- **リードタイム**: 発注後に単品が到着するまでに必要な日数
- **品質維持可能日数**: 入荷後に単品が使用可能な最大日数
- **発注**: 仕入先に送信される単品の購買注文
- **出荷**: 得意先に商品を配送するプロセス
- **カート**: 得意先が注文する予定の商品の一時的なコレクション
- **ロット**: 特定の有効期限を持つ仕入先から受け取った単品のバッチ

## 要件

### 要件1: ユーザー認証

**ユーザーストーリー:** ユーザーとして、自分の認証情報でシステムに安全にアクセスしたい。そうすることで、自分のアカウントとデータが保護される。

#### 受入基準

1. WHEN ユーザーが有効な認証情報を提供する THEN システムはユーザーを認証してアクセスを許可する
2. WHEN ユーザーが無効な認証情報を提供する THEN システムは認証試行を拒否してエラーメッセージを表示する
3. WHEN 認証済みユーザーが30分間非アクティブのまま THEN システムはセッションを自動的に終了する
4. システムは業界標準のハッシュアルゴリズムを使用してすべてのパスワードデータを暗号化する
5. WHEN ユーザーがログアウトする THEN システムは現在のセッションを即座に無効化する

### 要件2: ユーザー登録と管理

**ユーザーストーリー:** スタッフとして、ユーザーアカウントを管理したい。そうすることで、システムアクセスを制御し、ユーザー情報を維持できる。

#### 受入基準

1. WHEN スタッフが新しいユーザーを登録する THEN システムは一意の識別子、名前、パスワード、役割、ユーザー区分を持つユーザーアカウントを作成する
2. WHEN スタッフがユーザー情報を更新する THEN システムは変更を永続化し、監査証跡を維持する
3. WHEN スタッフがユーザーアカウントを無効化する THEN システムはアカウントデータを保持しながらユーザーの認証を防止する
4. WHEN スタッフが無効化されたアカウントを再有効化する THEN システムはユーザーへの完全なアクセスを復元する
5. WHEN スタッフがユーザーアカウントを完全に削除する THEN システムはすべてのユーザーデータをシステムから削除する

### 要件3: 商品登録と管理

**ユーザーストーリー:** スタッフとして、商品を登録・管理したい。そうすることで、得意先が利用可能な花束を閲覧・購入できる。

#### 受入基準

1. WHEN スタッフが商品を登録する THEN システムはコード、名称、区分、販売単価、仕入単価、税区分を持つ商品レコードを作成する
2. WHEN スタッフが商品情報を更新する THEN システムは変更を即座に永続化する
3. WHEN スタッフが単品を商品に関連付ける THEN システムは単品識別子と必要数量を含む構成を保存する
4. システムはすべての商品にわたって一意の商品コードを強制する
5. WHEN スタッフが商品を照会する THEN システムは関連するすべての単品を含む商品詳細を表示する

### 要件4: 商品販売管理

**ユーザーストーリー:** スタッフとして、商品の販売可否を制御したい。そうすることで、得意先が注文できる商品を管理できる。

#### 受入基準

1. WHEN スタッフが商品の販売を停止する THEN システムは得意先が商品をカートに追加することを防止する
2. WHEN スタッフが停止した商品の販売を再開する THEN システムは得意先が商品をカートに追加することを許可する
3. WHEN スタッフが商品の販売を終了する THEN システムは得意先向け表示から商品を完全に削除する
4. システムは販売中ステータスの商品のみを得意先に表示する
5. WHEN 商品に保留中の注文がある THEN システムはすべての注文が履行されるまで販売終了を防止する

### 要件5: 得意先の商品閲覧とカート管理

**ユーザーストーリー:** 得意先として、商品を閲覧してカートに追加したい。そうすることで、購入前に注文を準備できる。

#### 受入基準

1. WHEN 得意先が商品一覧を表示する THEN システムは販売中ステータスのすべての商品を表示する
2. WHEN 得意先が商品を選択する THEN システムは名称、価格、説明、構成を含む詳細情報を表示する
3. WHEN 得意先が商品をカートに追加する THEN システムは数量と配送設定を持つ商品を保存する
4. WHEN 得意先がカートから商品を削除する THEN システムはカートから商品を即座に削除する
5. WHEN 得意先がカート内容を変更する THEN システムはカート合計金額をリアルタイムで更新する

### 要件6: 注文の配置

**ユーザーストーリー:** 得意先として、商品の注文を配置したい。そうすることで、希望する配送日に花束を受け取れる。

#### 受入基準

1. WHEN 得意先が注文を送信する THEN システムは注文日、得意先情報、希望配送日、配送先住所、配送メッセージ、電話番号を持つ注文レコードを作成する
2. WHEN 得意先が注文を送信する THEN システムは指定数量の1種類の商品のみを受け付ける
3. WHEN 注文が作成される THEN システムは出荷日を配送日の1日前として計算する
4. システムは希望配送日が注文日の少なくとも2日後であることを検証する
5. WHEN 注文が送信される THEN システムは得意先のカートを即座にクリアする

### 要件7: 注文処理と引当

**ユーザーストーリー:** スタッフとして、受注を処理して在庫を引き当てたい。そうすることで、得意先の注文を効率的に履行できる。

#### 受入基準

1. WHEN スタッフが受注を確認する THEN システムは得意先情報、商品、数量、希望配送日を含む注文詳細を表示する
2. WHEN スタッフが注文に在庫を引き当てる THEN システムは利用可能な在庫から必要な単品を予約する
3. IF 十分な在庫が存在する THEN システムは注文を引当済みとしてマークし、出荷日を計算する
4. IF 在庫が不足している THEN システムは不足を示し、注文確認を防止する
5. WHEN 注文が完全に引き当てられる THEN システムは得意先に注文確認通知を送信する

### 要件8: 注文の変更

**ユーザーストーリー:** 得意先として、注文の配送日を変更したい。そうすることで、変化する状況に対応できる。

#### 受入基準

1. WHEN 得意先が注文変更を要求する THEN システムは現在の注文詳細を表示する
2. WHEN 得意先が配送日を変更する THEN システムは新しい日付が履行に十分なリードタイムを許可することを検証する
3. IF 変更が実行可能 THEN システムは注文を更新し、出荷日を再計算する
4. IF 変更が実行不可能 THEN システムは理由とともに得意先に即座に通知する
5. WHEN 注文が出荷済み THEN システムは注文へのすべての変更を防止する

### 要件9: 注文のキャンセル

**ユーザーストーリー:** 得意先として、注文をキャンセルしたい。そうすることで、不要な購入を避けられる。

#### 受入基準

1. WHEN 得意先が注文キャンセルを要求する THEN システムは注文が出荷されていないことを検証する
2. IF 注文が出荷されておらず発注が存在しない THEN システムは注文をキャンセルし、得意先に通知する
3. IF 注文が出荷されていないが発注が存在する THEN システムは発注のキャンセルを試みる
4. IF 発注キャンセルが成功する THEN システムは得意先注文をキャンセルし、得意先に通知する
5. IF 注文が出荷済みまたは発注がキャンセルできない THEN システムはキャンセルを拒否し、得意先に通知する

### 要件10: 単品と仕入先の管理

**ユーザーストーリー:** スタッフとして、単品と仕入先を管理したい。そうすることで、商品のサプライチェーンを維持できる。

#### 受入基準

1. WHEN スタッフが単品を登録する THEN システムはコード、名称、仕入先、品質維持可能日数、リードタイム、購入単位数量を持つ単品レコードを作成する
2. WHEN スタッフが仕入先を登録する THEN システムはコード、名称、連絡先情報を持つ仕入先レコードを作成する
3. WHEN スタッフが単品情報を更新する THEN システムは変更を永続化し、商品との参照整合性を維持する
4. システムは一意の単品コードと仕入先コードを強制する
5. WHEN スタッフが単品を照会する THEN システムは関連する仕入先と品質維持可能日数を含む単品詳細を表示する

### 要件11: 在庫追跡

**ユーザーストーリー:** スタッフとして、ロットと日付別に在庫レベルを追跡したい。そうすることで、在庫の鮮度と可用性を管理できる。

#### 受入基準

1. WHEN 単品が入荷される THEN システムは商品番号、ロット番号、数量、入荷日を持つ在庫レコードを作成する
2. WHEN 単品が注文に引き当てられる THEN システムは特定のロットの利用可能在庫数量を減少させる
3. WHEN 現在日が単品の品質維持可能日数を超える THEN システムはロットを期限切れとしてマークし、利用可能在庫から除外する
4. システムは各単品のすべての期限切れでないロットの合計として利用可能在庫を計算する
5. WHEN スタッフが在庫を照会する THEN システムは現在数量、ロット番号、入荷日、有効期限を表示する

### 要件12: 在庫推移

**ユーザーストーリー:** スタッフとして、時間経過に伴う予測在庫レベルを表示したい。そうすることで、情報に基づいた購買決定ができる。

#### 受入基準

1. WHEN スタッフが在庫推移を要求する THEN システムは各単品の日次予測数量を計算する
2. システムは推移に現在在庫、保留中の入荷、引当済み数量を含める
3. システムは将来の可用性を計算する際に単品の有効期限を考慮する
4. システムは設定可能な日数の日次タイムライン形式で推移を表示する
5. WHEN 予測在庫がいずれかの日付でゼロを下回る THEN システムは不足を強調表示する

### 要件13: 発注の作成

**ユーザーストーリー:** スタッフとして、単品の発注を作成したい。そうすることで、仕入先から在庫を補充できる。

#### 受入基準

1. WHEN スタッフが発注を作成する THEN システムは発注日、仕入先、希望配送日、明細行を記録する
2. WHEN スタッフが発注に単品を追加する THEN システムは各単品の購入単位数量を強制する
3. システムは配送日が発注日の少なくともリードタイム日数後であることを検証する
4. WHEN 発注が送信される THEN システムは予想入荷を反映するように在庫推移を更新する
5. システムは単品コストと適用税を含む合計注文金額を計算する

### 要件14: 単品の入荷と検収

**ユーザーストーリー:** スタッフとして、仕入先から単品を入荷・検収したい。そうすることで、在庫に追加する前に品質を確保できる。

#### 受入基準

1. WHEN スタッフが単品を入荷する THEN システムは入荷日、仕入先、明細行を持つ入荷レコードを作成する
2. WHEN スタッフが入荷した単品を検収する THEN システムは各明細行の受入または拒否を許可する
3. IF 単品が受入される THEN システムは新しいロット番号と入荷日で単品を在庫に追加する
4. IF 単品が拒否される THEN システムは返品レコードを作成し、仕入先に代替品を要求する
5. WHEN 単品が在庫に追加される THEN システムは会計目的で仕入レコードを作成する

### 要件15: 出荷準備

**ユーザーストーリー:** スタッフとして、注文の出荷を準備したい。そうすることで、商品を時間通りに得意先に配送できる。

#### 受入基準

1. WHEN スタッフが出荷を準備する THEN システムは各注文に必要な単品を示すピッキングリストを生成する
2. システムは倉庫業務を最適化するために単品別にピッキングリストを整理する
3. WHEN スタッフがピッキングを確認する THEN システムはピッキングされた単品の在庫数量を減少させる
4. WHEN スタッフが単品から商品を組み立てる THEN システムは商品構成に基づいて組立指示書を生成する
5. システムは出荷確認を許可する前にすべての必要な単品が利用可能であることを検証する

### 要件16: 出荷の実行

**ユーザーストーリー:** スタッフとして、出荷を実行したい。そうすることで、得意先が予定配送日に注文を受け取れる。

#### 受入基準

1. WHEN スタッフが出荷を実行する THEN システムは出荷日、得意先、明細行を持つ出荷レコードを作成する
2. WHEN 出荷が実行される THEN システムは会計目的で対応する売上レコードを作成する
3. WHEN 出荷が完了する THEN システムは追跡情報を含む出荷通知を得意先に送信する
4. システムは出荷が実行されたときに関連する注文を履行済みとしてマークする
5. システムは出荷日が予定日と一致しない場合、出荷実行を防止する

### 要件17: 商品の返品

**ユーザーストーリー:** スタッフとして、商品の返品を処理したい。そうすることで、得意先の苦情を処理し、満足度を維持できる。

#### 受入基準

1. WHEN 得意先が商品を返品する THEN システムは元の注文にリンクされた返品レコードを作成する
2. WHEN スタッフが返品を処理する THEN システムは売上取引を取り消し、会計レコードを更新する
3. WHEN 返品が処理される THEN システムは返品された単品を廃棄物としてマークし、在庫から除外する
4. システムは30日より古い注文の返品を防止する
5. WHEN 返品が完了する THEN システムは得意先に返品確認を送信する

### 要件18: 得意先管理

**ユーザーストーリー:** スタッフとして、得意先情報を管理したい。そうすることで、関係を維持し、リピート注文を促進できる。

#### 受入基準

1. WHEN スタッフが得意先を登録する THEN システムはコード、名称、連絡先情報、クレジットカード詳細を持つ得意先レコードを作成する
2. WHEN スタッフが得意先情報を更新する THEN システムは変更を永続化し、データ整合性を維持する
3. WHEN 得意先が複数の注文を配置する THEN システムは以前の注文から配送情報をコピーすることを許可する
4. システムはすべての得意先にわたって一意の得意先コードを強制する
5. WHEN スタッフが得意先を照会する THEN システムは得意先詳細と注文履歴を表示する

### 要件19: 仕入先管理

**ユーザーストーリー:** スタッフとして、仕入先情報を管理したい。そうすることで、サプライチェーン関係を維持できる。

#### 受入基準

1. WHEN スタッフが仕入先を登録する THEN システムはコード、名称、連絡先情報を持つ仕入先レコードを作成する
2. WHEN スタッフが仕入先情報を更新する THEN システムは変更を永続化し、単品との参照整合性を維持する
3. WHEN スタッフが仕入先を無効化する THEN システムは履歴データを保持しながら新しい発注を防止する
4. WHEN スタッフが仕入先を再有効化する THEN システムは新しい発注を許可する
5. システムはすべての仕入先にわたって一意の仕入先コードを強制する

### 要件20: データのシリアライゼーションと永続化

**ユーザーストーリー:** システム管理者として、すべてのデータが確実に保存・取得されることを望む。そうすることで、データ損失なくビジネス運用を継続できる。

#### 受入基準

1. WHEN システムがエンティティをデータベースに保存する THEN システムは設定されたデータベース形式を使用してデータをシリアライズする
2. WHEN システムがエンティティをデータベースから取得する THEN システムはデータを正しいオブジェクト型にデシリアライズする
3. システムはすべてのエンティティ関係にわたって参照整合性を維持する
4. WHEN データベーストランザクションが失敗する THEN システムはすべての変更をロールバックし、データ一貫性を維持する
5. システムはデータベースに永続化する前にすべてのデータ制約を検証する
