# 要件定義書

## はじめに

本書は会議室予約システム（MRS）の要件を定義する。本システムは、Webインターフェースを通じて会議室の予約と管理を効率的に行い、二重予約を防止し、会議室の空き状況を可視化する。本システムは2つのユーザー役割をサポートする：自分の予約を作成・キャンセルできる会員と、すべての予約とシステムデータを管理する管理権限を持つスタッフである。

## 用語集

- **MRS**: 会議室予約システム - 本仕様書で定義されるソフトウェアシステム
- **会員**: 空き会議室の検索、予約の作成、自分の予約のキャンセルができる登録済みユーザー
- **スタッフ**: 会員のすべての機能に加え、任意のユーザーの予約をキャンセルし、システムデータを管理できる管理者ユーザー
- **ゲスト**: 公開情報の閲覧と問い合わせの送信ができる未認証の訪問者
- **予約**: 特定の会議室を特定の時間帯にユーザーに関連付ける予約記録
- **予約可能会議室**: 特定の日付に予約可能として設定された会議室
- **会議室**: ユーザーが予約できる物理的な部屋リソース
- **時間枠**: 予約スケジューリングに使用される30分単位の時間
- **セッション**: 認証済みユーザーのシステムへのアクティブな接続
- **悲観的ロック**: 同じリソースへの同時変更を防ぐデータベースロック機構

## 要件

### 要件1: ユーザー認証

**ユーザーストーリー:** 会員として、自分の認証情報でシステムに安全にログインし、予約機能にアクセスして予約を管理したい。

#### 受入基準

1. WHEN 会員が有効な認証情報を送信する THEN MRSは利用者を認証してセッションを確立する
2. WHEN 会員が無効な認証情報を送信する THEN MRSは認証試行を拒否してエラーメッセージを表示する
3. WHEN 認証済み会員がログアウトを要求する THEN MRSはセッションを終了してログイン画面にリダイレクトする
4. WHILE 会員がアクティブなセッションを持つ THEN MRSは後続のすべてのリクエストに対して認証状態を維持する
5. WHEN セッションがタイムアウト期間を超える THEN MRSは自動的にセッションを終了する

### 要件2: 会議室検索

**ユーザーストーリー:** 会員として、特定の日付で利用可能な会議室を検索し、会議に適した部屋を見つけたい。

#### 受入基準

1. WHEN 会員が会議室一覧にアクセスする THEN MRSはデフォルトで当日の予約可能な会議室をすべて表示する
2. WHEN 会員が異なる日付を選択する THEN MRSは選択された日付の予約可能な会議室をすべて表示する
3. WHEN 会員が前日に移動する THEN MRSは前日の会議室を表示するように更新する
4. WHEN 会員が翌日に移動する THEN MRSは翌日の会議室を表示するように更新する
5. THE MRSは会議室一覧を会議室識別子の昇順でソートする

### 要件3: 予約作成

**ユーザーストーリー:** 会員として、特定の時間帯に会議室を予約し、会議のためのスペースを確保したい。

#### 受入基準

1. WHEN 会員が有効なパラメータで予約を送信する THEN MRSは予約を作成して会員のユーザー識別子に関連付ける
2. WHEN 会員が既存の予約と重複する時間枠で予約を送信する THEN MRSは予約を拒否して競合メッセージを表示する
3. WHEN 会員が予約不可能な会議室と日付の組み合わせで予約を送信する THEN MRSは予約を拒否してエラーメッセージを表示する
4. WHEN 会員が開始時刻以前または同じ終了時刻で予約を送信する THEN MRSは予約を拒否して検証エラーを表示する
5. THE MRSは30分単位の予約時刻のみを受け付ける
6. WHEN 複数の会員が同じ時間枠を同時に予約しようとする THEN MRSは悲観的ロックを使用して1つの予約のみが成功することを保証する

### 要件4: 予約閲覧

**ユーザーストーリー:** 会員として、会議室の予約スケジュールを閲覧し、部屋がいつ利用可能かを確認したい。

#### 受入基準

1. WHEN 会員が会議室のスケジュールを閲覧する THEN MRSは選択された日付のその会議室のすべての予約を表示する
2. THE MRSは予約を開始時刻の昇順でソートする
3. WHEN 予約を表示する THEN MRSは開始時刻、終了時刻、予約を作成したユーザーの名前を表示する
4. WHEN 会員が自分の予約を閲覧する THEN MRSはその予約のキャンセルボタンを表示する
5. WHEN スタッフが任意の予約を閲覧する THEN MRSはその予約のキャンセルボタンを表示する

### 要件5: 予約キャンセル

**ユーザーストーリー:** 会員として、自分の予約をキャンセルし、予定が変更になったときに会議室を解放したい。

#### 受入基準

1. WHEN 会員が自分の予約のキャンセルを要求する THEN MRSは予約を削除して時間枠を利用可能にする
2. WHEN 会員が他の会員の予約のキャンセルを要求する THEN MRSは要求を拒否してアクセス拒否メッセージを表示する
3. WHEN スタッフが任意の予約のキャンセルを要求する THEN MRSは予約を削除して時間枠を利用可能にする
4. WHEN 予約がキャンセルされる THEN MRSは会議室の空き状況表示を即座に更新する

### 要件6: スタッフ管理

**ユーザーストーリー:** スタッフとして、すべての予約とシステムデータを管理し、システムを維持して競合を解決したい。

#### 受入基準

1. WHEN スタッフがシステムにアクセスする THEN MRSは会員のすべての機能に加えて管理者権限を付与する
2. THE MRSはスタッフが所有権の制限なく任意の会員の予約をキャンセルすることを許可する
3. THE MRSはスタッフがシステムに新しい会議室を登録することを許可する
4. THE MRSはスタッフが会議室を特定の日付に関連付けることで予約可能会議室を設定することを許可する
5. THE MRSはスタッフが登録と更新を含むユーザーアカウントを管理することを許可する

### 要件7: 問い合わせ管理

**ユーザーストーリー:** ゲストとして、サービスについての問い合わせを送信し、会員になる前に情報を得たい。

#### 受入基準

1. WHEN ゲストが問い合わせフォームにアクセスする THEN MRSは認証を要求せずにフォームを表示する
2. WHEN ゲストが問い合わせを送信する THEN MRSはスタッフのレビューのために問い合わせを保存する
3. WHEN スタッフが問い合わせ一覧にアクセスする THEN MRSは送信されたすべての問い合わせを表示する
4. THE MRSはスタッフが問い合わせを閲覧して応答することを許可する

### 要件8: セッションセキュリティ

**ユーザーストーリー:** システム管理者として、一般的なWeb脆弱性からシステムを保護し、ユーザーデータの安全性を維持したい。

#### 受入基準

1. WHEN MRSがフォームを生成する THEN MRSはクロスサイトリクエストフォージェリ攻撃を防ぐためにCSRFトークンを含める
2. WHEN MRSがパスワードを保存する THEN MRSは適切なソルトを使用したBCryptハッシュを使用する
3. WHEN 会員が保護されたリソースにアクセスする THEN MRSはセッションが有効で認証済みであることを検証する
4. THE MRSは本番環境でのすべての通信にHTTPSを強制する
5. WHEN MRSが無効なセッションを検出する THEN MRSはユーザーをログイン画面にリダイレクトする

### 要件9: データ検証

**ユーザーストーリー:** 開発者として、包括的な入力検証を実装し、システムがデータ整合性を維持してユーザーに明確なフィードバックを提供したい。

#### 受入基準

1. WHEN ユーザーがフォームを送信する THEN MRSはすべての必須フィールドが存在することを検証する
2. WHEN ユーザーが無効なデータを送信する THEN MRSはフィールド固有のエラーメッセージを表示する
3. THE MRSは予約時刻が30分単位であることを検証する
4. THE MRSは終了時刻が開始時刻より後であることを検証する
5. THE MRSは日付が有効な形式（YYYY-MM-DD）であることを検証する

### 要件10: 同時アクセス制御

**ユーザーストーリー:** システムアーキテクトとして、適切な同時実行制御を実装し、システムが同時ユーザーアクションを正しく処理したい。

#### 受入基準

1. WHEN 複数のユーザーが同じ時間枠を予約しようとする THEN MRSは予約可能会議室レコードに悲観的ロックを使用する
2. WHEN 予約作成のためにロックが取得される THEN MRSはトランザクションが完了するまでロックを保持する
3. WHEN 予約の競合が検出される THEN MRSはトランザクションをロールバックしてユーザーに通知する
4. THE MRSは次の式を使用して時間枠の重複を検出する: target.endTime > this.startTime AND this.endTime > target.startTime

### 要件11: システムパフォーマンス

**ユーザーストーリー:** ユーザーとして、システムが自分のアクションに素早く応答し、効率的にタスクを完了したい。

#### 受入基準

1. WHEN ユーザーがページを読み込む THEN MRSは通常負荷下で2秒以内に応答する
2. WHEN ユーザーが予約を送信する THEN MRSは3秒以内に操作を完了する
3. WHEN ユーザーがログインする THEN MRSは1秒以内に認証を完了する
4. THE MRSは少なくとも100人の同時認証ユーザーをサポートする
5. WHEN システムがピーク負荷を経験する THEN MRSは劣化なく安定した動作を維持する

### 要件12: 監査とログ記録

**ユーザーストーリー:** システム管理者として、包括的なログ記録を実装し、問題のトラブルシューティングとシステム使用状況の追跡を行いたい。

#### 受入基準

1. WHEN ユーザーが正常にログインする THEN MRSはユーザー識別子とタイムスタンプを含む認証イベントをログに記録する
2. WHEN ユーザーのログインが失敗する THEN MRSは試行されたユーザー識別子とタイムスタンプを含む失敗した試行をログに記録する
3. WHEN 予約が作成される THEN MRSはユーザー、会議室、時刻を含む予約詳細をログに記録する
4. WHEN 予約がキャンセルされる THEN MRSはユーザー識別子と予約詳細を含むキャンセルをログに記録する
5. WHEN エラーが発生する THEN MRSはスタックトレースとコンテキスト情報を含むエラーをログに記録する
