package main

import (
	"context"
	"fmt"
	"log"
	"time"

	"github.com/jmoiron/sqlx"
	"github.com/k2works/sales-management-db/pkg/database"

	_ "github.com/lib/pq"
)

func main() {
	// ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶š
	config := database.NewConfig()
	if config.DatabaseURL == "" {
		// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ­ãƒ¼ã‚«ãƒ«æ¥ç¶šè¨­å®š
		config.DatabaseURL = "host=localhost port=5432 user=postgres password=password dbname=sales_management sslmode=disable"
	}

	db, err := database.Connect(config)
	if err != nil {
		log.Fatalf("Failed to connect to database: %v", err)
	}
	defer database.Close(db)

	ctx := context.Background()

	fmt.Println("ğŸ—‘ï¸  æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã„ã¾ã™...")
	if err := truncateTables(ctx, db); err != nil {
		log.Fatalf("Failed to truncate tables: %v", err)
	}
	fmt.Println("âœ“ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ")

	fmt.Println("\nğŸ“Š ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥ã—ã¦ã„ã¾ã™...")

	// ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹
	tx, err := db.Beginx()
	if err != nil {
		log.Fatalf("Failed to begin transaction: %v", err)
	}
	defer tx.Rollback()

	// éƒ¨é–€ãƒã‚¹ã‚¿
	deptCount, err := seedDepartments(ctx, tx)
	if err != nil {
		log.Fatalf("Failed to seed departments: %v", err)
	}
	fmt.Printf("âœ“ éƒ¨é–€ãƒã‚¹ã‚¿: %dä»¶\n", deptCount)

	// ç¤¾å“¡ãƒã‚¹ã‚¿
	empCount, err := seedEmployees(ctx, tx)
	if err != nil {
		log.Fatalf("Failed to seed employees: %v", err)
	}
	fmt.Printf("âœ“ ç¤¾å“¡ãƒã‚¹ã‚¿: %dä»¶\n", empCount)

	// å–å¼•å…ˆã‚°ãƒ«ãƒ¼ãƒ—ãƒã‚¹ã‚¿
	grpCount, err := seedCompanyGroups(ctx, tx)
	if err != nil {
		log.Fatalf("Failed to seed company groups: %v", err)
	}
	fmt.Printf("âœ“ å–å¼•å…ˆã‚°ãƒ«ãƒ¼ãƒ—ãƒã‚¹ã‚¿: %dä»¶\n", grpCount)

	// å–å¼•å…ˆãƒã‚¹ã‚¿
	compCount, err := seedCompanies(ctx, tx)
	if err != nil {
		log.Fatalf("Failed to seed companies: %v", err)
	}
	fmt.Printf("âœ“ å–å¼•å…ˆãƒã‚¹ã‚¿: %dä»¶\n", compCount)

	// é¡§å®¢ãƒã‚¹ã‚¿
	custCount, err := seedCustomers(ctx, tx)
	if err != nil {
		log.Fatalf("Failed to seed customers: %v", err)
	}
	fmt.Printf("âœ“ é¡§å®¢ãƒã‚¹ã‚¿: %dä»¶\n", custCount)

	// ä»•å…¥å…ˆãƒã‚¹ã‚¿
	suppCount, err := seedSuppliers(ctx, tx)
	if err != nil {
		log.Fatalf("Failed to seed suppliers: %v", err)
	}
	fmt.Printf("âœ“ ä»•å…¥å…ˆãƒã‚¹ã‚¿: %dä»¶\n", suppCount)

	// å•†å“åˆ†é¡ãƒã‚¹ã‚¿
	catCount, err := seedProductCategories(ctx, tx)
	if err != nil {
		log.Fatalf("Failed to seed product categories: %v", err)
	}
	fmt.Printf("âœ“ å•†å“åˆ†é¡ãƒã‚¹ã‚¿: %dä»¶\n", catCount)

	// å•†å“ãƒã‚¹ã‚¿
	prodCount, err := seedProducts(ctx, tx)
	if err != nil {
		log.Fatalf("Failed to seed products: %v", err)
	}
	fmt.Printf("âœ“ å•†å“ãƒã‚¹ã‚¿: %dä»¶\n", prodCount)

	// å€‰åº«ãƒã‚¹ã‚¿
	whCount, err := seedWarehouses(ctx, tx)
	if err != nil {
		log.Fatalf("Failed to seed warehouses: %v", err)
	}
	fmt.Printf("âœ“ å€‰åº«ãƒã‚¹ã‚¿: %dä»¶\n", whCount)

	// ã‚³ãƒŸãƒƒãƒˆ
	if err := tx.Commit(); err != nil {
		log.Fatalf("Failed to commit transaction: %v", err)
	}

	fmt.Println("\nğŸ‰ ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®æŠ•å…¥ãŒå®Œäº†ã—ã¾ã—ãŸï¼")
}

// truncateTables æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹
func truncateTables(ctx context.Context, db *sqlx.DB) error {
	tables := []string{
		"å£²ä¸Šæ˜ç´°", "å£²ä¸Š",
		"åœ¨åº«", "å—æ³¨æ˜ç´°", "å—æ³¨",
		"é¡§å®¢åˆ¥è²©å£²å˜ä¾¡",
		"ä»£æ›¿å•†å“",
		"å•†å“ãƒã‚¹ã‚¿",
		"å•†å“åˆ†é¡ãƒã‚¹ã‚¿",
		"å€‰åº«ãƒã‚¹ã‚¿",
		"é¡§å®¢ãƒã‚¹ã‚¿",
		"ä»•å…¥å…ˆãƒã‚¹ã‚¿",
		"ä¸ä¿¡æ®‹é«˜",
		"è‡ªå‹•æ¡ç•ª",
		"å–å¼•å…ˆãƒã‚¹ã‚¿",
		"å–å¼•å…ˆã‚°ãƒ«ãƒ¼ãƒ—ãƒã‚¹ã‚¿",
		"ç¤¾å“¡ãƒã‚¹ã‚¿",
		"éƒ¨é–€ãƒã‚¹ã‚¿",
	}

	for _, table := range tables {
		query := fmt.Sprintf(`TRUNCATE TABLE "%s" CASCADE`, table)
		if _, err := db.ExecContext(ctx, query); err != nil {
			return fmt.Errorf("failed to truncate %s: %w", table, err)
		}
	}

	return nil
}

// seedDepartments éƒ¨é–€ãƒã‚¹ã‚¿ã®ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥
func seedDepartments(ctx context.Context, tx *sqlx.Tx) (int, error) {
	now := time.Now()
	startDate := time.Date(2020, 4, 1, 0, 0, 0, 0, time.UTC)
	endDate := time.Date(2100, 12, 31, 0, 0, 0, 0, time.UTC)

	query := `
		INSERT INTO "éƒ¨é–€ãƒã‚¹ã‚¿" (
			"éƒ¨é–€ã‚³ãƒ¼ãƒ‰", "é–‹å§‹æ—¥", "çµ‚äº†æ—¥", "éƒ¨é–€å", "çµ„ç¹”éšå±¤", "éƒ¨é–€ãƒ‘ã‚¹",
			"æœ€ä¸‹å±¤åŒºåˆ†", "ä¼ç¥¨å…¥åŠ›å¯å¦", "ä½œæˆæ—¥æ™‚", "ä½œæˆè€…å", "æ›´æ–°æ—¥æ™‚", "æ›´æ–°è€…å"
		) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12)
	`

	departments := []struct {
		ã‚³ãƒ¼ãƒ‰     string
		åç§°      string
		ãƒ‘ã‚¹      string
		éšå±¤ãƒ¬ãƒ™ãƒ«  int
		æœ€ä¸‹å±¤åŒºåˆ†  int
	}{
		// æœ¬ç¤¾ (Level 1)
		{"000000", "æœ¬ç¤¾", "/000000/", 1, 0},

		// é£Ÿè‚‰è£½é€ ãƒ»è²©å£²äº‹æ¥­ (Level 2)
		{"100000", "é£Ÿè‚‰è£½é€ ãƒ»è²©å£²äº‹æ¥­", "/000000/100000/", 2, 0},

		// Level 3
		{"110000", "é£Ÿè‚‰åŠ å·¥éƒ¨é–€", "/000000/100000/110000/", 3, 0},
		{"120000", "å°å£²è²©å£²éƒ¨é–€", "/000000/100000/120000/", 3, 0},
		{"130000", "æ–°è¦å–å¼•å…ˆé–‹æ‹“éƒ¨é–€", "/000000/100000/130000/", 3, 0},

		// Level 4 (æœ€ä¸‹å±¤)
		{"111000", "ç‰›è‚‰ãƒ»è±šè‚‰ãƒ»é¶è‚‰èª²", "/000000/100000/110000/111000/", 4, 1},
		{"112000", "é£Ÿè‚‰åŠ å·¥å“èª²", "/000000/100000/110000/112000/", 4, 1},
		{"121000", "ç›´å–¶å°å£²åº—èª²", "/000000/100000/120000/121000/", 4, 1},
		{"122000", "ç™¾è²¨åº—ãƒ»ã‚¹ãƒ¼ãƒ‘ãƒ¼å‘ã‘è²©å£²èª²", "/000000/100000/120000/122000/", 4, 1},
		{"131000", "ãƒ›ãƒ†ãƒ«ãƒ»æ—…é¤¨å‘ã‘èª²", "/000000/100000/130000/131000/", 4, 1},
		{"132000", "é£²é£Ÿåº—å‘ã‘èª²", "/000000/100000/130000/132000/", 4, 1},

		// é£Ÿè‚‰åŠ å·¥å“äº‹æ¥­ (Level 2)
		{"200000", "é£Ÿè‚‰åŠ å·¥å“äº‹æ¥­", "/000000/200000/", 2, 0},

		// Level 3
		{"210000", "è‡ªç¤¾ãƒ–ãƒ©ãƒ³ãƒ‰éƒ¨é–€", "/000000/200000/210000/", 3, 0},
		{"220000", "OEMéƒ¨é–€", "/000000/200000/220000/", 3, 0},

		// Level 4 (æœ€ä¸‹å±¤)
		{"211000", "è´ˆç­”ç”¨è£½å“è£½é€ èª²", "/000000/200000/210000/211000/", 4, 1},
		{"212000", "é“ã®é§…ãƒ»åœŸç”£ç‰©è£½å“è²©å£²èª²", "/000000/200000/210000/212000/", 4, 1},
		{"221000", "å®¢å…ˆè¦æœ›å¯¾å¿œèª²", "/000000/200000/220000/221000/", 4, 1},

		// ã‚³ãƒ³ã‚µãƒ«ãƒ†ã‚£ãƒ³ã‚°äº‹æ¥­ (Level 2)
		{"300000", "ã‚³ãƒ³ã‚µãƒ«ãƒ†ã‚£ãƒ³ã‚°äº‹æ¥­", "/000000/300000/", 2, 0},

		// Level 3
		{"310000", "é¡§å®¢å¯¾å¿œéƒ¨é–€", "/000000/300000/310000/", 3, 0},

		// Level 4 (æœ€ä¸‹å±¤)
		{"311000", "ãƒ¡ãƒ‹ãƒ¥ãƒ¼ææ¡ˆèª²", "/000000/300000/310000/311000/", 4, 1},
		{"312000", "åŠåŠ å·¥å•†å“æä¾›èª²", "/000000/300000/310000/312000/", 4, 1},
	}

	count := 0
	for _, dept := range departments {
		// ä¼ç¥¨å…¥åŠ›å¯å¦: æœ€ä¸‹å±¤éƒ¨é–€ã®ã¿å…¥åŠ›å¯èƒ½
		canEnterSlip := dept.æœ€ä¸‹å±¤åŒºåˆ†

		_, err := tx.ExecContext(ctx, query,
			dept.ã‚³ãƒ¼ãƒ‰, startDate, endDate, dept.åç§°, dept.éšå±¤ãƒ¬ãƒ™ãƒ«, dept.ãƒ‘ã‚¹,
			dept.æœ€ä¸‹å±¤åŒºåˆ†, canEnterSlip, now, "seed", now, "seed",
		)
		if err != nil {
			return 0, fmt.Errorf("failed to insert department %s: %w", dept.ã‚³ãƒ¼ãƒ‰, err)
		}
		count++
	}

	return count, nil
}

// strPtr æ–‡å­—åˆ—ã®ãƒã‚¤ãƒ³ã‚¿ã‚’è¿”ã™ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
func strPtr(s string) *string {
	return &s
}

// seedEmployees ç¤¾å“¡ãƒã‚¹ã‚¿ã®ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥
func seedEmployees(ctx context.Context, tx *sqlx.Tx) (int, error) {
	now := time.Now()
	startDate := time.Date(2020, 4, 1, 0, 0, 0, 0, time.UTC)

	query := `
		INSERT INTO "ç¤¾å“¡ãƒã‚¹ã‚¿" (
			"ç¤¾å“¡ã‚³ãƒ¼ãƒ‰", "ç¤¾å“¡å", "ç¤¾å“¡åã‚«ãƒŠ", "éƒ¨é–€ã‚³ãƒ¼ãƒ‰", "é–‹å§‹æ—¥",
			"ä½œæˆæ—¥æ™‚", "ä½œæˆè€…å", "æ›´æ–°æ—¥æ™‚", "æ›´æ–°è€…å"
		) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
	`

	employees := []struct {
		ã‚³ãƒ¼ãƒ‰ string
		åå‰  string
		ã‚«ãƒŠ  string
		éƒ¨é–€  string
	}{
		// æœ¬ç¤¾ - çµŒå–¶å±¤ï¼ˆ2åï¼‰
		{"EMP000001", "å±±ç”°å¤ªéƒ", "ãƒ¤ãƒãƒ€ã‚¿ãƒ­ã‚¦", "000000"},
		{"EMP000002", "ä½è—¤æ¬¡éƒ", "ã‚µãƒˆã‚¦ã‚¸ãƒ­ã‚¦", "000000"},

		// é£Ÿè‚‰è£½é€ ãƒ»è²©å£²äº‹æ¥­ï¼ˆ19åï¼‰
		{"EMP000003", "ç”°ä¸­ä¸‰éƒ", "ã‚¿ãƒŠã‚«ã‚µãƒ–ãƒ­ã‚¦", "111000"},
		{"EMP000004", "éˆ´æœ¨å››éƒ", "ã‚¹ã‚ºã‚­ã‚·ãƒ­ã‚¦", "111000"},
		{"EMP000005", "é«˜æ©‹äº”éƒ", "ã‚¿ã‚«ãƒã‚·ã‚´ãƒ­ã‚¦", "111000"},
		{"EMP000006", "ä¼Šè—¤å…­éƒ", "ã‚¤ãƒˆã‚¦ãƒ­ã‚¯ãƒ­ã‚¦", "112000"},
		{"EMP000007", "æ¸¡è¾ºä¸ƒéƒ", "ãƒ¯ã‚¿ãƒŠãƒ™ã‚·ãƒãƒ­ã‚¦", "112000"},

		{"EMP000008", "å±±æœ¬å…«éƒ", "ãƒ¤ãƒãƒ¢ãƒˆãƒãƒãƒ­ã‚¦", "121000"},
		{"EMP000009", "ä¸­æ‘ä¹éƒ", "ãƒŠã‚«ãƒ ãƒ©ã‚¯ãƒ­ã‚¦", "121000"},
		{"EMP000010", "å°æ—åéƒ", "ã‚³ãƒãƒ¤ã‚·ã‚¸ãƒ¥ã‚¦ãƒ­ã‚¦", "121000"},
		{"EMP000011", "åŠ è—¤ä¸€éƒ", "ã‚«ãƒˆã‚¦ã‚¤ãƒãƒ­ã‚¦", "122000"},
		{"EMP000012", "å‰ç”°äºŒéƒ", "ãƒ¨ã‚·ãƒ€ã‚¸ãƒ­ã‚¦", "122000"},
		{"EMP000013", "å±±ç”°èŠ±å­", "ãƒ¤ãƒãƒ€ãƒãƒŠã‚³", "122000"},

		{"EMP000014", "ä½ã€…æœ¨ä¸‰éƒ", "ã‚µã‚µã‚­ã‚µãƒ–ãƒ­ã‚¦", "131000"},
		{"EMP000015", "å±±å£å››éƒ", "ãƒ¤ãƒã‚°ãƒã‚·ãƒ­ã‚¦", "131000"},
		{"EMP000016", "æ¾æœ¬äº”éƒ", "ãƒãƒ„ãƒ¢ãƒˆã‚´ãƒ­ã‚¦", "131000"},
		{"EMP000017", "äº•ä¸Šå…­éƒ", "ã‚¤ãƒã‚¦ã‚¨ãƒ­ã‚¯ãƒ­ã‚¦", "132000"},
		{"EMP000018", "æœ¨æ‘ä¸ƒéƒ", "ã‚­ãƒ ãƒ©ã‚·ãƒãƒ­ã‚¦", "132000"},
		{"EMP000019", "æ—å…«éƒ", "ãƒãƒ¤ã‚·ãƒãƒãƒ­ã‚¦", "132000"},

		// é£Ÿè‚‰åŠ å·¥å“äº‹æ¥­ï¼ˆ9åï¼‰
		{"EMP000020", "æ–è—¤ä¹éƒ", "ã‚µã‚¤ãƒˆã‚¦ã‚¯ãƒ­ã‚¦", "211000"},
		{"EMP000021", "æ¸…æ°´åéƒ", "ã‚·ãƒŸã‚ºã‚¸ãƒ¥ã‚¦ãƒ­ã‚¦", "211000"},
		{"EMP000022", "å±±å´ä¸€éƒ", "ãƒ¤ãƒã‚¶ã‚­ã‚¤ãƒãƒ­ã‚¦", "211000"},
		{"EMP000023", "æ£®äºŒéƒ", "ãƒ¢ãƒªã‚¸ãƒ­ã‚¦", "212000"},
		{"EMP000024", "æ± ç”°ä¸‰éƒ", "ã‚¤ã‚±ãƒ€ã‚µãƒ–ãƒ­ã‚¦", "212000"},
		{"EMP000025", "æ©‹æœ¬å››éƒ", "ãƒã‚·ãƒ¢ãƒˆã‚·ãƒ­ã‚¦", "212000"},

		{"EMP000026", "çŸ³å·äº”éƒ", "ã‚¤ã‚·ã‚«ãƒ¯ã‚´ãƒ­ã‚¦", "221000"},
		{"EMP000027", "å‰ç”°å…­éƒ", "ãƒã‚¨ãƒ€ãƒ­ã‚¯ãƒ­ã‚¦", "221000"},
		{"EMP000028", "è—¤ç”°ä¸ƒéƒ", "ãƒ•ã‚¸ã‚¿ã‚·ãƒãƒ­ã‚¦", "221000"},

		// ã‚³ãƒ³ã‚µãƒ«ãƒ†ã‚£ãƒ³ã‚°äº‹æ¥­ï¼ˆ6åï¼‰
		{"EMP000029", "å²¡ç”°å…«éƒ", "ã‚ªã‚«ãƒ€ãƒãƒãƒ­ã‚¦", "311000"},
		{"EMP000030", "å¾Œè—¤ä¹éƒ", "ã‚´ãƒˆã‚¦ã‚¯ãƒ­ã‚¦", "311000"},
		{"EMP000031", "é•·è°·å·åéƒ", "ãƒã‚»ã‚¬ãƒ¯ã‚¸ãƒ¥ã‚¦ãƒ­ã‚¦", "311000"},
		{"EMP000032", "æ‘ä¸Šä¸€éƒ", "ãƒ ãƒ©ã‚«ãƒŸã‚¤ãƒãƒ­ã‚¦", "312000"},
		{"EMP000033", "è¿‘è—¤äºŒéƒ", "ã‚³ãƒ³ãƒ‰ã‚¦ã‚¸ãƒ­ã‚¦", "312000"},
		{"EMP000034", "çŸ³äº•ä¸‰éƒ", "ã‚¤ã‚·ã‚¤ã‚µãƒ–ãƒ­ã‚¦", "312000"},

		// ãƒ‘ãƒ¼ãƒˆç¤¾å“¡ï¼ˆè¿½åŠ ã§7åã€åˆè¨ˆ43åï¼‰
		{"EMP000035", "é è—¤ç¾å’²", "ã‚¨ãƒ³ãƒ‰ã‚¦ãƒŸã‚µã‚­", "121000"},
		{"EMP000036", "é’æœ¨ç”±ç¾", "ã‚¢ã‚ªã‚­ãƒ¦ãƒŸ", "121000"},
		{"EMP000037", "å‚æœ¬æµå­", "ã‚µã‚«ãƒ¢ãƒˆã‚±ã‚¤ã‚³", "122000"},
		{"EMP000038", "ç¦ç”°çœŸç†", "ãƒ•ã‚¯ãƒ€ãƒãƒª", "122000"},
		{"EMP000039", "è¥¿æ‘ã•ãã‚‰", "ãƒ‹ã‚·ãƒ ãƒ©ã‚µã‚¯ãƒ©", "211000"},
		{"EMP000040", "è—¤äº•ã‚ã‚†ã¿", "ãƒ•ã‚¸ã‚¤ã‚¢ãƒ¦ãƒŸ", "211000"},
		{"EMP000041", "å¤ªç”°ã¾ã‚†ã¿", "ã‚ªã‚ªã‚¿ãƒãƒ¦ãƒŸ", "212000"},
	}

	count := 0
	for _, emp := range employees {
		_, err := tx.ExecContext(ctx, query,
			emp.ã‚³ãƒ¼ãƒ‰, emp.åå‰, emp.ã‚«ãƒŠ, emp.éƒ¨é–€, startDate,
			now, "seed", now, "seed",
		)
		if err != nil {
			return 0, fmt.Errorf("failed to insert employee %s: %w", emp.ã‚³ãƒ¼ãƒ‰, err)
		}
		count++
	}

	return count, nil
}
