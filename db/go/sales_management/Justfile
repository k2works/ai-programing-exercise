# Sales Management Database - Justfile

# å¤‰æ•°å®šç¾©
binary_name := "sales-management-server"
build_dir := "bin"
database_url := "postgres://postgres:password@localhost:5432/sales_management?sslmode=disable"
test_database_url := "postgres://postgres:password@localhost:5433/sales_management_test?sslmode=disable"

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¬ã‚·ãƒ”ï¼ˆjust ã‚³ãƒãƒ³ãƒ‰ã§å®Ÿè¡Œï¼‰
default:
    @just --list

# ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
test:
    @echo "ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
    go test -v ./...

# ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’å®Ÿè¡Œ
test-coverage:
    @echo "ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’å®Ÿè¡Œä¸­..."
    go test -coverprofile=coverage.out ./...
    go tool cover -html=coverage.out -o coverage.html
    @echo "ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆãŒ coverage.html ã«ä½œæˆã•ã‚Œã¾ã—ãŸ"

# é™çš„è§£æã‚’å®Ÿè¡Œ
lint:
    @echo "é™çš„è§£æã‚’å®Ÿè¡Œä¸­..."
    export PATH=$PATH:$(go env GOPATH)/bin && golangci-lint run

# ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’å®Ÿè¡Œ
fmt:
    @echo "ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’å®Ÿè¡Œä¸­..."
    go fmt ./...
    export PATH=$PATH:$(go env GOPATH)/bin && goimports -w .

# go vet ã‚’å®Ÿè¡Œ
vet:
    @echo "go vet ã‚’å®Ÿè¡Œä¸­..."
    go vet ./...

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ“ãƒ«ãƒ‰
build:
    @echo "ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
    mkdir -p {{build_dir}}
    go build -o {{build_dir}}/{{binary_name}} ./cmd/server

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œ
run:
    @echo "ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œä¸­..."
    go run ./cmd/server

# ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
clean:
    @echo "ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­..."
    go clean
    rm -rf {{build_dir}}
    rm -f coverage.out coverage.html

# å“è³ªãƒã‚§ãƒƒã‚¯ï¼ˆãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã€vetã€lintã€ãƒ†ã‚¹ãƒˆï¼‰
check: fmt vet lint test

# è‡ªå‹•ä¿®æ­£ï¼ˆãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ + lint fixï¼‰
fix:
    @just fmt
    -export PATH=$PATH:$(go env GOPATH)/bin && golangci-lint run --fix

# ä¾å­˜é–¢ä¿‚ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
deps:
    @echo "ä¾å­˜é–¢ä¿‚ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­..."
    go mod download
    go mod tidy

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’èµ·å‹•
db-up:
    @echo "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’èµ·å‹•ä¸­..."
    docker compose up -d postgres postgres-test

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’åœæ­¢
db-down:
    @echo "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’åœæ­¢ä¸­..."
    docker compose down

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚’å‰Šé™¤
db-clean:
    @echo "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚’å‰Šé™¤ä¸­..."
    docker compose down -v

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’å†èµ·å‹•
db-restart:
    @just db-down
    @just db-up

# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œï¼ˆupï¼‰
migrate-up:
    @echo "ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œä¸­..."
    export PATH=$PATH:$(go env GOPATH)/bin && migrate -path migrations -database "{{database_url}}" up

# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆdownï¼‰
migrate-down:
    @echo "ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ä¸­..."
    export PATH=$PATH:$(go env GOPATH)/bin && migrate -path migrations -database "{{database_url}}" down

# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’ç¢ºèª
migrate-status:
    @echo "ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’ç¢ºèªä¸­..."
    export PATH=$PATH:$(go env GOPATH)/bin && migrate -path migrations -database "{{database_url}}" version

# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å¼·åˆ¶çš„ã«ç‰¹å®šãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«è¨­å®š
migrate-force version:
    @echo "ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ {{version}} ã«è¨­å®šä¸­..."
    export PATH=$PATH:$(go env GOPATH)/bin && migrate -path migrations -database "{{database_url}}" force {{version}}

# æ–°ã—ã„ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
migrate-create name:
    @echo "ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ« {{name}} ã‚’ä½œæˆä¸­..."
    export PATH=$PATH:$(go env GOPATH)/bin && migrate create -ext sql -dir migrations -seq {{name}}

# ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥
seed:
    @echo "ğŸŒ± ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥ã—ã¦ã„ã¾ã™..."
    go run cmd/seed/*.go

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥
db-reset: db-down db-up
    @echo "ğŸ”„ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ã„ã¾ã™..."
    @sleep 5
    @echo "ğŸ“Š ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥ã—ã¾ã™..."
    @just seed
    @echo "âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒªã‚»ãƒƒãƒˆãŒå®Œäº†ã—ã¾ã—ãŸ"

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
setup: deps db-up
    @echo "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®èµ·å‹•ã‚’å¾…æ©Ÿä¸­..."
    sleep 5
    @just migrate-up
    @echo "âœ… ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†ï¼"

# ãƒ†ã‚¹ãƒˆã®watchå®Ÿè¡Œ
watch-test:
    #!/usr/bin/env bash
    set -euo pipefail
    echo "ãƒ†ã‚¹ãƒˆã®watchå®Ÿè¡Œã‚’é–‹å§‹..."
    if command -v fswatch >/dev/null 2>&1; then
        fswatch -o . --exclude='.*\.(html|out|sum)$' --exclude='.git' | xargs -n1 -I{} just test
    else
        echo "fswatch ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"
        echo "Ubuntu/Debian: sudo apt-get install fswatch"
        echo "macOS: brew install fswatch"
        exit 1
    fi

# ã™ã¹ã¦ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’èµ·å‹•ï¼ˆAdminerå«ã‚€ï¼‰
services-up:
    @echo "ã™ã¹ã¦ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’èµ·å‹•ä¸­..."
    docker compose up -d

# ã™ã¹ã¦ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’åœæ­¢
services-down:
    @echo "ã™ã¹ã¦ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’åœæ­¢ä¸­..."
    docker compose down

# Docker ãƒ­ã‚°ã‚’è¡¨ç¤º
logs service="postgres":
    docker compose logs -f {{service}}

# Docker ã‚³ãƒ³ãƒ†ãƒŠã®çŠ¶æ…‹ã‚’ç¢ºèª
ps:
    docker compose ps

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ¥ç¶šï¼ˆpsqlï¼‰
db-shell:
    docker exec -it sales-management-postgres psql -U postgres -d sales_management

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ã‚’è¡¨ç¤º
db-tables:
    docker exec sales-management-postgres psql -U postgres -d sales_management -c "\dt"

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆ
db-test:
    @echo "=== PostgreSQL æ¥ç¶šãƒ†ã‚¹ãƒˆ ==="
    @echo ""
    @echo "1. ã‚³ãƒ³ãƒ†ãƒŠçŠ¶æ…‹ç¢ºèª:"
    @docker compose ps postgres
    @echo ""
    @echo "2. ãƒãƒ¼ãƒˆç¢ºèª:"
    @nc -zv localhost 5432 2>&1
    @echo ""
    @echo "3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¸€è¦§:"
    @docker exec sales-management-postgres psql -U postgres -l | grep sales_management
    @echo ""
    @echo "4. æ¥ç¶šãƒ†ã‚¹ãƒˆ:"
    @docker exec sales-management-postgres psql -U postgres -d sales_management -c "SELECT 'Connection OK' as status;"

# CI/CDç”¨ã®å“è³ªãƒã‚§ãƒƒã‚¯
ci: deps check

# ãƒªãƒªãƒ¼ã‚¹ãƒ“ãƒ«ãƒ‰
release:
    @echo "ãƒªãƒªãƒ¼ã‚¹ãƒ“ãƒ«ãƒ‰ã‚’å®Ÿè¡Œä¸­..."
    mkdir -p {{build_dir}}
    CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags="-w -s" -o {{build_dir}}/{{binary_name}}-linux-amd64 ./cmd/server
    CGO_ENABLED=0 GOOS=darwin GOARCH=amd64 go build -ldflags="-w -s" -o {{build_dir}}/{{binary_name}}-darwin-amd64 ./cmd/server
    CGO_ENABLED=0 GOOS=darwin GOARCH=arm64 go build -ldflags="-w -s" -o {{build_dir}}/{{binary_name}}-darwin-arm64 ./cmd/server
    @echo "âœ… ãƒªãƒªãƒ¼ã‚¹ãƒ“ãƒ«ãƒ‰å®Œäº†"

# é–‹ç™ºç’°å¢ƒã®å®Œå…¨ãƒªã‚»ãƒƒãƒˆ
reset: db-clean clean
    @echo "é–‹ç™ºç’°å¢ƒã‚’ãƒªã‚»ãƒƒãƒˆä¸­..."
    @just setup
    @echo "âœ… ãƒªã‚»ãƒƒãƒˆå®Œäº†"
