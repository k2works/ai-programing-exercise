name: Book Registration Client
description: DDD書籍管理システムの書籍登録クライアント
host: EXCEL
api_set: {}
script:
  content: |
    $("#register-book").on("click", () => tryCatch(registerBook));
    $("#get-book").on("click", () => tryCatch(getBook));
    $("#clear-sheet").on("click", () => tryCatch(clearSheet));
    $("#bulk-register").on("click", () => tryCatch(bulkRegister));
    $("#bulk-get").on("click", () => tryCatch(bulkGet));

    async function registerBook() {
      const isbn = $("#isbn").val() as string;
      const title = $("#title").val() as string;
      const priceAmount = parseFloat($("#price").val() as string);

      if (!isbn || !title || !priceAmount) {
        showError("すべての項目を入力してください");
        return;
      }

      try {
        showError("APIサーバーに接続中...");
        
        const response = await fetch("http://localhost:3000/book", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            isbn: isbn,
            title: title,
            priceAmount: priceAmount,
          }),
        });

        const data = await response.json();

        if (response.ok) {
          showSuccess(`書籍を登録しました: ${title}`);
          clearForm();
        } else {
          showError(`エラー: ${data.message}`);
        }
      } catch (error) {
        showError(`通信エラー: ${error.message}\nURL: http://localhost:3000/book\nサーバーが起動しているか確認してください`);
      }
    }

    async function getBook() {
      const isbn = $("#isbn-get").val() as string;

      if (!isbn) {
        showError("ISBNを入力してください");
        return;
      }

      try {
        const response = await fetch(`http://localhost:3000/book/${isbn}`, {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
          },
        });

        if (response.ok) {
          const data = await response.json();
          await writeToSheet(data);
          showSuccess("書籍情報をシートに出力しました");
        } else {
          const errorData = await response.json();
          showError(`エラー: ${errorData.message}`);
        }
      } catch (error) {
        showError(`通信エラー: ${error.message}`);
      }
    }

    async function writeToSheet(book: any) {
      await Excel.run(async (context) => {
        const sheet = context.workbook.worksheets.getActiveWorksheet();
        
        // ヘッダー行を探すか作成
        const usedRange = sheet.getUsedRange();
        usedRange.load("address,rowCount");
        await context.sync();

        let headerRow = 1;
        let dataStartRow = 2;

        // ヘッダーが存在するかチェック
        const headerRange = sheet.getRange("A1:F1");
        headerRange.load("values");
        await context.sync();

        const headers = headerRange.values[0];
        const expectedHeaders = ["ISBN", "タイトル", "価格", "在庫ID", "在庫数", "ステータス"];
        
        // ヘッダーが存在しない場合は作成
        if (headers[0] !== "ISBN") {
          const headerRow = sheet.getRange("A1:F1");
          headerRow.values = [expectedHeaders];
          headerRow.format.font.bold = true;
          headerRow.format.fill.color = "#4472C4";
          headerRow.format.font.color = "white";
        }

        // データ行を探す（既存のISBNがあれば更新、なければ追加）
        let targetRow = dataStartRow;
        let foundExisting = false;

        if (usedRange.rowCount > 1) {
          const dataRange = sheet.getRange(`A${dataStartRow}:A${usedRange.rowCount}`);
          dataRange.load("values");
          await context.sync();

          for (let i = 0; i < dataRange.values.length; i++) {
            if (dataRange.values[i][0] === book.bookId) {
              targetRow = dataStartRow + i;
              foundExisting = true;
              break;
            }
          }

          if (!foundExisting) {
            targetRow = usedRange.rowCount + 1;
          }
        }

        // データを書き込む
        const dataRange = sheet.getRange(`A${targetRow}:F${targetRow}`);
        dataRange.values = [[
          book.bookId,
          book.title,
          book.price,
          book.stockId,
          book.quantityAvailable,
          book.status
        ]];

        // 列幅を自動調整
        sheet.getRange("A:F").format.autofitColumns();

        await context.sync();
      });
    }

    async function clearSheet() {
      await Excel.run(async (context) => {
        const sheet = context.workbook.worksheets.getActiveWorksheet();
        const usedRange = sheet.getUsedRange();
        usedRange.clear();
        await context.sync();
        showSuccess("シートをクリアしました");
      });
    }

    async function bulkRegister() {
      await Excel.run(async (context) => {
        const sheet = context.workbook.worksheets.getActiveWorksheet();
        const usedRange = sheet.getUsedRange();
        usedRange.load("values,rowCount");
        await context.sync();

        if (usedRange.rowCount < 2) {
          showError("登録するデータがありません。ヘッダー行とデータ行が必要です。");
          return;
        }

        const values = usedRange.values;
        const headers = values[0];
        
        // ヘッダーの検証
        const isbnIndex = headers.indexOf("ISBN");
        const titleIndex = headers.indexOf("タイトル");
        const priceIndex = headers.indexOf("価格");

        if (isbnIndex === -1 || titleIndex === -1 || priceIndex === -1) {
          showError("必須カラムが不足しています: ISBN、タイトル、価格");
          return;
        }

        let successCount = 0;
        let errorCount = 0;
        const errors: string[] = [];

        showError(`一括登録を開始します... (${usedRange.rowCount - 1}件)`);

        for (let i = 1; i < usedRange.rowCount; i++) {
          const row = values[i];
          const isbn = row[isbnIndex];
          const title = row[titleIndex];
          const priceAmount = parseFloat(row[priceIndex]);

          if (!isbn || !title || !priceAmount) {
            errorCount++;
            errors.push(`行${i + 1}: データ不足`);
            continue;
          }

          try {
            const response = await fetch("http://localhost:3000/book", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                isbn: isbn,
                title: title,
                priceAmount: priceAmount,
              }),
            });

            if (response.ok) {
              successCount++;
            } else {
              const data = await response.json();
              errorCount++;
              errors.push(`行${i + 1} (${isbn}): ${data.message}`);
            }
          } catch (error) {
            errorCount++;
            errors.push(`行${i + 1} (${isbn}): ${error.message}`);
          }
        }

        const result = `一括登録完了\n成功: ${successCount}件\nエラー: ${errorCount}件`;
        if (errors.length > 0) {
          showError(result + "\n\nエラー詳細:\n" + errors.slice(0, 5).join("\n"));
        } else {
          showSuccess(result);
        }
      });
    }

    async function bulkGet() {
      await Excel.run(async (context) => {
        const sheet = context.workbook.worksheets.getActiveWorksheet();
        const usedRange = sheet.getUsedRange();
        usedRange.load("values,rowCount");
        await context.sync();

        if (usedRange.rowCount < 2) {
          showError("取得するISBNがありません。");
          return;
        }

        const values = usedRange.values;
        const headers = values[0];
        const isbnIndex = headers.indexOf("ISBN");

        if (isbnIndex === -1) {
          showError("ISBNカラムが見つかりません");
          return;
        }

        let successCount = 0;
        let errorCount = 0;

        showError(`一括取得を開始します... (${usedRange.rowCount - 1}件)`);

        for (let i = 1; i < usedRange.rowCount; i++) {
          const isbn = values[i][isbnIndex];

          if (!isbn) {
            errorCount++;
            continue;
          }

          try {
            const response = await fetch(`http://localhost:3000/book/${isbn}`, {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
              },
            });

            if (response.ok) {
              const data = await response.json();
              await updateSheetRow(context, sheet, i + 1, data);
              successCount++;
            } else {
              errorCount++;
            }
          } catch (error) {
            errorCount++;
          }
        }

        await context.sync();
        showSuccess(`一括取得完了\n成功: ${successCount}件\nエラー: ${errorCount}件`);
      });
    }

    async function updateSheetRow(context: Excel.RequestContext, sheet: Excel.Worksheet, rowNumber: number, book: any) {
      const dataRange = sheet.getRange(`A${rowNumber}:F${rowNumber}`);
      dataRange.values = [[
        book.bookId,
        book.title,
        book.price,
        book.stockId,
        book.quantityAvailable,
        book.status
      ]];
    }

    function showSuccess(message: string) {
      $("#result").text(message).css("color", "green");
    }

    function showError(message: string) {
      $("#result").text(message).css("color", "red");
    }

    function clearForm() {
      $("#isbn").val("");
      $("#title").val("");
      $("#price").val("");
    }

    async function tryCatch(callback) {
      try {
        await callback();
      } catch (error) {
        showError(error.message);
      }
    }
  language: typescript
template:
  content: |
    <section class="ms-font-m">
      <h2 class="ms-font-xl">書籍管理システム</h2>
      
      <div class="ms-Grid" style="margin-top: 20px;">
        <div class="ms-Grid-row">
          <div class="ms-Grid-col ms-sm12">
            <h3>書籍を登録</h3>
            <div class="ms-TextField">
              <label class="ms-Label">ISBN</label>
              <input id="isbn" type="text" class="ms-TextField-field" placeholder="9784167158057" />
            </div>
            <div class="ms-TextField" style="margin-top: 10px;">
              <label class="ms-Label">タイトル</label>
              <input id="title" type="text" class="ms-TextField-field" placeholder="吾輩は猫である" />
            </div>
            <div class="ms-TextField" style="margin-top: 10px;">
              <label class="ms-Label">価格</label>
              <input id="price" type="number" class="ms-TextField-field" placeholder="770" />
            </div>
            <button id="register-book" class="ms-Button" style="margin-top: 15px;">
              <span class="ms-Button-label">登録</span>
            </button>
          </div>
        </div>

        <div class="ms-Grid-row" style="margin-top: 30px;">
          <div class="ms-Grid-col ms-sm12">
            <h3>書籍を取得してシートに出力</h3>
            <div class="ms-TextField">
              <label class="ms-Label">ISBN</label>
              <input id="isbn-get" type="text" class="ms-TextField-field" placeholder="9784167158057" />
            </div>
            <button id="get-book" class="ms-Button" style="margin-top: 15px;">
              <span class="ms-Button-label">取得してシートに出力</span>
            </button>
            <button id="clear-sheet" class="ms-Button ms-Button--secondary" style="margin-top: 15px; margin-left: 10px;">
              <span class="ms-Button-label">シートをクリア</span>
            </button>
          </div>
        </div>

        <div class="ms-Grid-row" style="margin-top: 30px;">
          <div class="ms-Grid-col ms-sm12">
            <h3>一括操作</h3>
            <p class="ms-font-s">シートのデータを使って一括処理を実行します</p>
            <button id="bulk-register" class="ms-Button ms-Button--success" style="margin-top: 15px;">
              <span class="ms-Button-label">シートから一括登録</span>
            </button>
            <button id="bulk-get" class="ms-Button ms-Button--success" style="margin-top: 15px; margin-left: 10px;">
              <span class="ms-Button-label">シートのISBNから一括取得</span>
            </button>
          </div>
        </div>

        <div class="ms-Grid-row" style="margin-top: 30px;">
          <div class="ms-Grid-col ms-sm12">
            <h3>結果</h3>
            <div id="result" style="padding: 10px; border: 1px solid #ccc; min-height: 50px; white-space: pre-line;">
              ここに結果が表示されます
            </div>
          </div>
        </div>
      </div>
    </section>
  language: html
style:
  content: |
    section.ms-font-m {
      padding: 20px;
    }

    .ms-TextField {
      margin-bottom: 10px;
    }

    .ms-TextField-field {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 2px;
    }

    .ms-Button {
      background-color: #0078d4;
      color: white;
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      border-radius: 2px;
    }

    .ms-Button:hover {
      background-color: #106ebe;
    }

    .ms-Button--secondary {
      background-color: #6c757d;
    }

    .ms-Button--secondary:hover {
      background-color: #5a6268;
    }

    .ms-Button--success {
      background-color: #28a745;
    }

    .ms-Button--success:hover {
      background-color: #218838;
    }

    .ms-Label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
    }

    #result {
      font-family: 'Courier New', monospace;
      font-size: 14px;
    }
  language: css
libraries: |
  https://appsforoffice.microsoft.com/lib/1/hosted/office.js
  @types/office-js

  office-ui-fabric-js@1.4.0/dist/css/fabric.min.css
  office-ui-fabric-js@1.4.0/dist/css/fabric.components.min.css

  core-js@2.4.1/client/core.min.js
  @types/core-js

  jquery@3.1.1
  @types/jquery@3.3.1
