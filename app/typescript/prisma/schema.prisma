generator client {
  provider = "prisma-client-js"
}

generator zod {
  provider                         = "zod-prisma-types"
  output                           = "../src/generated/zod"
  createRelationValuesTypes        = true
  createPartialTypes               = true
  createOptionalDefaultValuesTypes = true
  useDecimalJs                     = true
  prismaJsonNullability            = true
}

generator comments {
  provider = "prisma-db-comments-generator"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// 勘定科目マスタ（財務会計システムの基本となる勘定科目情報）
model Account {
  /// 勘定科目コード（主キー）
  accountCode            String             @id @map("勘定科目コード") @db.VarChar(10)
  /// 勘定科目名
  accountName            String             @map("勘定科目名") @db.VarChar(40)
  /// 勘定科目カナ
  accountKana            String?            @map("勘定科目カナ") @db.VarChar(40)
  /// 勘定科目種別
  accountType            String             @map("勘定科目種別") @db.VarChar(10)
  /// 合計科目
  sumAccount             Boolean            @default(false) @map("合計科目")
  /// BSPL区分
  bsplDistinction        String?            @map("BSPL区分") @db.Char(1)
  /// 取引要素区分
  transactionDistinction String?            @map("取引要素区分") @db.Char(1)
  /// 費用区分
  costDistinction        String?            @map("費用区分") @db.Char(1)
  /// 表示順序
  displayOrder           Int?               @map("表示順序")
  /// 集計対象
  aggregationTarget      Boolean            @default(true) @map("集計対象")
  /// 課税取引コード
  taxCode                String?            @map("課税取引コード") @db.VarChar(2)
  /// 作成日時
  createdAt              DateTime           @default(now()) @map("作成日時")
  /// 更新日時
  updatedAt              DateTime           @updatedAt @map("更新日時")

  // リレーション
  taxTransaction      TaxTransaction?      @relation(fields: [taxCode], references: [taxCode])
  structure           AccountStructure?
  journalEntryDetails JournalEntryDetail[]

  @@index([bsplDistinction], map: "idx_bspl_distinction")
  @@index([transactionDistinction], map: "idx_transaction_distinction")
  @@index([accountType], map: "idx_account_type")
  @@index([displayOrder], map: "idx_display_order")
  @@index([taxCode], map: "idx_tax_code")
  @@map("勘定科目マスタ")
}

/// 課税取引マスタ（消費税計算のための課税区分情報）
model TaxTransaction {
  /// 課税取引コード（主キー）
  taxCode     String    @id @map("課税取引コード") @db.VarChar(2)
  /// 課税取引名
  taxName     String    @map("課税取引名") @db.VarChar(40)
  /// 税率（%）
  taxRate     Float     @map("税率") @db.Real
  /// 課税区分（課税、非課税、免税、不課税）
  taxType     String    @map("課税区分") @db.VarChar(10)
  /// 説明
  description String?   @map("説明") @db.VarChar(200)
  /// 適用開始日
  validFrom   DateTime? @map("適用開始日")
  /// 適用終了日
  validTo     DateTime? @map("適用終了日")
  /// 作成日時
  createdAt   DateTime  @default(now()) @map("作成日時")
  /// 更新日時
  updatedAt   DateTime  @updatedAt @map("更新日時")

  // リレーション
  accounts Account[]

  @@index([taxType], map: "idx_tax_type")
  @@index([validFrom, validTo], map: "idx_valid_period")
  @@map("課税取引マスタ")
}

/// 勘定科目構成マスタ（チルダ連結方式による階層構造管理）
model AccountStructure {
  /// 勘定科目コード（主キー、外部キー）
  accountCode String   @id @map("勘定科目コード") @db.VarChar(10)
  /// 勘定科目パス（チルダ連結、例：11^11000^11190^11110）
  accountPath String   @map("勘定科目パス") @db.VarChar(200)
  /// 作成日時
  createdAt   DateTime @default(now()) @map("作成日時")
  /// 更新日時
  updatedAt   DateTime @updatedAt @map("更新日時")

  // リレーション
  account Account @relation(fields: [accountCode], references: [accountCode], onDelete: Cascade)

  @@index([accountPath], map: "idx_account_path")
  @@map("勘定科目構成マスタ")
}

/// 仕訳エントリ（複式簿記の仕訳データ）
model JournalEntry {
  /// 伝票番号（主キー）
  entryNo     String   @id @map("伝票番号") @db.VarChar(10)
  /// 仕訳日
  entryDate   DateTime @map("仕訳日") @db.Date
  /// 摘要
  description String   @map("摘要") @db.VarChar(100)
  /// 合計金額
  totalAmount Decimal  @map("合計金額") @db.Decimal(15, 2)
  /// 参照番号
  reference   String?  @map("参照番号") @db.VarChar(20)
  /// 作成者
  createdBy   String   @map("作成者") @db.VarChar(20)
  /// 作成日時
  createdAt   DateTime @default(now()) @map("作成日時")
  /// 更新者
  updatedBy   String?  @map("更新者") @db.VarChar(20)
  /// 更新日時
  updatedAt   DateTime @updatedAt @map("更新日時")

  // リレーション
  details JournalEntryDetail[]

  @@map("仕訳エントリ")
}

/// 仕訳明細（仕訳エントリの明細行データ）
model JournalEntryDetail {
  /// 伝票番号（複合主キー1）
  entryNo      String  @map("伝票番号") @db.VarChar(10)
  /// 行番号（複合主キー2）
  lineNo       Int     @map("行番号")
  /// 勘定科目コード
  accountCode  String  @map("勘定科目コード") @db.VarChar(10)
  /// 借方金額
  debitAmount  Decimal @default(0) @map("借方金額") @db.Decimal(15, 2)
  /// 貸方金額
  creditAmount Decimal @default(0) @map("貸方金額") @db.Decimal(15, 2)
  /// 摘要
  description  String  @map("摘要") @db.VarChar(100)
  /// 消費税額
  taxAmount    Decimal @default(0) @map("消費税額") @db.Decimal(15, 2)
  /// 消費税率
  taxRate      Decimal? @map("消費税率") @db.Decimal(5, 2)

  // リレーション
  journalEntry JournalEntry @relation(fields: [entryNo], references: [entryNo], onDelete: Cascade)
  account      Account      @relation(fields: [accountCode], references: [accountCode])

  @@id([entryNo, lineNo])
  @@map("仕訳明細")
}
