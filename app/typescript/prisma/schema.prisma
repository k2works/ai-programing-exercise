generator client {
  provider = "prisma-client-js"
}

generator zod {
  provider                         = "zod-prisma-types"
  output                           = "../src/generated/zod"
  createRelationValuesTypes        = true
  createPartialTypes               = true
  createOptionalDefaultValuesTypes = true
  useDecimalJs                     = true
  prismaJsonNullability            = true
}

generator comments {
  provider = "prisma-db-comments-generator"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// 勘定科目マスタ（財務会計システムの基本となる勘定科目情報）
model Account {
  /// 勘定科目コード（主キー）
  accountCode            String             @id @map("勘定科目コード") @db.VarChar(10)
  /// 勘定科目名
  accountName            String             @map("勘定科目名") @db.VarChar(40)
  /// 勘定科目カナ
  accountKana            String?            @map("勘定科目カナ") @db.VarChar(40)
  /// 勘定科目種別
  accountType            String             @map("勘定科目種別") @db.VarChar(10)
  /// 合計科目
  sumAccount             Boolean            @default(false) @map("合計科目")
  /// BSPL区分
  bsplDistinction        String?            @map("BSPL区分") @db.Char(1)
  /// 取引要素区分
  transactionDistinction String?            @map("取引要素区分") @db.Char(1)
  /// 費用区分
  costDistinction        String?            @map("費用区分") @db.Char(1)
  /// 表示順序
  displayOrder           Int?               @map("表示順序")
  /// 集計対象
  aggregationTarget      Boolean            @default(true) @map("集計対象")
  /// 課税取引コード
  taxCode                String?            @map("課税取引コード") @db.VarChar(2)
  /// 作成日時
  createdAt              DateTime           @default(now()) @map("作成日時")
  /// 更新日時
  updatedAt              DateTime           @updatedAt @map("更新日時")

  // リレーション
  taxTransaction       TaxTransaction?       @relation(fields: [taxCode], references: [taxCode])
  structure            AccountStructure?
  journalEntryDetails  JournalEntryDetail[]
  journalDetailItems   JournalDetailItem[]

  @@index([bsplDistinction], map: "idx_bspl_distinction")
  @@index([transactionDistinction], map: "idx_transaction_distinction")
  @@index([accountType], map: "idx_account_type")
  @@index([displayOrder], map: "idx_display_order")
  @@index([taxCode], map: "idx_tax_code")
  @@map("勘定科目マスタ")
}

/// 課税取引マスタ（消費税計算のための課税区分情報）
model TaxTransaction {
  /// 課税取引コード（主キー）
  taxCode     String    @id @map("課税取引コード") @db.VarChar(2)
  /// 課税取引名
  taxName     String    @map("課税取引名") @db.VarChar(40)
  /// 税率（%）
  taxRate     Float     @map("税率") @db.Real
  /// 課税区分（課税、非課税、免税、不課税）
  taxType     String    @map("課税区分") @db.VarChar(10)
  /// 説明
  description String?   @map("説明") @db.VarChar(200)
  /// 適用開始日
  validFrom   DateTime? @map("適用開始日")
  /// 適用終了日
  validTo     DateTime? @map("適用終了日")
  /// 作成日時
  createdAt   DateTime  @default(now()) @map("作成日時")
  /// 更新日時
  updatedAt   DateTime  @updatedAt @map("更新日時")

  // リレーション
  accounts Account[]

  @@index([taxType], map: "idx_tax_type")
  @@index([validFrom, validTo], map: "idx_valid_period")
  @@map("課税取引マスタ")
}

/// 勘定科目構成マスタ（チルダ連結方式による階層構造管理）
model AccountStructure {
  /// 勘定科目コード（主キー、外部キー）
  accountCode String   @id @map("勘定科目コード") @db.VarChar(10)
  /// 勘定科目パス（チルダ連結、例：11^11000^11190^11110）
  accountPath String   @map("勘定科目パス") @db.VarChar(200)
  /// 作成日時
  createdAt   DateTime @default(now()) @map("作成日時")
  /// 更新日時
  updatedAt   DateTime @updatedAt @map("更新日時")

  // リレーション
  account Account @relation(fields: [accountCode], references: [accountCode], onDelete: Cascade)

  @@index([accountPath], map: "idx_account_path")
  @@map("勘定科目構成マスタ")
}

/// 仕訳エントリ（複式簿記の仕訳データ）
model JournalEntry {
  /// 伝票番号（主キー）
  entryNo     String   @id @map("伝票番号") @db.VarChar(10)
  /// 仕訳日
  entryDate   DateTime @map("仕訳日") @db.Date
  /// 摘要
  description String   @map("摘要") @db.VarChar(100)
  /// 合計金額
  totalAmount Decimal  @map("合計金額") @db.Decimal(15, 2)
  /// 参照番号
  reference   String?  @map("参照番号") @db.VarChar(20)
  /// 作成者
  createdBy   String   @map("作成者") @db.VarChar(20)
  /// 作成日時
  createdAt   DateTime @default(now()) @map("作成日時")
  /// 更新者
  updatedBy   String?  @map("更新者") @db.VarChar(20)
  /// 更新日時
  updatedAt   DateTime @updatedAt @map("更新日時")

  // リレーション
  details JournalEntryDetail[]

  @@map("仕訳エントリ")
}

/// 仕訳明細（仕訳エントリの明細行データ）
model JournalEntryDetail {
  /// 伝票番号（複合主キー1）
  entryNo      String  @map("伝票番号") @db.VarChar(10)
  /// 行番号（複合主キー2）
  lineNo       Int     @map("行番号")
  /// 勘定科目コード
  accountCode  String  @map("勘定科目コード") @db.VarChar(10)
  /// 借方金額
  debitAmount  Decimal @default(0) @map("借方金額") @db.Decimal(15, 2)
  /// 貸方金額
  creditAmount Decimal @default(0) @map("貸方金額") @db.Decimal(15, 2)
  /// 摘要
  description  String  @map("摘要") @db.VarChar(100)
  /// 消費税額
  taxAmount    Decimal @default(0) @map("消費税額") @db.Decimal(15, 2)
  /// 消費税率
  taxRate      Decimal? @map("消費税率") @db.Decimal(5, 2)

  // リレーション
  journalEntry JournalEntry @relation(fields: [entryNo], references: [entryNo], onDelete: Cascade)
  account      Account      @relation(fields: [accountCode], references: [accountCode])

  @@id([entryNo, lineNo])
  @@map("仕訳明細")
}

/// 仕訳（ヘッダー：3層構造）
model Journal {
  /// 仕訳伝票番号（主キー）
  voucherNo         String   @id @map("仕訳伝票番号") @db.VarChar(10)
  /// 起票日
  journalDate       DateTime @map("起票日") @db.Date
  /// 入力日
  inputDate         DateTime @map("入力日") @db.Date
  /// 決算仕訳フラグ
  settlementFlag    Int      @default(0) @map("決算仕訳フラグ") @db.SmallInt
  /// 単振フラグ
  singleFlag        Int      @default(1) @map("単振フラグ") @db.SmallInt
  /// 仕訳伝票区分
  voucherType       Int      @map("仕訳伝票区分") @db.SmallInt
  /// 定期計上フラグ
  recurringFlag     Int      @default(0) @map("定期計上フラグ") @db.SmallInt
  /// 社員コード
  employeeCode      String?  @map("社員コード") @db.VarChar(10)
  /// 部門コード
  departmentCode    String?  @map("部門コード") @db.VarChar(5)
  /// 赤伝フラグ
  redSlipFlag       Int      @default(0) @map("赤伝フラグ") @db.SmallInt
  /// 赤黒伝票番号
  redBlackVoucherNo Int?     @map("赤黒伝票番号")
  /// 作成日時
  createdAt         DateTime @default(now()) @map("作成日時")
  /// 更新日時
  updatedAt         DateTime @updatedAt @map("更新日時")

  // リレーション
  details JournalDetail[]

  @@index([journalDate], map: "idx_journal_date")
  @@index([departmentCode], map: "idx_journal_department")
  @@index([redSlipFlag], map: "idx_red_slip")
  @@map("仕訳")
}

/// 仕訳明細（行摘要：3層構造）
model JournalDetail {
  /// 仕訳伝票番号（複合主キー1）
  voucherNo   String   @map("仕訳伝票番号") @db.VarChar(10)
  /// 仕訳行番号（複合主キー2）
  lineNo      Int      @map("仕訳行番号") @db.SmallInt
  /// 行摘要
  lineSummary String   @map("行摘要") @db.VarChar(1000)
  /// 作成日時
  createdAt   DateTime @default(now()) @map("作成日時")
  /// 更新日時
  updatedAt   DateTime @updatedAt @map("更新日時")

  // リレーション
  journal Journal             @relation(fields: [voucherNo], references: [voucherNo], onDelete: Cascade)
  items   JournalDetailItem[]

  @@id([voucherNo, lineNo])
  @@map("仕訳明細_3層")
}

/// 仕訳貸借明細（借方・貸方の詳細：3層構造）
model JournalDetailItem {
  /// 仕訳伝票番号（複合主キー1）
  voucherNo         String   @map("仕訳伝票番号") @db.VarChar(10)
  /// 仕訳行番号（複合主キー2）
  lineNo            Int      @map("仕訳行番号") @db.SmallInt
  /// 仕訳行貸借区分（複合主キー3）
  debitCredit       String   @map("仕訳行貸借区分") @db.VarChar(1)
  /// 通貨コード
  currencyCode      String   @map("通貨コード") @db.VarChar(3)
  /// 為替レート
  exchangeRate      Decimal  @map("為替レート") @db.Decimal(8, 2)
  /// 部門コード
  departmentCode    String?  @map("部門コード") @db.VarChar(3)
  /// プロジェクトコード
  projectCode       String?  @map("プロジェクトコード") @db.VarChar(10)
  /// 勘定科目コード
  accountCode       String   @map("勘定科目コード") @db.VarChar(10)
  /// 補助科目コード
  subAccountCode    String?  @map("補助科目コード") @db.VarChar(10)
  /// 仕訳金額
  amount            Decimal  @map("仕訳金額") @db.Decimal(14, 2)
  /// 基軸換算仕訳金額
  baseAmount        Decimal  @map("基軸換算仕訳金額") @db.Decimal(14, 2)
  /// 消費税区分
  taxType           String?  @map("消費税区分") @db.VarChar(2)
  /// 消費税率
  taxRate           Int?     @map("消費税率") @db.SmallInt
  /// 消費税計算区分
  taxCalcType       String?  @map("消費税計算区分") @db.VarChar(2)
  /// 期日
  dueDate           DateTime? @map("期日") @db.Date
  /// 資金繰フラグ
  cashFlowFlag      Int      @default(0) @map("資金繰フラグ") @db.SmallInt
  /// セグメントコード
  segmentCode       String?  @map("セグメントコード") @db.VarChar(10)
  /// 相手勘定科目コード
  offsetAccountCode String?  @map("相手勘定科目コード") @db.VarChar(10)
  /// 相手補助科目コード
  offsetSubAccount  String?  @map("相手補助科目コード") @db.VarChar(10)
  /// 付箋コード
  noteCode          String?  @map("付箋コード") @db.VarChar(1)
  /// 付箋内容
  noteContent       String?  @map("付箋内容") @db.VarChar(60)
  /// 作成日時
  createdAt         DateTime @default(now()) @map("作成日時")
  /// 更新日時
  updatedAt         DateTime @updatedAt @map("更新日時")

  // リレーション
  detail  JournalDetail @relation(fields: [voucherNo, lineNo], references: [voucherNo, lineNo], onDelete: Cascade)
  account Account       @relation(fields: [accountCode], references: [accountCode])

  @@id([voucherNo, lineNo, debitCredit])
  @@index([accountCode], map: "idx_detail_item_account")
  @@index([departmentCode], map: "idx_detail_item_department")
  @@index([projectCode], map: "idx_detail_item_project")
  @@map("仕訳貸借明細")
}
