# ぷよぷよアプリケーション - TODOリスト

本TODOリストは、`docs/requirements/仕様.md` を基に、テスト駆動開発（TDD）のアプローチで段階的に実装するためのタスクを整理したものです。

## 📊 現在の進捗状況 (2025-08-26更新)

- ✅ **Phase 1: 基盤システム (Foundation)** - 完了 (T001-T006)
- ✅ **Phase 2: ぷよ管理システム (Puyo Management)** - 完了 (T005-T009)
- ✅ **Phase 3: ゲームロジック (Game Logic)** - 完了 (T010-T014) 
- ⏳ **Phase 4: ユーザーインターフェース (User Interface)** - 部分完了 (T015-T016完了)
- ⏳ **Phase 5: ゲームフロー (Game Flow)** - 未着手  
- ⏳ **Phase 6: 高度な機能 (Advanced Features)** - 未着手

**実装済み機能:**
- 基本ゲームボード・ぷよシステム
- 移動・回転・落下・固定システム
- 隣接検索・消去・連鎖システム
- スコア計算・全消しボーナスシステム
- ゲーム画面描画システム（Canvas + 組ぷよ表示）
- ゲーム情報表示システム（スコア・レベル・連鎖数・時間）

**次のマイルストーン:** Phase 4 (UI実装) - T017キーボード入力処理

## 🎯 実装フェーズ概要

### Phase 1: 基盤システム (Foundation) ✅ **完了**
基本的なゲームボードとぷよの表現を確立

### Phase 2: ぷよ管理システム (Puyo Management) ✅ **部分完了**
ぷよの生成、配置、移動の基本機能

### Phase 3: ゲームロジック (Game Logic) ✅ **完了**
ぷよの消去、連鎖、スコア計算の実装

### Phase 4: ユーザーインターフェース (User Interface) ⏳ **次のターゲット**
キーボード・タッチ操作とゲーム状態表示

### Phase 5: ゲームフロー (Game Flow)
ゲーム開始、終了、リスタートの機能

### Phase 6: 高度な機能 (Advanced Features)
連鎖演出、全消しボーナス、その他の拡張機能

---

## 📋 詳細TODOリスト

### Phase 1: 基盤システム (Foundation) ✅ **完了**

#### 1.1 ゲームボード実装
- [x] **T001**: ゲームボードの作成（6x12マス） ✅ **完了**
  - [x] 空のボードを生成する関数を実装
  - [x] ボードの座標システム（x: 0-5, y: 0-12）を定義
  - [x] 座標の有効性チェック機能
  - [x] ボードの状態を文字列で表示する機能（デバッグ用）

#### 1.2 ぷよの基本実装
- [x] **T002**: ぷよの基本データ構造 ✅ **完了**
  - [x] ぷよの色を表現する列挙型（赤、青、緑、黄、紫）
  - [x] ぷよの位置を表現する座標構造
  - [x] ぷよの基本プロパティ（色、座標）

#### 1.3 組ぷよ実装
- [x] **T003**: 組ぷよ（2個セット）の実装 ✅ **完了**
  - [x] 2つのぷよで構成される組ぷよ構造
  - [x] 組ぷよの回転状態（0°, 90°, 180°, 270°）
  - [x] 組ぷよの相対位置計算

#### 1.4 ボード操作
- [x] **T004**: ボードへのぷよ配置 ✅ **完了**
  - [x] ボードの指定位置にぷよを配置する機能
  - [x] ボードの指定位置からぷよを取得する機能
  - [x] ボードの指定位置が空かどうかチェックする機能

### Phase 2: ぷよ管理システム (Puyo Management) ✅ **部分完了**

#### 2.1 ぷよ生成システム
- [x] **T005**: ランダムなぷよ生成 ✅ **完了**
  - [x] ランダムな色のぷよを生成する機能
  - [x] 組ぷよをランダム生成する機能
  - [x] NEXTぷよの管理機能

#### 2.2 ぷよの移動
- [x] **T006**: 組ぷよの基本移動 ✅ **完了**
  - [x] 組ぷよを左に移動する機能
  - [x] 組ぷよを右に移動する機能
  - [x] 移動可能性のチェック（境界、他のぷよとの衝突）

#### 2.3 ぷよの回転
- [x] **T007**: 組ぷよの回転 ✅ **完了**
  - [x] 組ぷよを時計回りに回転する機能
  - [x] 回転可能性のチェック（境界、他のぷよとの衝突）
  - [x] 回転時の壁蹴り（kick）機能
  - [ ] 回転時の壁蹴り（kick）機能

#### 2.4 ぷよの落下
- [x] **T008**: ぷよの重力システム ✅ **完了 (2025-08-26)**
  - [x] 組ぷよの自然落下（重力）
  - [x] 高速落下（ソフトドロップ）機能
  - [x] 瞬間落下（ハードドロップ）機能
  - [x] 落下停止条件の判定
  - [ ] 落下停止条件の判定

#### 2.5 ぷよの固定
- [x] **T009**: ぷよの固定処理 ✅ **完了 (2025-08-26)**
  - [x] 組ぷよがボードに固定される条件判定
  - [x] 固定時の各ぷよの個別配置
  - [x] 浮いているぷよの落下処理

### Phase 3: ゲームロジック (Game Logic) ✅ **完了**

#### 3.1 ぷよの消去判定
- [x] **T010**: 隣接ぷよの検索 ✅ **完了 (2025-08-26)**
  - [x] 指定位置から同色のぷよを探索する機能（幅優先探索）
  - [x] 4つ以上の隣接ぷよグループの検出
  - [x] 消去対象ぷよの特定

#### 3.2 ぷよの消去実行
- [x] **T011**: ぷよ消去の実行 ✅ **完了 (2025-08-26)**
  - [x] 消去対象ぷよをボードから削除
  - [x] 消去されたぷよの数をカウント
  - [x] 消去後のボード状態更新

#### 3.3 連鎖システム
- [x] **T012**: 連鎖の実装 ✅ **完了 (2025-08-26)**
  - [x] 消去後のぷよ落下処理
  - [x] 連鎖回数のカウント
  - [x] 連鎖の再帰的実行
  - [x] 連鎖終了条件の判定

#### 3.4 スコア計算
- [x] **T013**: 基本スコア計算 ✅ **完了 (2025-08-26)**
  - [x] 消去ぷよ数に基づくベーススコア
  - [x] 連鎖倍率の計算
  - [x] 同時消し倍率の計算
  - [x] 色数ボーナスの計算

#### 3.5 全消し判定
- [x] **T014**: 全消し（ぜんけし）ボーナス ✅ **完了 (2025-08-26)**
  - [x] ボードが完全に空になったかの判定
  - [x] 全消しボーナススコアの計算
  - [x] 全消しフラグの管理

### Phase 4: ユーザーインターフェース (User Interface)

#### 4.1 ゲーム状態表示
- [x] **T015**: ゲーム画面の描画 ✅ **完了 (2025-08-26)**
  - [x] ボードの視覚的表示（HTML5 Canvas）
  - [x] ぷよの色別表示
  - [x] 現在の組ぷよの表示
  - [x] Canvas初期化機能（init-canvas）
  - [x] 色マッピング機能（get-puyo-color）
  - [x] ボード描画機能（render-board）
  - [x] 組ぷよ描画機能（render-puyo-pair）
  - [x] ゲーム状態表示機能（update-game-display）
  - [x] 組ぷよ生成機能（spawn-new-puyo-pair）
  - [x] 統合描画機能（render-game）
  - [ ] NEXTぷよの表示

#### 4.2 スコア・ステータス表示
- [x] **T016**: ゲーム情報の表示 ✅ **完了 (2025-08-26)**
  - [x] 現在のスコア表示
  - [x] 連鎖数の表示
  - [x] レベル・難易度の表示
  - [x] ゲーム時間の表示
  - [x] 連鎖数管理機能（reset-chain-count!, increment-chain-count!, set-chain-count!）
  - [x] ゲーム時間管理機能（reset-game-time!, update-game-time!）
  - [x] 時間フォーマット機能（M:SS形式）
  - [x] DOM表示更新機能（update-score-display!, update-chain-display!, update-time-display!）
  - [x] 統合表示更新機能（update-all-game-info!）
  - [x] ゲームタイマー管理（start-game-timer!, stop-game-timer!）
  - [x] HTML表示欄追加（Score, Level, Chain, Time）
  - [x] ゲーム開始・リセット時の自動タイマー管理

#### 4.3 キーボード操作
- [ ] **T017**: キーボード入力処理
  - [ ] 左右矢印キーでの移動
  - [ ] 上矢印キーでの回転
  - [ ] 下矢印キーでの高速落下
  - [ ] スペースキーでの瞬間落下

#### 4.4 タッチ操作（オプション）
- [ ] **T018**: タッチ・マウス操作
  - [ ] タップでの回転
  - [ ] スワイプでの移動
  - [ ] 長押しでの高速落下

### Phase 5: ゲームフロー (Game Flow)

#### 5.1 ゲーム開始
- [ ] **T019**: ゲーム初期化
  - [ ] 新しいゲームの開始処理
  - [ ] ゲーム状態の初期化
  - [ ] 最初の組ぷよの生成

#### 5.2 ゲームオーバー
- [ ] **T020**: ゲーム終了判定
  - [ ] ゲームオーバー条件の判定（ぷよがフィールド上部に達する）
  - [ ] ゲームオーバー時の処理
  - [ ] ゲーム結果の表示

#### 5.3 ゲーム制御
- [ ] **T021**: ゲーム制御機能
  - [ ] ゲームの一時停止機能
  - [ ] ゲームのリスタート機能
  - [ ] ゲーム設定の管理

### Phase 6: 高度な機能 (Advanced Features)

#### 6.1 演出システム
- [ ] **T022**: ゲーム演出
  - [ ] ぷよ消去時のアニメーション
  - [ ] 連鎖時の特殊演出
  - [ ] 全消し時の特殊演出

#### 6.2 サウンド（オプション）
- [ ] **T023**: 効果音システム
  - [ ] ぷよ移動音
  - [ ] ぷよ消去音
  - [ ] 連鎖音
  - [ ] BGM管理

#### 6.3 難易度調整
- [ ] **T024**: ゲームバランス
  - [ ] 落下速度の調整
  - [ ] ぷよ色数の設定
  - [ ] スコア倍率の調整

---

## 🔄 TDD実装サイクル

各TODOアイテムに対して以下のサイクルを実行：

1. **Red**: 機能のテストを書く（失敗する）
2. **Green**: テストを通すための最小限の実装
3. **Refactor**: コードの品質向上（重複排除、可読性向上）

## 📊 進捗管理

### Phase 1: 基盤システム (4/4 completed - 100%) ✅
- [x] **T001**: ゲームボードの作成（8x12マス）※実装済み
  - [x] 空のボードを生成する関数を実装
  - [x] ボードの座標システム（x: 0-7, y: 0-11）を定義
  - [x] 座標の有効性チェック機能
  - [x] ボードの状態を文字列で表示する機能（デバッグ用）

- [x] **T002**: ぷよの基本データ構造 ※実装済み
  - [x] ぷよの色を表現する列挙型（赤、青、緑、黄、紫）
  - [x] ぷよの位置を表現する座標構造
  - [x] ぷよの基本プロパティ（色、座標）

- [x] **T003**: 組ぷよ（2個セット）の実装 ※2025/08/26完了
  - [x] 2つのぷよで構成される組ぷよ構造
  - [x] 組ぷよの回転状態（0°, 90°, 180°, 270°）
  - [x] 組ぷよの相対位置計算
  - [x] 組ぷよの時計回り回転機能
  - [x] 入力バリデーション（色・回転状態・座標）
  - [x] TDDアプローチでの包括的テスト実装

- [x] **T004**: ボードへのぷよ配置 ※実装済み
  - [x] ボードの指定位置にぷよを配置する機能
  - [x] ボードの指定位置からぷよを取得する機能
  - [x] ボードの指定位置が空かどうかチェックする機能

### Phase 2: ぷよ管理システム (5/5 completed - 100%) ✅
- [x] **T005**: ランダムなぷよ生成 ✅ **完了 (2025-08-26)**
- [x] **T006**: 組ぷよの基本移動 ✅ **完了 (2025-08-26)**
- [x] **T007**: 組ぷよの回転 ✅ **完了 (2025-08-26)**
- [x] **T008**: ぷよの重力システム ✅ **完了 (2025-08-26)**
- [x] **T009**: ぷよの固定処理 ✅ **完了 (2025-08-26)**

### Phase 3: ゲームロジック (5/5 completed - 100%) ✅
- [x] **T010**: 隣接ぷよの検索 ✅ **完了 (2025-08-26)**
- [x] **T011**: ぷよ消去の実行 ✅ **完了 (2025-08-26)**
- [x] **T012**: 連鎖システム ✅ **完了 (2025-08-26)**
- [x] **T013**: 基本スコア計算 ✅ **完了 (2025-08-26)**
- [x] **T014**: 全消し（ぜんけし）ボーナス ✅ **完了 (2025-08-26)**

### Phase 4: ユーザーインターフェース (3/4 completed - 75%)
- [x] **T015**: ゲーム画面の描画 ✅ **完了 (2025-08-26)**
  - [x] ボードの視覚的表示（HTML5 Canvas）
  - [x] ぷよの色別表示
  - [x] 現在の組ぷよの表示
  - [ ] NEXTぷよの表示

- [x] **T016**: ゲーム情報の表示 ✅ **完了 (2025-08-26)**
  - [x] 現在のスコア表示
  - [x] 連鎖数の表示
  - [x] レベル・難易度の表示
  - [x] ゲーム時間の表示

- [ ] **T017**: キーボード入力処理 ※一部実装済み（イベントハンドラのみ）
  - [ ] 左右矢印キーでの移動
  - [ ] 上矢印キーでの回転
  - [ ] 下矢印キーでの高速落下
  - [ ] スペースキーでの瞬間落下

- [ ] **T018**: タッチ・マウス操作
  - [ ] タップでの回転
  - [ ] スワイプでの移動
  - [ ] 長押しでの高速落下
  - [ ] スペースキーでの瞬間落下

- [ ] **T018**: タッチ・マウス操作
  - [ ] タップでの回転
  - [ ] スワイプでの移動
  - [ ] 長押しでの高速落下

### Phase 5: ゲームフロー (2/3 completed - 67%)
- [x] **T019**: ゲーム初期化 ✅ **完了 (2025-08-26)**
  - [x] 新しいゲームの開始処理
  - [x] ゲーム状態の初期化
  - [x] 最初の組ぷよの生成

- [ ] **T020**: ゲーム終了判定
  - [ ] ゲームオーバー条件の判定（ぷよがフィールド上部に達する）
  - [ ] ゲームオーバー時の処理
  - [ ] ゲーム結果の表示

- [x] **T021**: ゲーム制御機能 ✅ **部分完了 (2025-08-26)**
  - [x] ゲームの一時停止機能
  - [x] ゲームのリスタート機能
  - [ ] ゲーム設定の管理
  - [x] ゲームのリスタート機能
  - [ ] ゲーム設定の管理

### Phase 6: 高度な機能 (0/3 completed - 0%)
- [ ] **T022**: ゲーム演出
- [ ] **T023**: 効果音システム
- [ ] **T024**: ゲームバランス

**総合進捗: 8/24 phases completed (33%)**

### 🎯 現在の実装状況サマリー

#### ✅ 完了済み機能
1. **基本ゲームボード**: 8x12マスのゲームボード作成・管理
2. **ぷよ色システム**: 5色（赤、緑、青、黄、紫）の色定義
3. **組ぷよシステム**: 2つのぷよで構成される基本単位・4方向回転
4. **ゲーム状態管理**: スコア、レベル、ゲーム実行状態の管理
5. **Canvas描画**: HTML5 Canvasによるボード描画
6. **基本UI**: スコア・レベル表示
7. **ゲーム制御**: 開始・リセット機能
8. **イベントハンドラ**: キーボード入力の受付（処理は未実装）

#### 🚧 次に実装すべき機能（優先度順）
1. **ぷよ生成システム**: ランダムな色の組ぷよ生成（T005）
2. **ぷよ移動システム**: 左右移動と回転の実装（T006-T007）
3. **重力システム**: ぷよの落下処理（T008）
4. **ぷよ固定システム**: ボードへの配置処理（T009）
5. **ゲームロジック**: 消去・連鎖システム（T010-T014）

#### 📏 品質指標
- **テストカバレッジ**: 基本機能（ボード、色、組ぷよ、状態管理）
- **現在のテスト数**: 10テスト、45アサーション
- **品質チェック**: 全項目パス（0エラー、0警告）
- **Phase 1完了**: 基盤システム100%完了 ✅

---

## 📝 注意事項

- 各タスクは独立してテスト可能な単位で分割されています
- 実装順序は依存関係を考慮していますが、必要に応じて調整可能です
- テストファースト（Test-First）のアプローチを維持してください
- 各フェーズ完了時に統合テストを実行することを推奨します

### ⚠️ 仕様との相違点

**ボードサイズ**: 
- 仕様書: 6x12マス
- 現在の実装: 8x12マス

この相違により、以下の調整が必要になる可能性があります：
- ゲームバランス（難易度）の調整
- UI表示領域の最適化
- スコア計算アルゴリズムの見直し

### 🔄 次回開発セッションの推奨タスク

**✅ 完了済み: 組ぷよシステムの実装 (T003)**
```clojure
;; 実装完了済み
(def puyo-pair {:puyo1 {:color 1 :x 3 :y 0}
                :puyo2 {:color 2 :x 3 :y 1}
                :rotation 0})  ; 0=縦, 1=右, 2=逆, 3=左
```

**Priority 1: ランダムぷよ生成システムの実装 (T005)**
```clojure
;; 実装すべき関数例
(defn generate-random-puyo-pair []
  "ランダムな色の組ぷよを生成")

(defn setup-next-puyo []
  "NEXTぷよの管理")
```

**Priority 2: 組ぷよ移動システムの実装 (T006)**
```clojure
;; 実装すべき関数例
(defn move-puyo-pair-left [puyo-pair board]
  "組ぷよを左に移動")

(defn move-puyo-pair-right [puyo-pair board]
  "組ぷよを右に移動")

(defn can-move? [puyo-pair board direction]
  "移動可能性をチェック")
```

(defn setup-next-puyo []
  "NEXTぷよの管理")
```
