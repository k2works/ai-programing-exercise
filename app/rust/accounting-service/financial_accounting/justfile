# Justfile for Rust Accounting System

# デフォルトレシピ（just コマンドのみで実行）
default:
    @just --list

# テスト実行
test:
    cargo test

# テスト実行（詳細表示）
test-verbose:
    cargo test -- --nocapture

# ビルド
build:
    cargo build

# リリースビルド
build-release:
    cargo build --release

# フォーマットチェック
fmt-check:
    cargo fmt -- --check

# フォーマット適用
fmt:
    cargo fmt

# リンターチェック
lint:
    cargo clippy -- -D warnings

# 開発用データベース起動
db-up:
    docker compose up -d

# データベース停止
db-down:
    docker compose down

# データベースリセット（データ削除）
db-reset:
    docker compose down -v
    docker compose up -d

# マイグレーション実行
migrate:
    sqlx migrate run

# マイグレーション作成
migrate-create name:
    sqlx migrate add {{name}}

# API サーバー起動
api-run:
    cargo run --bin accounting-system

# API サーバー起動（リリースビルド）
api-run-release:
    cargo run --release --bin accounting-system

# API サーバー起動（ウォッチモード - 開発用）
api-dev:
    cargo watch -x 'run --bin accounting-system'

# 開発サーバー起動（ウォッチモード）
dev:
    cargo watch -x run

# テストウォッチモード
test-watch:
    cargo watch -x test

# クリーンビルド
clean:
    cargo clean

# すべてのチェックを実行（CI用）
ci: fmt-check lint test

# API ヘルスチェック（サーバーが起動している必要があります）
api-health:
    curl -s http://localhost:3000/api/v1/accounts | jq '.'

# Swagger UI をブラウザで開く
swagger-ui:
    @echo "=== Swagger UI を開きます ==="
    @echo "http://localhost:3000/swagger-ui"
    open http://localhost:3000/swagger-ui

# OpenAPI JSON を取得
swagger-json:
    @echo "=== OpenAPI JSON ==="
    curl -s http://localhost:3000/api-docs/openapi.json | jq '.'

# Swagger UI をブラウザで開く（OpenAPI仕様も表示）
swagger-open:
    @echo "=== Swagger UI と OpenAPI JSON ==="
    @echo "Swagger UI: http://localhost:3000/swagger-ui"
    @echo "OpenAPI JSON: http://localhost:3000/api-docs/openapi.json"
    open http://localhost:3000/swagger-ui

# API テスト用サンプルリクエスト
api-test-get-accounts:
    @echo "=== 全勘定科目取得 ==="
    curl -s http://localhost:3000/api/v1/accounts | jq '.'

api-test-get-account code:
    @echo "=== 勘定科目取得: {{code}} ==="
    curl -s http://localhost:3000/api/v1/accounts/{{code}} | jq '.'

api-test-create-account:
    @echo "=== 勘定科目作成 ==="
    curl -s -X POST http://localhost:3000/api/v1/accounts \
        -H "Content-Type: application/json" \
        -d '{"account_code":"9999","account_name":"テスト科目","account_type":"資産","is_summary_account":false}' | jq '.'

api-test-balance-sheet date:
    @echo "=== 貸借対照表取得: {{date}} ==="
    curl -s "http://localhost:3000/api/v1/financial/balance-sheet?as_of_date={{date}}" | jq '.'

api-test-income-statement start end:
    @echo "=== 損益計算書取得: {{start}} ~ {{end}} ==="
    curl -s "http://localhost:3000/api/v1/financial/income-statement?start_date={{start}}&end_date={{end}}" | jq '.'

api-test-ratios date start end:
    @echo "=== 財務指標取得: {{date}}, {{start}} ~ {{end}} ==="
    curl -s "http://localhost:3000/api/v1/financial/ratios?as_of_date={{date}}&period_start={{start}}&period_end={{end}}" | jq '.'

# 開発環境セットアップ
setup:
    docker compose up -d
    sqlx migrate run
    cargo test
    @echo "\n=== セットアップ完了 ==="
    @echo "API サーバーを起動するには: just api-run"
    @echo "開発モードで起動するには: just api-dev"
